<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!-- 
      The Peers
 parameters will be replaced with the 
      document title extracted from the <h1> element or
      file name, if there is no <h1> heading
    -->
    <title>Peers
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-1.11.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="http://getbootstrap.com/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="content/style.css" />
    <script src="content/tips.js" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">Bitcoin F#</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="Protocol.html">Protocol</a></li>
            <li><a href="DB.html">Persistence</a></li>
            <li><a href="P2P.html">Peer to Peer</a></li>
            <li><a href="Peer.html">Peer</a></li>
            <li><a href="Tracker.html">Tracker</a></li>
            <li><a href="Script.html">Script Interpreter</a></li>
            <li><a href="Mempool.html">Mempool</a></li>
            <li><a href="Checks.html">Validation</a></li>
            <li><a href="Blockchain.html">Blockchain</a></li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Misc <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="Main.html">Main</a></li>
                    <li><a href="Test.html">Tests</a></li>
                    <li><a href="Building.html">Building and Running</a></li>
                    <li><a href="BIP37.html">SPV</a></li>
                    <li><a href="Changelog.html">Changelog</a></li>
                </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row" style="margin-top:70px">
        <div class="span1"></div>
        <div class="span10" id="main">
          <h1>Peers</h1>

<p>This is the first of the two modules that form the Peer-to-peer layer. It is also the lowest, i.e. the closest to
the network layer and the farthest from the business logic.</p>

<p>A peer is our side of the communication channel with a remote node of the Bitcoin network. It is responsible for
encoding/decoding and the transmission of messages with a single remote node. A peer is constructed 
with a unique id and bound to single node. If the other side is not responsive or disconnects, the peer gets evicted.
The tracker Tom fires Peter. Even if Peter comes back with a response later, Tom will disregard it.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">module</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Peer</span></pre>
</td>
</tr>
</table>

<h2>The state machines</h2>

<p>A Peer goes through several steps as indicated by <code>PeerState</code>. <code>Closed</code> is its initial and final state.
<code>Connected</code> means that it has connected to a remote node but hasn't gone through the handshake (where nodes exchange
version information). A Peer is <code>Ready</code> when it can accept a command from Tom because it is not working already. Peers only
work on one thing at a time and when they work they switch to <code>Busy</code>.</p>

<p><img src="uml/peer-state.png" alt="peer-states" /></p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs16', 33)" onmouseover="showTip(event, 'fs16', 33)" class="i">PeerState</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs17', 34)" onmouseover="showTip(event, 'fs17', 34)" class="i">Connected</span> | <span onmouseout="hideTip(event, 'fs18', 35)" onmouseover="showTip(event, 'fs18', 35)" class="i">Ready</span> | <span onmouseout="hideTip(event, 'fs19', 36)" onmouseover="showTip(event, 'fs19', 36)" class="i">Busy</span> | <span onmouseout="hideTip(event, 'fs20', 37)" onmouseover="showTip(event, 'fs20', 37)" class="i">Closed</span></pre>
</td>
</tr>
</table>

<p>Tom keeps track of the peers as well but its view is somewhat different. It doesn't care about the details of the inner workings
of Peter, whether he has shaken hands or not. For Tom, a peer is <code>Allocated</code> when he has hired him, <code>Ready</code> or <code>Busy</code> for the same
reasons as the Peter and <code>Free</code> when Tom has decided that he no longer needs Peter's services.</p>

<p><img src="uml/tracker-peer-state.png" alt="tracker-peer-states" /></p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs21', 38)" onmouseover="showTip(event, 'fs21', 38)" class="i">TrackerPeerState</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs22', 39)" onmouseover="showTip(event, 'fs22', 39)" class="i">Allocated</span> | <span onmouseout="hideTip(event, 'fs23', 40)" onmouseover="showTip(event, 'fs23', 40)" class="i">Ready</span> | <span onmouseout="hideTip(event, 'fs24', 41)" onmouseover="showTip(event, 'fs24', 41)" class="i">Busy</span> |  <span onmouseout="hideTip(event, 'fs25', 42)" onmouseover="showTip(event, 'fs25', 42)" class="i">Free</span></pre>
</td>
</tr>
</table>

<p>Busy/Ready states control the allocation of resources. Tom does not know exactly how much work is done by Peter. Neither does he know
the nature of the work. It is controlled by whoever requested the work, usually Bob. Tom's responsibility is limited to finding a peer for Bob after that,
Peter and Bob talk directly.</p>

<p>The Busy and Ready state are present in both Tom and Peter. Because they are different actors, there is no guarantee
that these states will be synchronized. If Tom marks Peter as busy and then sends a message to Peter, Peter is not busy yet since he hasn't 
received the message yet. It is normal but when Peter finishes his work and becomes available again, the reverse must happen. He must set his
state to ready before he notifies Tom otherwise Tom could send him work before he becomes ready. Essentially, because work comes from Tom, it is ok
if Tom thinks that Peter is busy when he is not, but it is bad if Tom thinks Peter is available when he is not.</p>

<p>The interactions between Bob, Tom and Peter can be described by the following sequence diagram.</p>

<p><img src="uml/tracker-peer-seq.png" alt="tracker-peer-seq" /></p>

<p>A holder for the incoming and outgoing channels from and to the remote node</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs33', 51)" onmouseover="showTip(event, 'fs33', 51)" class="i">IPeerSend</span> <span class="o">=</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs34', 52)" onmouseover="showTip(event, 'fs34', 52)" class="i">Receive</span><span class="o">:</span> <span class="i">BitcoinMessage</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs35', 53)" onmouseover="showTip(event, 'fs35', 53)" class="i">unit</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs36', 54)" onmouseover="showTip(event, 'fs36', 54)" class="i">Send</span><span class="o">:</span> <span class="i">BitcoinMessage</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs35', 55)" onmouseover="showTip(event, 'fs35', 55)" class="i">unit</span>

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs37', 56)" onmouseover="showTip(event, 'fs37', 56)" class="i">PeerQueues</span> (<span onmouseout="hideTip(event, 'fs38', 57)" onmouseover="showTip(event, 'fs38', 57)" class="i">stream</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs39', 58)" onmouseover="showTip(event, 'fs39', 58)" class="i">NetworkStream</span>, <span onmouseout="hideTip(event, 'fs40', 59)" onmouseover="showTip(event, 'fs40', 59)" class="i">target</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 60)" onmouseover="showTip(event, 'fs41', 60)" class="i">IPEndPoint</span>) <span class="o">=</span> 
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs42', 61)" onmouseover="showTip(event, 'fs42', 61)" class="i">fromPeer</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs43', 62)" onmouseover="showTip(event, 'fs43', 62)" class="i">Event</span><span class="o">&lt;</span><span class="i">BitcoinMessage</span><span class="o">&gt;</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs44', 63)" onmouseover="showTip(event, 'fs44', 63)" class="i">toPeer</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs43', 64)" onmouseover="showTip(event, 'fs43', 64)" class="i">Event</span><span class="o">&lt;</span><span class="i">BitcoinMessage</span><span class="o">&gt;</span>()
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs45', 65)" onmouseover="showTip(event, 'fs45', 65)" class="i">disposed</span> <span class="o">=</span> <span class="k">false</span>

    <span class="k">interface</span> <span onmouseout="hideTip(event, 'fs46', 66)" onmouseover="showTip(event, 'fs46', 66)" class="i">IDisposable</span> <span class="k">with</span>
        <span class="k">override</span> <span onmouseout="hideTip(event, 'fs47', 67)" onmouseover="showTip(event, 'fs47', 67)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 68)" onmouseover="showTip(event, 'fs48', 68)" class="i">Dispose</span>() <span class="o">=</span> 
            <span class="i">logger</span><span class="o">.</span><span class="i">InfoF</span> <span class="s">&quot;</span><span class="s">Closing</span><span class="s"> </span><span class="s">stream</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs40', 69)" onmouseover="showTip(event, 'fs40', 69)" class="i">target</span>
            <span onmouseout="hideTip(event, 'fs38', 70)" onmouseover="showTip(event, 'fs38', 70)" class="i">stream</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs49', 71)" onmouseover="showTip(event, 'fs49', 71)" class="i">Dispose</span>()
            <span onmouseout="hideTip(event, 'fs45', 72)" onmouseover="showTip(event, 'fs45', 72)" class="i">disposed</span> <span class="o">&lt;-</span> <span class="k">true</span>

    [&lt;<span onmouseout="hideTip(event, 'fs50', 73)" onmouseover="showTip(event, 'fs50', 73)" class="i">CLIEvent</span>&gt;]
    <span class="k">member</span> <span onmouseout="hideTip(event, 'fs47', 74)" onmouseover="showTip(event, 'fs47', 74)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 75)" onmouseover="showTip(event, 'fs51', 75)" class="i">From</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs42', 76)" onmouseover="showTip(event, 'fs42', 76)" class="i">fromPeer</span><span class="o">.</span><span class="i">Publish</span>
    [&lt;<span onmouseout="hideTip(event, 'fs50', 77)" onmouseover="showTip(event, 'fs50', 77)" class="i">CLIEvent</span>&gt;]
    <span class="k">member</span> <span onmouseout="hideTip(event, 'fs47', 78)" onmouseover="showTip(event, 'fs47', 78)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs52', 79)" onmouseover="showTip(event, 'fs52', 79)" class="i">To</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs44', 80)" onmouseover="showTip(event, 'fs44', 80)" class="i">toPeer</span><span class="o">.</span><span class="i">Publish</span>

    <span class="k">interface</span> <span onmouseout="hideTip(event, 'fs33', 81)" onmouseover="showTip(event, 'fs33', 81)" class="i">IPeerSend</span> <span class="k">with</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs47', 82)" onmouseover="showTip(event, 'fs47', 82)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs53', 83)" onmouseover="showTip(event, 'fs53', 83)" class="i">Receive</span>(<span onmouseout="hideTip(event, 'fs54', 84)" onmouseover="showTip(event, 'fs54', 84)" class="i">message</span><span class="o">:</span> <span class="i">BitcoinMessage</span>) <span class="o">=</span> <span class="k">if</span> <span onmouseout="hideTip(event, 'fs55', 85)" onmouseover="showTip(event, 'fs55', 85)" class="i">not</span> <span onmouseout="hideTip(event, 'fs45', 86)" onmouseover="showTip(event, 'fs45', 86)" class="i">disposed</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs42', 87)" onmouseover="showTip(event, 'fs42', 87)" class="i">fromPeer</span><span class="o">.</span><span class="i">Trigger</span> <span onmouseout="hideTip(event, 'fs54', 88)" onmouseover="showTip(event, 'fs54', 88)" class="i">message</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs47', 89)" onmouseover="showTip(event, 'fs47', 89)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs56', 90)" onmouseover="showTip(event, 'fs56', 90)" class="i">Send</span>(<span onmouseout="hideTip(event, 'fs57', 91)" onmouseover="showTip(event, 'fs57', 91)" class="i">message</span><span class="o">:</span> <span class="i">BitcoinMessage</span>) <span class="o">=</span> <span class="k">if</span> <span onmouseout="hideTip(event, 'fs55', 92)" onmouseover="showTip(event, 'fs55', 92)" class="i">not</span> <span onmouseout="hideTip(event, 'fs45', 93)" onmouseover="showTip(event, 'fs45', 93)" class="i">disposed</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs44', 94)" onmouseover="showTip(event, 'fs44', 94)" class="i">toPeer</span><span class="o">.</span><span class="i">Trigger</span> <span onmouseout="hideTip(event, 'fs57', 95)" onmouseover="showTip(event, 'fs57', 95)" class="i">message</span>

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs58', 96)" onmouseover="showTip(event, 'fs58', 96)" class="i">IPeer</span> <span class="o">=</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs59', 97)" onmouseover="showTip(event, 'fs59', 97)" class="i">Id</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs60', 98)" onmouseover="showTip(event, 'fs60', 98)" class="i">int</span> <span class="c">// the unique peer id</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs61', 99)" onmouseover="showTip(event, 'fs61', 99)" class="i">Ready</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs35', 100)" onmouseover="showTip(event, 'fs35', 100)" class="i">unit</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs35', 101)" onmouseover="showTip(event, 'fs35', 101)" class="i">unit</span> <span class="c">// call this to mark this peer ready. Used by Bob</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs62', 102)" onmouseover="showTip(event, 'fs62', 102)" class="i">Bad</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs35', 103)" onmouseover="showTip(event, 'fs35', 103)" class="i">unit</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs35', 104)" onmouseover="showTip(event, 'fs35', 104)" class="i">unit</span> <span class="c">// this peer behaved badly</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs63', 105)" onmouseover="showTip(event, 'fs63', 105)" class="i">Target</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 106)" onmouseover="showTip(event, 'fs41', 106)" class="i">IPEndPoint</span> <span class="c">// the address of the remote node</span>
    <span class="k">abstract</span> <span onmouseout="hideTip(event, 'fs64', 107)" onmouseover="showTip(event, 'fs64', 107)" class="i">Receive</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs65', 108)" onmouseover="showTip(event, 'fs65', 108)" class="i">PeerCommand</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs35', 109)" onmouseover="showTip(event, 'fs35', 109)" class="i">unit</span></pre>
</td>
</tr>
</table>

<h2>Commands</h2>

<p>The communication queues have to be set up before they are used and their types must be provided.
Because F# does not have forward declarations all the commands are listed here even if they are used only later.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="c">// Commands that the Peer can receive</span>
<span class="k">and</span> <span onmouseout="hideTip(event, 'fs65', 110)" onmouseover="showTip(event, 'fs65', 110)" class="i">PeerCommand</span> <span class="o">=</span> 
    | <span onmouseout="hideTip(event, 'fs66', 111)" onmouseover="showTip(event, 'fs66', 111)" class="i">Open</span> <span class="k">of</span> <span class="i">target</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 112)" onmouseover="showTip(event, 'fs41', 112)" class="i">IPEndPoint</span> <span class="o">*</span> <span class="i">tip</span><span class="o">:</span> <span class="i">BlockHeader</span>
    | <span onmouseout="hideTip(event, 'fs67', 113)" onmouseover="showTip(event, 'fs67', 113)" class="i">OpenStream</span> <span class="k">of</span> <span class="i">stream</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs39', 114)" onmouseover="showTip(event, 'fs39', 114)" class="i">NetworkStream</span> <span class="o">*</span> <span class="i">remote</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 115)" onmouseover="showTip(event, 'fs41', 115)" class="i">IPEndPoint</span> <span class="o">*</span> <span class="i">tip</span><span class="o">:</span> <span class="i">BlockHeader</span>
    | <span onmouseout="hideTip(event, 'fs68', 116)" onmouseover="showTip(event, 'fs68', 116)" class="i">Handshaked</span>
    | <span onmouseout="hideTip(event, 'fs69', 117)" onmouseover="showTip(event, 'fs69', 117)" class="i">Execute</span> <span class="k">of</span> <span class="i">message</span><span class="o">:</span> <span class="i">BitcoinMessage</span>
    | <span onmouseout="hideTip(event, 'fs70', 118)" onmouseover="showTip(event, 'fs70', 118)" class="i">GetHeaders</span> <span class="k">of</span> <span class="i">gh</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs70', 119)" onmouseover="showTip(event, 'fs70', 119)" class="i">GetHeaders</span> <span class="o">*</span> <span class="i">task</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs71', 120)" onmouseover="showTip(event, 'fs71', 120)" class="i">TaskCompletionSource</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs72', 121)" onmouseover="showTip(event, 'fs72', 121)" class="i">IObservable</span><span class="o">&lt;</span><span class="i">Headers</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs58', 122)" onmouseover="showTip(event, 'fs58', 122)" class="i">IPeer</span>
    | <span onmouseout="hideTip(event, 'fs73', 123)" onmouseover="showTip(event, 'fs73', 123)" class="i">GetBlocks</span> <span class="k">of</span> <span class="i">gb</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs73', 124)" onmouseover="showTip(event, 'fs73', 124)" class="i">GetBlocks</span> <span class="o">*</span> <span class="i">task</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs71', 125)" onmouseover="showTip(event, 'fs71', 125)" class="i">TaskCompletionSource</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs58', 126)" onmouseover="showTip(event, 'fs58', 126)" class="i">IPeer</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs72', 127)" onmouseover="showTip(event, 'fs72', 127)" class="i">IObservable</span><span class="o">&lt;</span><span class="i">InvVector</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs58', 128)" onmouseover="showTip(event, 'fs58', 128)" class="i">IPeer</span>
    | <span onmouseout="hideTip(event, 'fs74', 129)" onmouseover="showTip(event, 'fs74', 129)" class="i">DownloadBlocks</span> <span class="k">of</span> <span class="i">gd</span><span class="o">:</span> <span class="i">GetData</span> <span class="o">*</span> <span class="i">task</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs71', 130)" onmouseover="showTip(event, 'fs71', 130)" class="i">TaskCompletionSource</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs58', 131)" onmouseover="showTip(event, 'fs58', 131)" class="i">IPeer</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs72', 132)" onmouseover="showTip(event, 'fs72', 132)" class="i">IObservable</span><span class="o">&lt;</span><span class="i">Block</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs75', 133)" onmouseover="showTip(event, 'fs75', 133)" class="i">byte</span>[]<span class="o">&gt;</span><span class="o">&gt;</span>
    | <span onmouseout="hideTip(event, 'fs76', 134)" onmouseover="showTip(event, 'fs76', 134)" class="i">GetData</span> <span class="k">of</span> <span class="i">gd</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs76', 135)" onmouseover="showTip(event, 'fs76', 135)" class="i">GetData</span>
    | <span onmouseout="hideTip(event, 'fs77', 136)" onmouseover="showTip(event, 'fs77', 136)" class="i">SetReady</span>
    | <span onmouseout="hideTip(event, 'fs78', 137)" onmouseover="showTip(event, 'fs78', 137)" class="i">Close</span>
    | <span onmouseout="hideTip(event, 'fs79', 138)" onmouseover="showTip(event, 'fs79', 138)" class="i">Closed</span>
    | <span onmouseout="hideTip(event, 'fs80', 139)" onmouseover="showTip(event, 'fs80', 139)" class="i">UpdateScore</span> <span class="k">of</span> <span class="i">score</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs60', 140)" onmouseover="showTip(event, 'fs60', 140)" class="i">int</span>

<span class="c">// Commands that the Tracker (Tom) can receive</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs81', 141)" onmouseover="showTip(event, 'fs81', 141)" class="i">TrackerCommand</span> <span class="o">=</span> 
    | <span onmouseout="hideTip(event, 'fs82', 142)" onmouseover="showTip(event, 'fs82', 142)" class="i">GetPeers</span>
    | <span onmouseout="hideTip(event, 'fs83', 143)" onmouseover="showTip(event, 'fs83', 143)" class="i">Connect</span> <span class="k">of</span> <span class="i">target</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 144)" onmouseover="showTip(event, 'fs41', 144)" class="i">IPEndPoint</span>
    | <span onmouseout="hideTip(event, 'fs84', 145)" onmouseover="showTip(event, 'fs84', 145)" class="i">IncomingConnection</span> <span class="k">of</span> <span class="i">stream</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs39', 146)" onmouseover="showTip(event, 'fs39', 146)" class="i">NetworkStream</span> <span class="o">*</span> <span class="i">target</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 147)" onmouseover="showTip(event, 'fs41', 147)" class="i">IPEndPoint</span>
    | <span onmouseout="hideTip(event, 'fs85', 148)" onmouseover="showTip(event, 'fs85', 148)" class="i">SetReady</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs86', 149)" onmouseover="showTip(event, 'fs86', 149)" class="i">id</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs60', 150)" onmouseover="showTip(event, 'fs60', 150)" class="i">int</span>
    | <span onmouseout="hideTip(event, 'fs87', 151)" onmouseover="showTip(event, 'fs87', 151)" class="i">Close</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs60', 152)" onmouseover="showTip(event, 'fs60', 152)" class="i">int</span>
    | <span onmouseout="hideTip(event, 'fs88', 153)" onmouseover="showTip(event, 'fs88', 153)" class="i">BitcoinMessage</span> <span class="k">of</span> <span class="i">message</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 154)" onmouseover="showTip(event, 'fs88', 154)" class="i">BitcoinMessage</span>
    | <span onmouseout="hideTip(event, 'fs89', 155)" onmouseover="showTip(event, 'fs89', 155)" class="i">Command</span> <span class="k">of</span> <span class="i">command</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs65', 156)" onmouseover="showTip(event, 'fs65', 156)" class="i">PeerCommand</span>
    | <span onmouseout="hideTip(event, 'fs90', 157)" onmouseover="showTip(event, 'fs90', 157)" class="i">SetTip</span> <span class="k">of</span> <span class="i">tip</span><span class="o">:</span> <span class="i">BlockHeader</span>

<span class="c">// Commands for Bob</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs91', 158)" onmouseover="showTip(event, 'fs91', 158)" class="i">BlockchainCommand</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs92', 159)" onmouseover="showTip(event, 'fs92', 159)" class="i">DownloadBlocks</span> <span class="k">of</span> <span class="i">InvEntry</span> <span onmouseout="hideTip(event, 'fs93', 160)" onmouseover="showTip(event, 'fs93', 160)" class="i">list</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs33', 161)" onmouseover="showTip(event, 'fs33', 161)" class="i">IPeerSend</span>
    | <span onmouseout="hideTip(event, 'fs94', 162)" onmouseover="showTip(event, 'fs94', 162)" class="i">GetHeaders</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs94', 163)" onmouseover="showTip(event, 'fs94', 163)" class="i">GetHeaders</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs33', 164)" onmouseover="showTip(event, 'fs33', 164)" class="i">IPeerSend</span>
    | <span onmouseout="hideTip(event, 'fs95', 165)" onmouseover="showTip(event, 'fs95', 165)" class="i">GetBlocks</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs95', 166)" onmouseover="showTip(event, 'fs95', 166)" class="i">GetBlocks</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs33', 167)" onmouseover="showTip(event, 'fs33', 167)" class="i">IPeerSend</span>
    | <span onmouseout="hideTip(event, 'fs96', 168)" onmouseover="showTip(event, 'fs96', 168)" class="i">Catchup</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs58', 169)" onmouseover="showTip(event, 'fs58', 169)" class="i">IPeer</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs75', 170)" onmouseover="showTip(event, 'fs75', 170)" class="i">byte</span>[]
    | <span onmouseout="hideTip(event, 'fs97', 171)" onmouseover="showTip(event, 'fs97', 171)" class="i">Ping</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs97', 172)" onmouseover="showTip(event, 'fs97', 172)" class="i">Ping</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs33', 173)" onmouseover="showTip(event, 'fs33', 173)" class="i">IPeerSend</span>

<span class="c">// Commands for the memory pool - the transactions that haven&#39;t been confirmed yet</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs98', 174)" onmouseover="showTip(event, 'fs98', 174)" class="i">MempoolCommand</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs99', 175)" onmouseover="showTip(event, 'fs99', 175)" class="i">Revalidate</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs60', 176)" onmouseover="showTip(event, 'fs60', 176)" class="i">int</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs100', 177)" onmouseover="showTip(event, 'fs100', 177)" class="i">seq</span><span class="o">&lt;</span><span class="i">Tx</span>[]<span class="o">&gt;</span>
    | <span onmouseout="hideTip(event, 'fs101', 178)" onmouseover="showTip(event, 'fs101', 178)" class="i">Tx</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs101', 179)" onmouseover="showTip(event, 'fs101', 179)" class="i">Tx</span>
    | <span onmouseout="hideTip(event, 'fs102', 180)" onmouseover="showTip(event, 'fs102', 180)" class="i">Inv</span> <span class="k">of</span> <span class="i">InvVector</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs58', 181)" onmouseover="showTip(event, 'fs58', 181)" class="i">IPeer</span>
    | <span onmouseout="hideTip(event, 'fs103', 182)" onmouseover="showTip(event, 'fs103', 182)" class="i">GetTx</span> <span class="k">of</span> <span class="i">InvEntry</span> <span onmouseout="hideTip(event, 'fs93', 183)" onmouseover="showTip(event, 'fs93', 183)" class="i">list</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs33', 184)" onmouseover="showTip(event, 'fs33', 184)" class="i">IPeerSend</span>
    | <span onmouseout="hideTip(event, 'fs104', 185)" onmouseover="showTip(event, 'fs104', 185)" class="i">Mempool</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs33', 186)" onmouseover="showTip(event, 'fs33', 186)" class="i">IPeerSend</span></pre>
</td>
</tr>
</table>

<p>Finally the queues themselves</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs105', 187)" onmouseover="showTip(event, 'fs105', 187)" class="i">blockchainIncoming</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Subject</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs91', 188)" onmouseover="showTip(event, 'fs91', 188)" class="i">BlockchainCommand</span><span class="o">&gt;</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs106', 189)" onmouseover="showTip(event, 'fs106', 189)" class="i">trackerIncoming</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Subject</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs81', 190)" onmouseover="showTip(event, 'fs81', 190)" class="i">TrackerCommand</span><span class="o">&gt;</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs107', 191)" onmouseover="showTip(event, 'fs107', 191)" class="i">mempoolIncoming</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Subject</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs98', 192)" onmouseover="showTip(event, 'fs98', 192)" class="i">MempoolCommand</span><span class="o">&gt;</span>()</pre>
</td>
</tr>
</table>

<h2>Support for BIP-37 (Bloom Filter)</h2>

<p>A Bloom Filter greater helps SPV clients who want to download or synchronize with a full node but don't
want to spend bandwidth getting data unrelated to their wallets.</p>

<p>A client can define a filter so that the full node filters messages that are irrelevant and only
transmits transactions that match the given filter. Please refer to <a href="https://en.bitcoin.it/wiki/BIP_0037">BIP-37</a> for more details on this
enhancement.</p>

<p>Originally, I didn't plan on supporting this feature because it doesn't quite fit with the requirements of the full node.
It is more of an optimization. However, it is an important one and it is now part of the protocol standard. Pre-version 70001 full
nodes don't have to do it but later versions do.</p>

<p>Fortunately, I had some code related to bloom filters in the wallet part that I can reuse here.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="c">// A node in the partial merkle tree</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs108', 193)" onmouseover="showTip(event, 'fs108', 193)" class="i">PartialMerkleTreeNode</span> <span class="o">=</span> 
    {
    <span onmouseout="hideTip(event, 'fs109', 194)" onmouseover="showTip(event, 'fs109', 194)" class="i">Hash</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs75', 195)" onmouseover="showTip(event, 'fs75', 195)" class="i">byte</span>[]
    <span onmouseout="hideTip(event, 'fs110', 196)" onmouseover="showTip(event, 'fs110', 196)" class="i">Include</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs111', 197)" onmouseover="showTip(event, 'fs111', 197)" class="i">bool</span> <span class="c">// whether any descendant matches the filter</span>
    <span onmouseout="hideTip(event, 'fs112', 198)" onmouseover="showTip(event, 'fs112', 198)" class="i">Left</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs108', 199)" onmouseover="showTip(event, 'fs108', 199)" class="i">PartialMerkleTreeNode</span> <span onmouseout="hideTip(event, 'fs113', 200)" onmouseover="showTip(event, 'fs113', 200)" class="i">option</span> <span class="c">// children are present if Include is true</span>
    <span onmouseout="hideTip(event, 'fs114', 201)" onmouseover="showTip(event, 'fs114', 201)" class="i">Right</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs108', 202)" onmouseover="showTip(event, 'fs108', 202)" class="i">PartialMerkleTreeNode</span> <span onmouseout="hideTip(event, 'fs113', 203)" onmouseover="showTip(event, 'fs113', 203)" class="i">option</span>
    }
    <span class="k">override</span> <span onmouseout="hideTip(event, 'fs115', 204)" onmouseover="showTip(event, 'fs115', 204)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs116', 205)" onmouseover="showTip(event, 'fs116', 205)" class="i">ToString</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs117', 206)" onmouseover="showTip(event, 'fs117', 206)" class="i">sprintf</span> <span class="s">&quot;</span><span class="s">Hash</span><span class="s">(</span><span class="s">%</span><span class="s">s</span><span class="s">)</span><span class="s">,</span><span class="s"> </span><span class="s">Include</span><span class="s">=</span><span class="s">%</span><span class="s">b</span><span class="s">&quot;</span> (<span class="i">hashToHex</span> <span onmouseout="hideTip(event, 'fs115', 207)" onmouseover="showTip(event, 'fs115', 207)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 208)" onmouseover="showTip(event, 'fs109', 208)" class="i">Hash</span>) <span onmouseout="hideTip(event, 'fs115', 209)" onmouseover="showTip(event, 'fs115', 209)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs110', 210)" onmouseover="showTip(event, 'fs110', 210)" class="i">Include</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs118', 211)" onmouseover="showTip(event, 'fs118', 211)" class="i">scriptRuntime</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Script</span><span class="o">.</span><span class="i">ScriptRuntime</span>(<span class="k">fun</span> <span class="i">x</span> _ <span class="k">-&gt;</span> <span class="i">x</span>)</pre>
</td>
</tr>
</table>

<p>Check a transaction against the bloom filter</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs119', 212)" onmouseover="showTip(event, 'fs119', 212)" class="i">checkTxAgainstBloomFilter</span> (<span onmouseout="hideTip(event, 'fs120', 213)" onmouseover="showTip(event, 'fs120', 213)" class="i">bloomFilter</span><span class="o">:</span> <span class="i">BloomFilter</span>) (<span onmouseout="hideTip(event, 'fs121', 214)" onmouseover="showTip(event, 'fs121', 214)" class="i">updateMode</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs29', 215)" onmouseover="showTip(event, 'fs29', 215)" class="i">BloomFilterUpdate</span>) (<span onmouseout="hideTip(event, 'fs122', 216)" onmouseover="showTip(event, 'fs122', 216)" class="i">tx</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs101', 217)" onmouseover="showTip(event, 'fs101', 217)" class="i">Tx</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs123', 218)" onmouseover="showTip(event, 'fs123', 218)" class="i">matchScript</span> (<span onmouseout="hideTip(event, 'fs124', 219)" onmouseover="showTip(event, 'fs124', 219)" class="i">script</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs75', 220)" onmouseover="showTip(event, 'fs75', 220)" class="i">byte</span>[]) <span class="o">=</span> <span class="c">// Try to match a script with the filter</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs125', 221)" onmouseover="showTip(event, 'fs125', 221)" class="i">data</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs118', 222)" onmouseover="showTip(event, 'fs118', 222)" class="i">scriptRuntime</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs76', 223)" onmouseover="showTip(event, 'fs76', 223)" class="i">GetData</span> <span onmouseout="hideTip(event, 'fs124', 224)" onmouseover="showTip(event, 'fs124', 224)" class="i">script</span> <span class="c">// The filter matches only on the data part of the script</span>
        <span onmouseout="hideTip(event, 'fs125', 225)" onmouseover="showTip(event, 'fs125', 225)" class="i">data</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs126', 226)" onmouseover="showTip(event, 'fs126', 226)" class="i">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs127', 227)" onmouseover="showTip(event, 'fs127', 227)" class="i">exists</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs128', 228)" onmouseover="showTip(event, 'fs128', 228)" class="i">d</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs120', 229)" onmouseover="showTip(event, 'fs120', 229)" class="i">bloomFilter</span><span class="o">.</span><span class="i">Check</span> <span onmouseout="hideTip(event, 'fs128', 230)" onmouseover="showTip(event, 'fs128', 230)" class="i">d</span>) <span class="c">// Match is any data item is a match</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs129', 231)" onmouseover="showTip(event, 'fs129', 231)" class="i">addOutpoint</span> (<span onmouseout="hideTip(event, 'fs130', 232)" onmouseover="showTip(event, 'fs130', 232)" class="i">txHash</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs75', 233)" onmouseover="showTip(event, 'fs75', 233)" class="i">byte</span>[]) (<span onmouseout="hideTip(event, 'fs131', 234)" onmouseover="showTip(event, 'fs131', 234)" class="i">iTxOut</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs60', 235)" onmouseover="showTip(event, 'fs60', 235)" class="i">int</span>) <span class="o">=</span> <span class="c">// Update the filter by adding the txOut outpoint</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs132', 236)" onmouseover="showTip(event, 'fs132', 236)" class="i">outpoint</span> <span class="o">=</span> <span class="k">new</span> <span class="i">OutPoint</span>(<span onmouseout="hideTip(event, 'fs130', 237)" onmouseover="showTip(event, 'fs130', 237)" class="i">txHash</span>, <span onmouseout="hideTip(event, 'fs131', 238)" onmouseover="showTip(event, 'fs131', 238)" class="i">iTxOut</span>)
        <span onmouseout="hideTip(event, 'fs120', 239)" onmouseover="showTip(event, 'fs120', 239)" class="i">bloomFilter</span><span class="o">.</span><span class="i">Add</span> (<span onmouseout="hideTip(event, 'fs132', 240)" onmouseover="showTip(event, 'fs132', 240)" class="i">outpoint</span><span class="o">.</span><span class="i">ToByteArray</span>())

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs133', 241)" onmouseover="showTip(event, 'fs133', 241)" class="i">matchTxHash</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs120', 242)" onmouseover="showTip(event, 'fs120', 242)" class="i">bloomFilter</span><span class="o">.</span><span class="i">Check</span> <span onmouseout="hideTip(event, 'fs122', 243)" onmouseover="showTip(event, 'fs122', 243)" class="i">tx</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 244)" onmouseover="showTip(event, 'fs109', 244)" class="i">Hash</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs134', 245)" onmouseover="showTip(event, 'fs134', 245)" class="i">matchInput</span> <span class="o">=</span> <span class="c">// Check if there is a match among the txInputs</span>
        <span onmouseout="hideTip(event, 'fs100', 246)" onmouseover="showTip(event, 'fs100', 246)" class="i">seq</span> {
            <span class="k">for</span> <span onmouseout="hideTip(event, 'fs135', 247)" onmouseover="showTip(event, 'fs135', 247)" class="i">txIn</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs122', 248)" onmouseover="showTip(event, 'fs122', 248)" class="i">tx</span><span class="o">.</span><span class="i">TxIns</span> <span class="k">do</span>
                <span class="k">let</span> <span onmouseout="hideTip(event, 'fs136', 249)" onmouseover="showTip(event, 'fs136', 249)" class="i">matchTxInOutpoint</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs120', 250)" onmouseover="showTip(event, 'fs120', 250)" class="i">bloomFilter</span><span class="o">.</span><span class="i">Check</span> (<span onmouseout="hideTip(event, 'fs135', 251)" onmouseover="showTip(event, 'fs135', 251)" class="i">txIn</span><span class="o">.</span><span class="i">PrevOutPoint</span><span class="o">.</span><span class="i">ToByteArray</span>())
                <span class="k">let</span> <span onmouseout="hideTip(event, 'fs137', 252)" onmouseover="showTip(event, 'fs137', 252)" class="i">matchTxInScript</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs123', 253)" onmouseover="showTip(event, 'fs123', 253)" class="i">matchScript</span> <span onmouseout="hideTip(event, 'fs135', 254)" onmouseover="showTip(event, 'fs135', 254)" class="i">txIn</span><span class="o">.</span><span class="i">Script</span>
                <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs136', 255)" onmouseover="showTip(event, 'fs136', 255)" class="i">matchTxInOutpoint</span> <span class="o">||</span> <span onmouseout="hideTip(event, 'fs137', 256)" onmouseover="showTip(event, 'fs137', 256)" class="i">matchTxInScript</span>
            } <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 257)" onmouseover="showTip(event, 'fs138', 257)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs139', 258)" onmouseover="showTip(event, 'fs139', 258)" class="i">exists</span> <span onmouseout="hideTip(event, 'fs86', 259)" onmouseover="showTip(event, 'fs86', 259)" class="i">id</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs140', 260)" onmouseover="showTip(event, 'fs140', 260)" class="i">matchOutput</span> <span class="o">=</span> <span class="c">// Check if there is a match among the txOutputs</span>
        <span onmouseout="hideTip(event, 'fs122', 261)" onmouseover="showTip(event, 'fs122', 261)" class="i">tx</span><span class="o">.</span><span class="i">TxOuts</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 262)" onmouseover="showTip(event, 'fs138', 262)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs141', 263)" onmouseover="showTip(event, 'fs141', 263)" class="i">mapi</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs131', 264)" onmouseover="showTip(event, 'fs131', 264)" class="i">iTxOut</span> <span onmouseout="hideTip(event, 'fs142', 265)" onmouseover="showTip(event, 'fs142', 265)" class="i">txOut</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs124', 266)" onmouseover="showTip(event, 'fs124', 266)" class="i">script</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs142', 267)" onmouseover="showTip(event, 'fs142', 267)" class="i">txOut</span><span class="o">.</span><span class="i">Script</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs143', 268)" onmouseover="showTip(event, 'fs143', 268)" class="i">matchTxOut</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs123', 269)" onmouseover="showTip(event, 'fs123', 269)" class="i">matchScript</span> <span onmouseout="hideTip(event, 'fs124', 270)" onmouseover="showTip(event, 'fs124', 270)" class="i">script</span>
            <span class="k">if</span> <span onmouseout="hideTip(event, 'fs143', 271)" onmouseover="showTip(event, 'fs143', 271)" class="i">matchTxOut</span> <span class="k">then</span> <span class="c">// If match, update the filter according to the updateMode</span>
                <span class="k">match</span> <span onmouseout="hideTip(event, 'fs121', 272)" onmouseover="showTip(event, 'fs121', 272)" class="i">updateMode</span> <span class="k">with</span>
                | <span onmouseout="hideTip(event, 'fs31', 273)" onmouseover="showTip(event, 'fs31', 273)" class="i">UpdateAll</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs129', 274)" onmouseover="showTip(event, 'fs129', 274)" class="i">addOutpoint</span> <span onmouseout="hideTip(event, 'fs122', 275)" onmouseover="showTip(event, 'fs122', 275)" class="i">tx</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 276)" onmouseover="showTip(event, 'fs109', 276)" class="i">Hash</span> <span onmouseout="hideTip(event, 'fs131', 277)" onmouseover="showTip(event, 'fs131', 277)" class="i">iTxOut</span> <span class="c">// always add the outpoint</span>
                | <span onmouseout="hideTip(event, 'fs32', 278)" onmouseover="showTip(event, 'fs32', 278)" class="i">UpdateP2PubKeyOnly</span> <span class="k">-&gt;</span> <span class="c">// add the outpoint if it&#39;s a pay2Pub or pay2Multisig. It&#39;s ok to add more than necessarily because false</span>
                    <span class="c">// positives are acceptable</span>
                    <span class="k">if</span> <span class="i">Script</span><span class="o">.</span><span class="i">isPay2PubKey</span> <span onmouseout="hideTip(event, 'fs124', 279)" onmouseover="showTip(event, 'fs124', 279)" class="i">script</span> <span class="o">||</span> <span class="i">Script</span><span class="o">.</span><span class="i">isPay2MultiSig</span> <span onmouseout="hideTip(event, 'fs124', 280)" onmouseover="showTip(event, 'fs124', 280)" class="i">script</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs129', 281)" onmouseover="showTip(event, 'fs129', 281)" class="i">addOutpoint</span> <span onmouseout="hideTip(event, 'fs122', 282)" onmouseover="showTip(event, 'fs122', 282)" class="i">tx</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 283)" onmouseover="showTip(event, 'fs109', 283)" class="i">Hash</span> <span onmouseout="hideTip(event, 'fs131', 284)" onmouseover="showTip(event, 'fs131', 284)" class="i">iTxOut</span> 
                | <span onmouseout="hideTip(event, 'fs30', 285)" onmouseover="showTip(event, 'fs30', 285)" class="i">UpdateNone</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs144', 286)" onmouseover="showTip(event, 'fs144', 286)" class="i">ignore</span>() <span class="c">// don&#39;t update</span>
            <span onmouseout="hideTip(event, 'fs143', 287)" onmouseover="showTip(event, 'fs143', 287)" class="i">matchTxOut</span>
            ) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 288)" onmouseover="showTip(event, 'fs138', 288)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs139', 289)" onmouseover="showTip(event, 'fs139', 289)" class="i">exists</span> <span onmouseout="hideTip(event, 'fs86', 290)" onmouseover="showTip(event, 'fs86', 290)" class="i">id</span>
    <span onmouseout="hideTip(event, 'fs133', 291)" onmouseover="showTip(event, 'fs133', 291)" class="i">matchTxHash</span> <span class="o">||</span> <span onmouseout="hideTip(event, 'fs134', 292)" onmouseover="showTip(event, 'fs134', 292)" class="i">matchInput</span> <span class="o">||</span> <span onmouseout="hideTip(event, 'fs140', 293)" onmouseover="showTip(event, 'fs140', 293)" class="i">matchOutput</span></pre>
</td>
</tr>
</table>

<p>Build a merkleblock from a given block</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs145', 294)" onmouseover="showTip(event, 'fs145', 294)" class="i">buildMerkleBlock</span> (<span onmouseout="hideTip(event, 'fs120', 295)" onmouseover="showTip(event, 'fs120', 295)" class="i">bloomFilter</span><span class="o">:</span> <span class="i">BloomFilter</span>) (<span onmouseout="hideTip(event, 'fs121', 296)" onmouseover="showTip(event, 'fs121', 296)" class="i">updateMode</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs29', 297)" onmouseover="showTip(event, 'fs29', 297)" class="i">BloomFilterUpdate</span>) (<span onmouseout="hideTip(event, 'fs146', 298)" onmouseover="showTip(event, 'fs146', 298)" class="i">block</span><span class="o">:</span> <span class="i">Block</span>) <span class="o">=</span>
    <span class="k">let</span> (<span onmouseout="hideTip(event, 'fs147', 299)" onmouseover="showTip(event, 'fs147', 299)" class="i">txs</span>, <span onmouseout="hideTip(event, 'fs148', 300)" onmouseover="showTip(event, 'fs148', 300)" class="i">merkletreeLeaves</span>) <span class="o">=</span> <span class="c">// Build the leaves of the tree</span>
        <span onmouseout="hideTip(event, 'fs146', 301)" onmouseover="showTip(event, 'fs146', 301)" class="i">block</span><span class="o">.</span><span class="i">Txs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 302)" onmouseover="showTip(event, 'fs138', 302)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs149', 303)" onmouseover="showTip(event, 'fs149', 303)" class="i">map</span>(<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs122', 304)" onmouseover="showTip(event, 'fs122', 304)" class="i">tx</span> <span class="k">-&gt;</span> <span class="c">// Each leaf is a transaction</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs150', 305)" onmouseover="showTip(event, 'fs150', 305)" class="i">txMatch</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs119', 306)" onmouseover="showTip(event, 'fs119', 306)" class="i">checkTxAgainstBloomFilter</span> <span onmouseout="hideTip(event, 'fs120', 307)" onmouseover="showTip(event, 'fs120', 307)" class="i">bloomFilter</span> <span onmouseout="hideTip(event, 'fs121', 308)" onmouseover="showTip(event, 'fs121', 308)" class="i">updateMode</span> <span onmouseout="hideTip(event, 'fs122', 309)" onmouseover="showTip(event, 'fs122', 309)" class="i">tx</span>
            (<span onmouseout="hideTip(event, 'fs151', 310)" onmouseover="showTip(event, 'fs151', 310)" class="i">Option</span><span class="o">.</span><span class="i">conditional</span> <span onmouseout="hideTip(event, 'fs150', 311)" onmouseover="showTip(event, 'fs150', 311)" class="i">txMatch</span> <span onmouseout="hideTip(event, 'fs122', 312)" onmouseover="showTip(event, 'fs122', 312)" class="i">tx</span>, { <span class="i">Hash</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs122', 313)" onmouseover="showTip(event, 'fs122', 313)" class="i">tx</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 314)" onmouseover="showTip(event, 'fs109', 314)" class="i">Hash</span>; <span class="i">Include</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs150', 315)" onmouseover="showTip(event, 'fs150', 315)" class="i">txMatch</span>; <span class="i">Left</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 316)" onmouseover="showTip(event, 'fs152', 316)" class="i">None</span>; <span class="i">Right</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 317)" onmouseover="showTip(event, 'fs152', 317)" class="i">None</span> })
        ) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 318)" onmouseover="showTip(event, 'fs138', 318)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs153', 319)" onmouseover="showTip(event, 'fs153', 319)" class="i">toList</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 320)" onmouseover="showTip(event, 'fs154', 320)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs155', 321)" onmouseover="showTip(event, 'fs155', 321)" class="i">unzip</span>

    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs156', 322)" onmouseover="showTip(event, 'fs156', 322)" class="i">makeTree</span> (<span onmouseout="hideTip(event, 'fs157', 323)" onmouseover="showTip(event, 'fs157', 323)" class="i">merkletreeNodes</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs108', 324)" onmouseover="showTip(event, 'fs108', 324)" class="i">PartialMerkleTreeNode</span> <span onmouseout="hideTip(event, 'fs93', 325)" onmouseover="showTip(event, 'fs93', 325)" class="i">list</span>) <span class="o">=</span> <span class="c">// Build the tree by merging level by level</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs157', 326)" onmouseover="showTip(event, 'fs157', 326)" class="i">merkletreeNodes</span> <span class="k">with</span>
        | [<span onmouseout="hideTip(event, 'fs158', 327)" onmouseover="showTip(event, 'fs158', 327)" class="i">root</span>] <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs158', 328)" onmouseover="showTip(event, 'fs158', 328)" class="i">root</span> <span class="c">// If single node, I am at the root</span>
        | _ <span class="k">-&gt;</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs159', 329)" onmouseover="showTip(event, 'fs159', 329)" class="i">len</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs157', 330)" onmouseover="showTip(event, 'fs157', 330)" class="i">merkletreeNodes</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs160', 331)" onmouseover="showTip(event, 'fs160', 331)" class="i">Length</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs161', 332)" onmouseover="showTip(event, 'fs161', 332)" class="i">nodes</span> <span class="o">=</span> <span class="c">// Make the level contain an even number of nodes</span>
                <span class="k">if</span> <span onmouseout="hideTip(event, 'fs159', 333)" onmouseover="showTip(event, 'fs159', 333)" class="i">len</span> <span class="o">%</span> <span class="n">2</span> <span class="o">=</span> <span class="n">0</span> 
                <span class="k">then</span> <span onmouseout="hideTip(event, 'fs157', 334)" onmouseover="showTip(event, 'fs157', 334)" class="i">merkletreeNodes</span>
                <span class="k">else</span> <span onmouseout="hideTip(event, 'fs157', 335)" onmouseover="showTip(event, 'fs157', 335)" class="i">merkletreeNodes</span> <span class="o">@</span> [<span onmouseout="hideTip(event, 'fs157', 336)" onmouseover="showTip(event, 'fs157', 336)" class="i">merkletreeNodes</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs162', 337)" onmouseover="showTip(event, 'fs162', 337)" class="i">Last</span>()] <span class="c">// duplicate the last node if uneven</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs163', 338)" onmouseover="showTip(event, 'fs163', 338)" class="i">parentNodes</span> <span class="o">=</span> <span class="c">// Merge nodes two by two</span>
                (<span onmouseout="hideTip(event, 'fs161', 339)" onmouseover="showTip(event, 'fs161', 339)" class="i">nodes</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 340)" onmouseover="showTip(event, 'fs138', 340)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs164', 341)" onmouseover="showTip(event, 'fs164', 341)" class="i">ofList</span>)<span class="o">.</span><span class="i">Batch</span>(<span class="n">2</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 342)" onmouseover="showTip(event, 'fs138', 342)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs149', 343)" onmouseover="showTip(event, 'fs149', 343)" class="i">map</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs165', 344)" onmouseover="showTip(event, 'fs165', 344)" class="i">x</span> <span class="k">-&gt;</span>
                    <span class="k">let</span> [<span onmouseout="hideTip(event, 'fs166', 345)" onmouseover="showTip(event, 'fs166', 345)" class="i">left</span>; <span onmouseout="hideTip(event, 'fs167', 346)" onmouseover="showTip(event, 'fs167', 346)" class="i">right</span>] <span class="o">=</span> <span onmouseout="hideTip(event, 'fs165', 347)" onmouseover="showTip(event, 'fs165', 347)" class="i">x</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 348)" onmouseover="showTip(event, 'fs138', 348)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs153', 349)" onmouseover="showTip(event, 'fs153', 349)" class="i">toList</span>
                    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs168', 350)" onmouseover="showTip(event, 'fs168', 350)" class="i">includeChildren</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs166', 351)" onmouseover="showTip(event, 'fs166', 351)" class="i">left</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs110', 352)" onmouseover="showTip(event, 'fs110', 352)" class="i">Include</span> <span class="o">||</span> <span onmouseout="hideTip(event, 'fs167', 353)" onmouseover="showTip(event, 'fs167', 353)" class="i">right</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs110', 354)" onmouseover="showTip(event, 'fs110', 354)" class="i">Include</span>
                    { 
                        <span class="i">Hash</span> <span class="o">=</span> <span class="i">dsha</span> ([<span onmouseout="hideTip(event, 'fs166', 355)" onmouseover="showTip(event, 'fs166', 355)" class="i">left</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 356)" onmouseover="showTip(event, 'fs109', 356)" class="i">Hash</span>; <span onmouseout="hideTip(event, 'fs167', 357)" onmouseover="showTip(event, 'fs167', 357)" class="i">right</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 358)" onmouseover="showTip(event, 'fs109', 358)" class="i">Hash</span>] <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs126', 359)" onmouseover="showTip(event, 'fs126', 359)" class="i">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs169', 360)" onmouseover="showTip(event, 'fs169', 360)" class="i">concat</span>) <span class="c">// DSHA on the concat of each hash</span>
                        <span class="i">Include</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs168', 361)" onmouseover="showTip(event, 'fs168', 361)" class="i">includeChildren</span>
                        <span class="i">Left</span> <span class="o">=</span> <span class="k">if</span> <span onmouseout="hideTip(event, 'fs168', 362)" onmouseover="showTip(event, 'fs168', 362)" class="i">includeChildren</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs170', 363)" onmouseover="showTip(event, 'fs170', 363)" class="i">Some</span>(<span onmouseout="hideTip(event, 'fs166', 364)" onmouseover="showTip(event, 'fs166', 364)" class="i">left</span>) <span class="k">else</span> <span onmouseout="hideTip(event, 'fs152', 365)" onmouseover="showTip(event, 'fs152', 365)" class="i">None</span> <span class="c">// Trim the branch if both children have no match</span>
                        <span class="i">Right</span> <span class="o">=</span> <span class="k">if</span> <span onmouseout="hideTip(event, 'fs168', 366)" onmouseover="showTip(event, 'fs168', 366)" class="i">includeChildren</span> <span class="o">&amp;&amp;</span> <span onmouseout="hideTip(event, 'fs166', 367)" onmouseover="showTip(event, 'fs166', 367)" class="i">left</span> <span class="o">&lt;&gt;</span> <span onmouseout="hideTip(event, 'fs167', 368)" onmouseover="showTip(event, 'fs167', 368)" class="i">right</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs170', 369)" onmouseover="showTip(event, 'fs170', 369)" class="i">Some</span>(<span onmouseout="hideTip(event, 'fs167', 370)" onmouseover="showTip(event, 'fs167', 370)" class="i">right</span>) <span class="k">else</span> <span onmouseout="hideTip(event, 'fs152', 371)" onmouseover="showTip(event, 'fs152', 371)" class="i">None</span>
                    }
                ) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 372)" onmouseover="showTip(event, 'fs138', 372)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs153', 373)" onmouseover="showTip(event, 'fs153', 373)" class="i">toList</span>
            <span onmouseout="hideTip(event, 'fs156', 374)" onmouseover="showTip(event, 'fs156', 374)" class="i">makeTree</span> <span onmouseout="hideTip(event, 'fs163', 375)" onmouseover="showTip(event, 'fs163', 375)" class="i">parentNodes</span>
            
    <span class="c">// Build the tree</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs171', 376)" onmouseover="showTip(event, 'fs171', 376)" class="i">merkleTree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs156', 377)" onmouseover="showTip(event, 'fs156', 377)" class="i">makeTree</span> <span onmouseout="hideTip(event, 'fs148', 378)" onmouseover="showTip(event, 'fs148', 378)" class="i">merkletreeLeaves</span>

    <span class="c">// Convert to MerkleBlock format</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs172', 379)" onmouseover="showTip(event, 'fs172', 379)" class="i">hashes</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs154', 380)" onmouseover="showTip(event, 'fs154', 380)" class="i">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs75', 381)" onmouseover="showTip(event, 'fs75', 381)" class="i">byte</span>[]<span class="o">&gt;</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs173', 382)" onmouseover="showTip(event, 'fs173', 382)" class="i">flags</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs154', 383)" onmouseover="showTip(event, 'fs154', 383)" class="i">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs111', 384)" onmouseover="showTip(event, 'fs111', 384)" class="i">bool</span><span class="o">&gt;</span>()

    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs174', 385)" onmouseover="showTip(event, 'fs174', 385)" class="i">depthFirstTraversal</span> (<span onmouseout="hideTip(event, 'fs175', 386)" onmouseover="showTip(event, 'fs175', 386)" class="i">node</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs108', 387)" onmouseover="showTip(event, 'fs108', 387)" class="i">PartialMerkleTreeNode</span>) <span class="o">=</span> <span class="c">// Traverse the tree down</span>
        <span onmouseout="hideTip(event, 'fs173', 388)" onmouseover="showTip(event, 'fs173', 388)" class="i">flags</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs176', 389)" onmouseover="showTip(event, 'fs176', 389)" class="i">Add</span>(<span onmouseout="hideTip(event, 'fs175', 390)" onmouseover="showTip(event, 'fs175', 390)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs110', 391)" onmouseover="showTip(event, 'fs110', 391)" class="i">Include</span>)
        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs175', 392)" onmouseover="showTip(event, 'fs175', 392)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs112', 393)" onmouseover="showTip(event, 'fs112', 393)" class="i">Left</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 394)" onmouseover="showTip(event, 'fs152', 394)" class="i">None</span> <span class="o">&amp;&amp;</span> <span onmouseout="hideTip(event, 'fs175', 395)" onmouseover="showTip(event, 'fs175', 395)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs114', 396)" onmouseover="showTip(event, 'fs114', 396)" class="i">Right</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 397)" onmouseover="showTip(event, 'fs152', 397)" class="i">None</span> <span class="k">then</span> 
            <span onmouseout="hideTip(event, 'fs172', 398)" onmouseover="showTip(event, 'fs172', 398)" class="i">hashes</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs177', 399)" onmouseover="showTip(event, 'fs177', 399)" class="i">Add</span>(<span onmouseout="hideTip(event, 'fs175', 400)" onmouseover="showTip(event, 'fs175', 400)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 401)" onmouseover="showTip(event, 'fs109', 401)" class="i">Hash</span>) <span class="c">// Write the contents of the leaves to the output buffers</span>
        <span onmouseout="hideTip(event, 'fs175', 402)" onmouseover="showTip(event, 'fs175', 402)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs112', 403)" onmouseover="showTip(event, 'fs112', 403)" class="i">Left</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs151', 404)" onmouseover="showTip(event, 'fs151', 404)" class="i">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs178', 405)" onmouseover="showTip(event, 'fs178', 405)" class="i">iter</span> <span onmouseout="hideTip(event, 'fs174', 406)" onmouseover="showTip(event, 'fs174', 406)" class="i">depthFirstTraversal</span>
        <span onmouseout="hideTip(event, 'fs175', 407)" onmouseover="showTip(event, 'fs175', 407)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs114', 408)" onmouseover="showTip(event, 'fs114', 408)" class="i">Right</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs151', 409)" onmouseover="showTip(event, 'fs151', 409)" class="i">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs178', 410)" onmouseover="showTip(event, 'fs178', 410)" class="i">iter</span> <span onmouseout="hideTip(event, 'fs174', 411)" onmouseover="showTip(event, 'fs174', 411)" class="i">depthFirstTraversal</span>

    <span onmouseout="hideTip(event, 'fs174', 412)" onmouseover="showTip(event, 'fs174', 412)" class="i">depthFirstTraversal</span> <span onmouseout="hideTip(event, 'fs171', 413)" onmouseover="showTip(event, 'fs171', 413)" class="i">merkleTree</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs179', 414)" onmouseover="showTip(event, 'fs179', 414)" class="i">txHashes</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs172', 415)" onmouseover="showTip(event, 'fs172', 415)" class="i">hashes</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 416)" onmouseover="showTip(event, 'fs154', 416)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs180', 417)" onmouseover="showTip(event, 'fs180', 417)" class="i">ofSeq</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs181', 418)" onmouseover="showTip(event, 'fs181', 418)" class="i">flags</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs182', 419)" onmouseover="showTip(event, 'fs182', 419)" class="i">BitArray</span>(<span onmouseout="hideTip(event, 'fs181', 420)" onmouseover="showTip(event, 'fs181', 420)" class="i">flags</span><span class="o">.</span><span class="i">ToArray</span>()) <span class="c">// Pack the flags into a bitarray</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs183', 421)" onmouseover="showTip(event, 'fs183', 421)" class="i">flagsBytes</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs75', 422)" onmouseover="showTip(event, 'fs75', 422)" class="i">byte</span>[] <span class="o">=</span> <span onmouseout="hideTip(event, 'fs126', 423)" onmouseover="showTip(event, 'fs126', 423)" class="i">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs184', 424)" onmouseover="showTip(event, 'fs184', 424)" class="i">zeroCreate</span> ((<span onmouseout="hideTip(event, 'fs181', 425)" onmouseover="showTip(event, 'fs181', 425)" class="i">flags</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs185', 426)" onmouseover="showTip(event, 'fs185', 426)" class="i">Length</span><span class="o">-</span><span class="n">1</span>)<span class="o">/</span><span class="n">8</span><span class="o">+</span><span class="n">1</span>)
    <span onmouseout="hideTip(event, 'fs181', 427)" onmouseover="showTip(event, 'fs181', 427)" class="i">flags</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs186', 428)" onmouseover="showTip(event, 'fs186', 428)" class="i">CopyTo</span>(<span onmouseout="hideTip(event, 'fs183', 429)" onmouseover="showTip(event, 'fs183', 429)" class="i">flagsBytes</span>, <span class="n">0</span>)
    (<span onmouseout="hideTip(event, 'fs147', 430)" onmouseover="showTip(event, 'fs147', 430)" class="i">txs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 431)" onmouseover="showTip(event, 'fs154', 431)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs187', 432)" onmouseover="showTip(event, 'fs187', 432)" class="i">choose</span> <span onmouseout="hideTip(event, 'fs86', 433)" onmouseover="showTip(event, 'fs86', 433)" class="i">id</span>, <span class="k">new</span> <span class="i">MerkleBlock</span>(<span onmouseout="hideTip(event, 'fs146', 434)" onmouseover="showTip(event, 'fs146', 434)" class="i">block</span><span class="o">.</span><span class="i">Header</span>, <span onmouseout="hideTip(event, 'fs179', 435)" onmouseover="showTip(event, 'fs179', 435)" class="i">txHashes</span>, <span onmouseout="hideTip(event, 'fs183', 436)" onmouseover="showTip(event, 'fs183', 436)" class="i">flagsBytes</span>))</pre>
</td>
</tr>
</table>

<h2>The Peer implementation</h2>

<h3>The peer's internal state</h3>

<p>The peer changes its command handler as it changes state. Though a common pattern in actor frameworks, I have
to emulate it because RX is not an actor framework. When an actor receives a message, a handler processes it and modifies
the actor's internal state. Optionally, the handler can change for the subsequent messages.</p>

<p>In the case of the peer, the command handler changes between the setup phase and the running phase, and once again during
the running phase and the teardown phase. During the first and final phases, the peer will not process user requests.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs188', 437)" onmouseover="showTip(event, 'fs188', 437)" class="i">PeerData</span> <span class="o">=</span> {
    <span onmouseout="hideTip(event, 'fs189', 438)" onmouseover="showTip(event, 'fs189', 438)" class="i">Queues</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs37', 439)" onmouseover="showTip(event, 'fs37', 439)" class="i">PeerQueues</span> <span onmouseout="hideTip(event, 'fs113', 440)" onmouseover="showTip(event, 'fs113', 440)" class="i">option</span>
    <span onmouseout="hideTip(event, 'fs190', 441)" onmouseover="showTip(event, 'fs190', 441)" class="i">State</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs16', 442)" onmouseover="showTip(event, 'fs16', 442)" class="i">PeerState</span>
    <span onmouseout="hideTip(event, 'fs191', 443)" onmouseover="showTip(event, 'fs191', 443)" class="i">Score</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs60', 444)" onmouseover="showTip(event, 'fs60', 444)" class="i">int</span>
    <span onmouseout="hideTip(event, 'fs192', 445)" onmouseover="showTip(event, 'fs192', 445)" class="i">CommandHandler</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 446)" onmouseover="showTip(event, 'fs188', 446)" class="i">PeerData</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs65', 447)" onmouseover="showTip(event, 'fs65', 447)" class="i">PeerCommand</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs188', 448)" onmouseover="showTip(event, 'fs188', 448)" class="i">PeerData</span>
    }

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs193', 449)" onmouseover="showTip(event, 'fs193', 449)" class="i">Peer</span>(<span onmouseout="hideTip(event, 'fs194', 450)" onmouseover="showTip(event, 'fs194', 450)" class="i">id</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs60', 451)" onmouseover="showTip(event, 'fs60', 451)" class="i">int</span>) <span class="k">as</span> <span onmouseout="hideTip(event, 'fs195', 452)" onmouseover="showTip(event, 'fs195', 452)" class="i">self</span> <span class="o">=</span> 
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs196', 453)" onmouseover="showTip(event, 'fs196', 453)" class="i">disposable</span> <span class="o">=</span> <span class="k">new</span> <span class="i">CompositeDisposable</span>()
    
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs197', 454)" onmouseover="showTip(event, 'fs197', 454)" class="i">target</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs41', 455)" onmouseover="showTip(event, 'fs41', 455)" class="i">IPEndPoint</span> <span class="o">=</span> <span class="k">null</span> <span class="c">// For logging only</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs198', 456)" onmouseover="showTip(event, 'fs198', 456)" class="i">versionMessage</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs199', 457)" onmouseover="showTip(event, 'fs199', 457)" class="i">Version</span> <span onmouseout="hideTip(event, 'fs113', 458)" onmouseover="showTip(event, 'fs113', 458)" class="i">option</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 459)" onmouseover="showTip(event, 'fs152', 459)" class="i">None</span> <span class="c">// For logging only</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs200', 460)" onmouseover="showTip(event, 'fs200', 460)" class="i">bloomFilterUpdateMode</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs29', 461)" onmouseover="showTip(event, 'fs29', 461)" class="i">BloomFilterUpdate</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 462)" onmouseover="showTip(event, 'fs30', 462)" class="i">UpdateNone</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs201', 463)" onmouseover="showTip(event, 'fs201', 463)" class="i">bloomFilter</span><span class="o">:</span> <span class="i">BloomFilter</span> <span onmouseout="hideTip(event, 'fs113', 464)" onmouseover="showTip(event, 'fs113', 464)" class="i">option</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 465)" onmouseover="showTip(event, 'fs152', 465)" class="i">None</span>
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs202', 466)" onmouseover="showTip(event, 'fs202', 466)" class="i">relay</span> <span class="o">=</span> <span class="n">1uy</span></pre>
</td>
</tr>
</table>

<p>Peers take input from 3 distinct sources</p>

<ul>
<li>commands from the Tracker</li>
<li>header messages from the remote node</li>
<li>block messages from the remote node</li>
</ul>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs203', 467)" onmouseover="showTip(event, 'fs203', 467)" class="i">incoming</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs43', 468)" onmouseover="showTip(event, 'fs43', 468)" class="i">Event</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs65', 469)" onmouseover="showTip(event, 'fs65', 469)" class="i">PeerCommand</span><span class="o">&gt;</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs204', 470)" onmouseover="showTip(event, 'fs204', 470)" class="i">headersIncoming</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Subject</span><span class="o">&lt;</span><span class="i">Headers</span><span class="o">&gt;</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs205', 471)" onmouseover="showTip(event, 'fs205', 471)" class="i">blockIncoming</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Subject</span><span class="o">&lt;</span><span class="i">Block</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs75', 472)" onmouseover="showTip(event, 'fs75', 472)" class="i">byte</span>[]<span class="o">&gt;</span>()

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs206', 473)" onmouseover="showTip(event, 'fs206', 473)" class="i">incomingEvent</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs203', 474)" onmouseover="showTip(event, 'fs203', 474)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs207', 475)" onmouseover="showTip(event, 'fs207', 475)" class="i">Publish</span></pre>
</td>
</tr>
</table>

<p>The workloop takes a network stream and continually grabs data from it and delivers them
to the Observable.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs208', 476)" onmouseover="showTip(event, 'fs208', 476)" class="i">workLoop</span>(<span onmouseout="hideTip(event, 'fs38', 477)" onmouseover="showTip(event, 'fs38', 477)" class="i">stream</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs39', 478)" onmouseover="showTip(event, 'fs39', 478)" class="i">NetworkStream</span>) <span class="o">=</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs209', 479)" onmouseover="showTip(event, 'fs209', 479)" class="i">buffer</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs75', 480)" onmouseover="showTip(event, 'fs75', 480)" class="i">byte</span>[] <span class="o">=</span> <span onmouseout="hideTip(event, 'fs126', 481)" onmouseover="showTip(event, 'fs126', 481)" class="i">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs184', 482)" onmouseover="showTip(event, 'fs184', 482)" class="i">zeroCreate</span> <span class="n">1000000</span> <span class="c">// network buffer</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs210', 483)" onmouseover="showTip(event, 'fs210', 483)" class="i">tf</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs211', 484)" onmouseover="showTip(event, 'fs211', 484)" class="i">TaskFactory</span>()
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs212', 485)" onmouseover="showTip(event, 'fs212', 485)" class="i">task</span>() <span class="o">=</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs213', 486)" onmouseover="showTip(event, 'fs213', 486)" class="i">t</span> <span class="o">=</span> 
                <span onmouseout="hideTip(event, 'fs210', 487)" onmouseover="showTip(event, 'fs210', 487)" class="i">tf</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs214', 488)" onmouseover="showTip(event, 'fs214', 488)" class="i">FromAsync</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs75', 489)" onmouseover="showTip(event, 'fs75', 489)" class="i">byte</span> []<span class="o">&gt;</span>(
                    (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs215', 490)" onmouseover="showTip(event, 'fs215', 490)" class="i">cb</span> (<span onmouseout="hideTip(event, 'fs216', 491)" onmouseover="showTip(event, 'fs216', 491)" class="i">state</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs217', 492)" onmouseover="showTip(event, 'fs217', 492)" class="i">obj</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs38', 493)" onmouseover="showTip(event, 'fs38', 493)" class="i">stream</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs218', 494)" onmouseover="showTip(event, 'fs218', 494)" class="i">BeginRead</span>(<span onmouseout="hideTip(event, 'fs209', 495)" onmouseover="showTip(event, 'fs209', 495)" class="i">buffer</span>, <span class="n">0</span>, <span onmouseout="hideTip(event, 'fs209', 496)" onmouseover="showTip(event, 'fs209', 496)" class="i">buffer</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs219', 497)" onmouseover="showTip(event, 'fs219', 497)" class="i">Length</span>, <span onmouseout="hideTip(event, 'fs215', 498)" onmouseover="showTip(event, 'fs215', 498)" class="i">cb</span>, <span onmouseout="hideTip(event, 'fs216', 499)" onmouseover="showTip(event, 'fs216', 499)" class="i">state</span>)), 
                    (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs220', 500)" onmouseover="showTip(event, 'fs220', 500)" class="i">res</span> <span class="k">-&gt;</span> 
                        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs221', 501)" onmouseover="showTip(event, 'fs221', 501)" class="i">c</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs38', 502)" onmouseover="showTip(event, 'fs38', 502)" class="i">stream</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs222', 503)" onmouseover="showTip(event, 'fs222', 503)" class="i">EndRead</span>(<span onmouseout="hideTip(event, 'fs220', 504)" onmouseover="showTip(event, 'fs220', 504)" class="i">res</span>)
                        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs221', 505)" onmouseover="showTip(event, 'fs221', 505)" class="i">c</span> <span class="o">=</span> <span class="n">0</span> <span class="k">then</span> <span class="c">// When the stream is closed, the read returns 0 byte</span>
                            <span onmouseout="hideTip(event, 'fs223', 506)" onmouseover="showTip(event, 'fs223', 506)" class="i">raise</span> (<span class="k">new</span> <span onmouseout="hideTip(event, 'fs224', 507)" onmouseover="showTip(event, 'fs224', 507)" class="i">SocketException</span>())
                        <span class="k">else</span> <span onmouseout="hideTip(event, 'fs209', 508)" onmouseover="showTip(event, 'fs209', 508)" class="i">buffer</span><span class="o">.</span>[<span class="n">0..</span><span onmouseout="hideTip(event, 'fs221', 509)" onmouseover="showTip(event, 'fs221', 509)" class="i">c</span><span class="o">-</span><span class="n">1</span>]), 
                    <span class="k">null</span>)
            <span onmouseout="hideTip(event, 'fs213', 510)" onmouseover="showTip(event, 'fs213', 510)" class="i">t</span><span class="o">.</span><span class="i">ToObservable</span>() <span class="c">// a task that grabs one read asynchronously</span>
        <span onmouseout="hideTip(event, 'fs13', 511)" onmouseover="showTip(event, 'fs13', 511)" class="i">Observable</span><span class="o">.</span><span class="i">Repeat</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs75', 512)" onmouseover="showTip(event, 'fs75', 512)" class="i">byte</span>[]<span class="o">&gt;</span>(<span onmouseout="hideTip(event, 'fs13', 513)" onmouseover="showTip(event, 'fs13', 513)" class="i">Observable</span><span class="o">.</span><span class="i">Defer</span>(<span onmouseout="hideTip(event, 'fs212', 514)" onmouseover="showTip(event, 'fs212', 514)" class="i">task</span>)) <span class="c">// Keep doing the same task until the stream closes</span></pre>
</td>
</tr>
</table>

<p>Helper functions to change the state of the peer. These functions work asynchronously and can be called from
any thread.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs225', 515)" onmouseover="showTip(event, 'fs225', 515)" class="i">readyPeer</span>() <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs203', 516)" onmouseover="showTip(event, 'fs203', 516)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 517)" onmouseover="showTip(event, 'fs226', 517)" class="i">Trigger</span>(<span onmouseout="hideTip(event, 'fs65', 518)" onmouseover="showTip(event, 'fs65', 518)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs77', 519)" onmouseover="showTip(event, 'fs77', 519)" class="i">SetReady</span>)

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs227', 520)" onmouseover="showTip(event, 'fs227', 520)" class="i">closePeer</span>() <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs203', 521)" onmouseover="showTip(event, 'fs203', 521)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 522)" onmouseover="showTip(event, 'fs226', 522)" class="i">Trigger</span>(<span onmouseout="hideTip(event, 'fs65', 523)" onmouseover="showTip(event, 'fs65', 523)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs78', 524)" onmouseover="showTip(event, 'fs78', 524)" class="i">Close</span>)

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs228', 525)" onmouseover="showTip(event, 'fs228', 525)" class="i">badPeer</span>() <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs203', 526)" onmouseover="showTip(event, 'fs203', 526)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 527)" onmouseover="showTip(event, 'fs226', 527)" class="i">Trigger</span>(<span onmouseout="hideTip(event, 'fs80', 528)" onmouseover="showTip(event, 'fs80', 528)" class="i">UpdateScore</span> <span class="o">-</span><span class="n">100</span>) <span class="c">// lose 100 points - the banscore is not implemented yet</span></pre>
</td>
</tr>
</table>

<p>Another helper function that sends a message out and return an empty observable. By having it as
an observable, the sending is part of the time out.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs229', 529)" onmouseover="showTip(event, 'fs229', 529)" class="i">sendMessageObs</span> (<span onmouseout="hideTip(event, 'fs230', 530)" onmouseover="showTip(event, 'fs230', 530)" class="i">peerQueues</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs37', 531)" onmouseover="showTip(event, 'fs37', 531)" class="i">PeerQueues</span>) (<span onmouseout="hideTip(event, 'fs57', 532)" onmouseover="showTip(event, 'fs57', 532)" class="i">message</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 533)" onmouseover="showTip(event, 'fs88', 533)" class="i">BitcoinMessage</span>) <span class="o">=</span> 
        <span onmouseout="hideTip(event, 'fs13', 534)" onmouseover="showTip(event, 'fs13', 534)" class="i">Observable</span><span class="o">.</span><span class="i">Defer</span>(
            <span class="k">fun</span> () <span class="k">-&gt;</span> 
                (<span onmouseout="hideTip(event, 'fs230', 535)" onmouseover="showTip(event, 'fs230', 535)" class="i">peerQueues</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs33', 536)" onmouseover="showTip(event, 'fs33', 536)" class="i">IPeerSend</span>)<span class="o">.</span><span class="i">Send</span>(<span onmouseout="hideTip(event, 'fs57', 537)" onmouseover="showTip(event, 'fs57', 537)" class="i">message</span>)
                <span onmouseout="hideTip(event, 'fs13', 538)" onmouseover="showTip(event, 'fs13', 538)" class="i">Observable</span><span class="o">.</span><span class="i">Empty</span>()
            )</pre>
</td>
</tr>
</table>

<p>Send the message out and catch any exception due to a communication problem with the remote node.
It could have closed. The network stream has a WriteTimeOut set and will throw an exception if the message
couldn't be sent during the allocated time. At this point, if an exception is raised I close the peer because
there isn't much chance of making progress later.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs231', 539)" onmouseover="showTip(event, 'fs231', 539)" class="i">sendMessage</span> (<span onmouseout="hideTip(event, 'fs38', 540)" onmouseover="showTip(event, 'fs38', 540)" class="i">stream</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs39', 541)" onmouseover="showTip(event, 'fs39', 541)" class="i">NetworkStream</span>) (<span onmouseout="hideTip(event, 'fs57', 542)" onmouseover="showTip(event, 'fs57', 542)" class="i">message</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 543)" onmouseover="showTip(event, 'fs88', 543)" class="i">BitcoinMessage</span>) <span class="o">=</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs232', 544)" onmouseover="showTip(event, 'fs232', 544)" class="i">messageBytes</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 545)" onmouseover="showTip(event, 'fs57', 545)" class="i">message</span><span class="o">.</span><span class="i">ToByteArray</span>()
        <span class="k">try</span>
            <span onmouseout="hideTip(event, 'fs38', 546)" onmouseover="showTip(event, 'fs38', 546)" class="i">stream</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs233', 547)" onmouseover="showTip(event, 'fs233', 547)" class="i">Write</span>(<span onmouseout="hideTip(event, 'fs232', 548)" onmouseover="showTip(event, 'fs232', 548)" class="i">messageBytes</span>, <span class="n">0</span>, <span onmouseout="hideTip(event, 'fs232', 549)" onmouseover="showTip(event, 'fs232', 549)" class="i">messageBytes</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs219', 550)" onmouseover="showTip(event, 'fs219', 550)" class="i">Length</span>)
        <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs234', 551)" onmouseover="showTip(event, 'fs234', 551)" class="i">e</span> <span class="k">-&gt;</span> 
            <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Cannot</span><span class="s"> </span><span class="s">send</span><span class="s"> </span><span class="s">message</span><span class="s"> </span><span class="s">to</span><span class="s"> </span><span class="s">peer</span><span class="s">&quot;</span>
            <span onmouseout="hideTip(event, 'fs227', 552)" onmouseover="showTip(event, 'fs227', 552)" class="i">closePeer</span>()</pre>
</td>
</tr>
</table>

<p>Applies the bloom filter to the outgoing message</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs235', 553)" onmouseover="showTip(event, 'fs235', 553)" class="i">filterMessage</span> (<span onmouseout="hideTip(event, 'fs57', 554)" onmouseover="showTip(event, 'fs57', 554)" class="i">message</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 555)" onmouseover="showTip(event, 'fs88', 555)" class="i">BitcoinMessage</span>)<span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 556)" onmouseover="showTip(event, 'fs88', 556)" class="i">BitcoinMessage</span> <span onmouseout="hideTip(event, 'fs93', 557)" onmouseover="showTip(event, 'fs93', 557)" class="i">list</span> <span class="o">=</span>
        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs202', 558)" onmouseover="showTip(event, 'fs202', 558)" class="i">relay</span> <span class="o">=</span> <span class="n">1uy</span> <span class="k">then</span>
            <span class="k">match</span> <span onmouseout="hideTip(event, 'fs57', 559)" onmouseover="showTip(event, 'fs57', 559)" class="i">message</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs89', 560)" onmouseover="showTip(event, 'fs89', 560)" class="i">Command</span> <span class="k">with</span>
            | <span class="s">&quot;</span><span class="s">tx</span><span class="s">&quot;</span> <span class="k">-&gt;</span> 
                <span class="k">let</span> <span class="i">emit</span> <span class="o">=</span> 
                    <span onmouseout="hideTip(event, 'fs201', 561)" onmouseover="showTip(event, 'fs201', 561)" class="i">bloomFilter</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs151', 562)" onmouseover="showTip(event, 'fs151', 562)" class="i">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs236', 563)" onmouseover="showTip(event, 'fs236', 563)" class="i">map</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs237', 564)" onmouseover="showTip(event, 'fs237', 564)" class="i">bf</span> <span class="k">-&gt;</span>
                        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs122', 565)" onmouseover="showTip(event, 'fs122', 565)" class="i">tx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 566)" onmouseover="showTip(event, 'fs57', 566)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs101', 567)" onmouseover="showTip(event, 'fs101', 567)" class="i">Tx</span> 
                        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs150', 568)" onmouseover="showTip(event, 'fs150', 568)" class="i">txMatch</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs119', 569)" onmouseover="showTip(event, 'fs119', 569)" class="i">checkTxAgainstBloomFilter</span> <span onmouseout="hideTip(event, 'fs237', 570)" onmouseover="showTip(event, 'fs237', 570)" class="i">bf</span> <span onmouseout="hideTip(event, 'fs200', 571)" onmouseover="showTip(event, 'fs200', 571)" class="i">bloomFilterUpdateMode</span> <span onmouseout="hideTip(event, 'fs122', 572)" onmouseover="showTip(event, 'fs122', 572)" class="i">tx</span>
                        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs150', 573)" onmouseover="showTip(event, 'fs150', 573)" class="i">txMatch</span> <span class="k">then</span> <span class="i">logger</span><span class="o">.</span><span class="i">InfoF</span> <span class="s">&quot;</span><span class="s">Filtered</span><span class="s"> </span><span class="s">TX</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> (<span class="i">hashToHex</span> <span onmouseout="hideTip(event, 'fs122', 574)" onmouseover="showTip(event, 'fs122', 574)" class="i">tx</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 575)" onmouseover="showTip(event, 'fs109', 575)" class="i">Hash</span>)
                        <span onmouseout="hideTip(event, 'fs150', 576)" onmouseover="showTip(event, 'fs150', 576)" class="i">txMatch</span>
                    ) <span class="o">|?|</span> <span class="k">true</span>
                <span class="k">if</span> <span class="i">emit</span> <span class="k">then</span> [<span onmouseout="hideTip(event, 'fs57', 577)" onmouseover="showTip(event, 'fs57', 577)" class="i">message</span>] <span class="k">else</span> []
            | <span class="s">&quot;</span><span class="s">block</span><span class="s">&quot;</span> <span class="k">-&gt;</span> 
                <span onmouseout="hideTip(event, 'fs201', 578)" onmouseover="showTip(event, 'fs201', 578)" class="i">bloomFilter</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs151', 579)" onmouseover="showTip(event, 'fs151', 579)" class="i">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs236', 580)" onmouseover="showTip(event, 'fs236', 580)" class="i">map</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs237', 581)" onmouseover="showTip(event, 'fs237', 581)" class="i">bf</span> <span class="k">-&gt;</span>
                        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs238', 582)" onmouseover="showTip(event, 'fs238', 582)" class="i">block</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 583)" onmouseover="showTip(event, 'fs57', 583)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">Block</span>
                        <span class="k">let</span> (<span onmouseout="hideTip(event, 'fs239', 584)" onmouseover="showTip(event, 'fs239', 584)" class="i">txs</span>, <span onmouseout="hideTip(event, 'fs240', 585)" onmouseover="showTip(event, 'fs240', 585)" class="i">merkleBlock</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs145', 586)" onmouseover="showTip(event, 'fs145', 586)" class="i">buildMerkleBlock</span> <span onmouseout="hideTip(event, 'fs237', 587)" onmouseover="showTip(event, 'fs237', 587)" class="i">bf</span> <span onmouseout="hideTip(event, 'fs200', 588)" onmouseover="showTip(event, 'fs200', 588)" class="i">bloomFilterUpdateMode</span> <span onmouseout="hideTip(event, 'fs238', 589)" onmouseover="showTip(event, 'fs238', 589)" class="i">block</span>
                        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs241', 590)" onmouseover="showTip(event, 'fs241', 590)" class="i">txMessages</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs239', 591)" onmouseover="showTip(event, 'fs239', 591)" class="i">txs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 592)" onmouseover="showTip(event, 'fs154', 592)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs242', 593)" onmouseover="showTip(event, 'fs242', 593)" class="i">map</span>(<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs243', 594)" onmouseover="showTip(event, 'fs243', 594)" class="i">tx</span> <span class="k">-&gt;</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 595)" onmouseover="showTip(event, 'fs88', 595)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">tx</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs243', 596)" onmouseover="showTip(event, 'fs243', 596)" class="i">tx</span><span class="o">.</span><span class="i">ToByteArray</span>()))
                        <span onmouseout="hideTip(event, 'fs239', 597)" onmouseover="showTip(event, 'fs239', 597)" class="i">txs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 598)" onmouseover="showTip(event, 'fs138', 598)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs244', 599)" onmouseover="showTip(event, 'fs244', 599)" class="i">iter</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs243', 600)" onmouseover="showTip(event, 'fs243', 600)" class="i">tx</span> <span class="k">-&gt;</span> <span class="i">logger</span><span class="o">.</span><span class="i">InfoF</span> <span class="s">&quot;</span><span class="s">Filtered</span><span class="s"> </span><span class="s">TX</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> (<span class="i">hashToHex</span> <span onmouseout="hideTip(event, 'fs243', 601)" onmouseover="showTip(event, 'fs243', 601)" class="i">tx</span><span class="o">.</span><span class="i">Hash</span>))
                        <span onmouseout="hideTip(event, 'fs241', 602)" onmouseover="showTip(event, 'fs241', 602)" class="i">txMessages</span> <span class="o">@</span> [<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 603)" onmouseover="showTip(event, 'fs88', 603)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">merkleblock</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs240', 604)" onmouseover="showTip(event, 'fs240', 604)" class="i">merkleBlock</span><span class="o">.</span><span class="i">ToByteArray</span>())]
                    ) <span class="o">|?|</span> [<span onmouseout="hideTip(event, 'fs57', 605)" onmouseover="showTip(event, 'fs57', 605)" class="i">message</span>]
            | _ <span class="k">-&gt;</span> [<span onmouseout="hideTip(event, 'fs57', 606)" onmouseover="showTip(event, 'fs57', 606)" class="i">message</span>]
        <span class="k">else</span> []</pre>
</td>
</tr>
</table>

<p><code>processMessage</code> handles messages incoming from the remote node. Generally speaking, it parses the payload of the message
and routes it to the appropriate queue.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
<span class="l">50: </span>
<span class="l">51: </span>
<span class="l">52: </span>
<span class="l">53: </span>
<span class="l">54: </span>
<span class="l">55: </span>
<span class="l">56: </span>
<span class="l">57: </span>
<span class="l">58: </span>
<span class="l">59: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs245', 607)" onmouseover="showTip(event, 'fs245', 607)" class="i">processMessage</span> (<span onmouseout="hideTip(event, 'fs230', 608)" onmouseover="showTip(event, 'fs230', 608)" class="i">peerQueues</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs37', 609)" onmouseover="showTip(event, 'fs37', 609)" class="i">PeerQueues</span>) (<span onmouseout="hideTip(event, 'fs57', 610)" onmouseover="showTip(event, 'fs57', 610)" class="i">message</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 611)" onmouseover="showTip(event, 'fs88', 611)" class="i">BitcoinMessage</span>) <span class="o">=</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs246', 612)" onmouseover="showTip(event, 'fs246', 612)" class="i">command</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 613)" onmouseover="showTip(event, 'fs57', 613)" class="i">message</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs89', 614)" onmouseover="showTip(event, 'fs89', 614)" class="i">Command</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs246', 615)" onmouseover="showTip(event, 'fs246', 615)" class="i">command</span> <span class="k">with</span>
        | <span class="s">&quot;</span><span class="s">version</span><span class="s">&quot;</span> 
        | <span class="s">&quot;</span><span class="s">verack</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            (<span onmouseout="hideTip(event, 'fs230', 616)" onmouseover="showTip(event, 'fs230', 616)" class="i">peerQueues</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs33', 617)" onmouseover="showTip(event, 'fs33', 617)" class="i">IPeerSend</span>)<span class="o">.</span><span class="i">Receive</span>(<span onmouseout="hideTip(event, 'fs57', 618)" onmouseover="showTip(event, 'fs57', 618)" class="i">message</span>)
        | <span class="s">&quot;</span><span class="s">getaddr</span><span class="s">&quot;</span> <span class="k">-&gt;</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs247', 619)" onmouseover="showTip(event, 'fs247', 619)" class="i">now</span> <span class="o">=</span> <span class="i">Instant</span><span class="o">.</span><span class="i">FromDateTimeUtc</span>(<span onmouseout="hideTip(event, 'fs248', 620)" onmouseover="showTip(event, 'fs248', 620)" class="i">DateTime</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs249', 621)" onmouseover="showTip(event, 'fs249', 621)" class="i">UtcNow</span>)
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs250', 622)" onmouseover="showTip(event, 'fs250', 622)" class="i">addr</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Addr</span>([|{ <span class="i">Timestamp</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs251', 623)" onmouseover="showTip(event, 'fs251', 623)" class="i">int32</span>(<span onmouseout="hideTip(event, 'fs247', 624)" onmouseover="showTip(event, 'fs247', 624)" class="i">now</span><span class="o">.</span><span class="i">Ticks</span> <span class="o">/</span> <span class="i">NodaConstants</span><span class="o">.</span><span class="i">TicksPerSecond</span>); <span class="i">Address</span> <span class="o">=</span> <span class="i">NetworkAddr</span><span class="o">.</span><span class="i">MyAddress</span> }|])
            (<span onmouseout="hideTip(event, 'fs230', 625)" onmouseover="showTip(event, 'fs230', 625)" class="i">peerQueues</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs33', 626)" onmouseover="showTip(event, 'fs33', 626)" class="i">IPeerSend</span>)<span class="o">.</span><span class="i">Send</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 627)" onmouseover="showTip(event, 'fs88', 627)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">addr</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs250', 628)" onmouseover="showTip(event, 'fs250', 628)" class="i">addr</span><span class="o">.</span><span class="i">ToByteArray</span>()))
        | <span class="s">&quot;</span><span class="s">getdata</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs252', 629)" onmouseover="showTip(event, 'fs252', 629)" class="i">gd</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 630)" onmouseover="showTip(event, 'fs57', 630)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs76', 631)" onmouseover="showTip(event, 'fs76', 631)" class="i">GetData</span>
            <span onmouseout="hideTip(event, 'fs107', 632)" onmouseover="showTip(event, 'fs107', 632)" class="i">mempoolIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs103', 633)" onmouseover="showTip(event, 'fs103', 633)" class="i">GetTx</span> (<span onmouseout="hideTip(event, 'fs252', 634)" onmouseover="showTip(event, 'fs252', 634)" class="i">gd</span><span class="o">.</span><span class="i">Invs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 635)" onmouseover="showTip(event, 'fs154', 635)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs253', 636)" onmouseover="showTip(event, 'fs253', 636)" class="i">filter</span> (<span class="k">fun</span> <span class="i">inv</span> <span class="k">-&gt;</span> <span class="i">inv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs254', 637)" onmouseover="showTip(event, 'fs254', 637)" class="i">Type</span> <span class="o">=</span> <span class="i">txInvType</span>), <span onmouseout="hideTip(event, 'fs230', 638)" onmouseover="showTip(event, 'fs230', 638)" class="i">peerQueues</span>))
            <span onmouseout="hideTip(event, 'fs105', 639)" onmouseover="showTip(event, 'fs105', 639)" class="i">blockchainIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs92', 640)" onmouseover="showTip(event, 'fs92', 640)" class="i">DownloadBlocks</span> (<span onmouseout="hideTip(event, 'fs252', 641)" onmouseover="showTip(event, 'fs252', 641)" class="i">gd</span><span class="o">.</span><span class="i">Invs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 642)" onmouseover="showTip(event, 'fs154', 642)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs253', 643)" onmouseover="showTip(event, 'fs253', 643)" class="i">filter</span> (<span class="k">fun</span> <span class="i">inv</span> <span class="k">-&gt;</span> <span class="i">inv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs254', 644)" onmouseover="showTip(event, 'fs254', 644)" class="i">Type</span> <span class="o">=</span> <span class="i">blockInvType</span> <span class="o">||</span> <span class="i">inv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs254', 645)" onmouseover="showTip(event, 'fs254', 645)" class="i">Type</span> <span class="o">=</span> <span class="i">filteredBlockInvType</span>), <span onmouseout="hideTip(event, 'fs230', 646)" onmouseover="showTip(event, 'fs230', 646)" class="i">peerQueues</span>))
        | <span class="s">&quot;</span><span class="s">getheaders</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs255', 647)" onmouseover="showTip(event, 'fs255', 647)" class="i">gh</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 648)" onmouseover="showTip(event, 'fs57', 648)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs94', 649)" onmouseover="showTip(event, 'fs94', 649)" class="i">GetHeaders</span>
            <span onmouseout="hideTip(event, 'fs105', 650)" onmouseover="showTip(event, 'fs105', 650)" class="i">blockchainIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs94', 651)" onmouseover="showTip(event, 'fs94', 651)" class="i">GetHeaders</span> (<span onmouseout="hideTip(event, 'fs255', 652)" onmouseover="showTip(event, 'fs255', 652)" class="i">gh</span>, <span onmouseout="hideTip(event, 'fs230', 653)" onmouseover="showTip(event, 'fs230', 653)" class="i">peerQueues</span>))
        | <span class="s">&quot;</span><span class="s">getblocks</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs256', 654)" onmouseover="showTip(event, 'fs256', 654)" class="i">gb</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 655)" onmouseover="showTip(event, 'fs57', 655)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs95', 656)" onmouseover="showTip(event, 'fs95', 656)" class="i">GetBlocks</span>
            <span onmouseout="hideTip(event, 'fs105', 657)" onmouseover="showTip(event, 'fs105', 657)" class="i">blockchainIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs95', 658)" onmouseover="showTip(event, 'fs95', 658)" class="i">GetBlocks</span> (<span onmouseout="hideTip(event, 'fs256', 659)" onmouseover="showTip(event, 'fs256', 659)" class="i">gb</span>, <span onmouseout="hideTip(event, 'fs230', 660)" onmouseover="showTip(event, 'fs230', 660)" class="i">peerQueues</span>))
        | <span class="s">&quot;</span><span class="s">addr</span><span class="s">&quot;</span> <span class="k">-&gt;</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs250', 661)" onmouseover="showTip(event, 'fs250', 661)" class="i">addr</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 662)" onmouseover="showTip(event, 'fs57', 662)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">Addr</span>
            <span onmouseout="hideTip(event, 'fs28', 663)" onmouseover="showTip(event, 'fs28', 663)" class="i">addrTopic</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs250', 664)" onmouseover="showTip(event, 'fs250', 664)" class="i">addr</span>)
        | <span class="s">&quot;</span><span class="s">headers</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs257', 665)" onmouseover="showTip(event, 'fs257', 665)" class="i">headers</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 666)" onmouseover="showTip(event, 'fs57', 666)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">Headers</span>
            <span onmouseout="hideTip(event, 'fs204', 667)" onmouseover="showTip(event, 'fs204', 667)" class="i">headersIncoming</span><span class="o">.</span><span class="i">OnNext</span> <span onmouseout="hideTip(event, 'fs257', 668)" onmouseover="showTip(event, 'fs257', 668)" class="i">headers</span>
        | <span class="s">&quot;</span><span class="s">block</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs238', 669)" onmouseover="showTip(event, 'fs238', 669)" class="i">block</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 670)" onmouseover="showTip(event, 'fs57', 670)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">Block</span>
            <span onmouseout="hideTip(event, 'fs205', 671)" onmouseover="showTip(event, 'fs205', 671)" class="i">blockIncoming</span><span class="o">.</span><span class="i">OnNext</span> (<span onmouseout="hideTip(event, 'fs238', 672)" onmouseover="showTip(event, 'fs238', 672)" class="i">block</span>, <span onmouseout="hideTip(event, 'fs57', 673)" onmouseover="showTip(event, 'fs57', 673)" class="i">message</span><span class="o">.</span><span class="i">Payload</span>)
        | <span class="s">&quot;</span><span class="s">inv</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs258', 674)" onmouseover="showTip(event, 'fs258', 674)" class="i">inv</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 675)" onmouseover="showTip(event, 'fs57', 675)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">InvVector</span>
            <span class="k">if</span> <span onmouseout="hideTip(event, 'fs258', 676)" onmouseover="showTip(event, 'fs258', 676)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span><span class="i">IsEmpty</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs144', 677)" onmouseover="showTip(event, 'fs144', 677)" class="i">ignore</span>() <span class="c">// empty inv</span>
            <span class="k">elif</span> <span onmouseout="hideTip(event, 'fs258', 678)" onmouseover="showTip(event, 'fs258', 678)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span><span class="i">Length</span> <span class="o">&gt;</span> <span class="n">1</span> <span class="o">||</span> <span onmouseout="hideTip(event, 'fs258', 679)" onmouseover="showTip(event, 'fs258', 679)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span>[<span class="n">0</span>]<span class="o">.</span><span onmouseout="hideTip(event, 'fs254', 680)" onmouseover="showTip(event, 'fs254', 680)" class="i">Type</span> <span class="o">&lt;&gt;</span> <span class="i">blockInvType</span> <span class="k">then</span> <span class="c">// many invs or not a block inv</span>
                <span onmouseout="hideTip(event, 'fs107', 681)" onmouseover="showTip(event, 'fs107', 681)" class="i">mempoolIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs102', 682)" onmouseover="showTip(event, 'fs102', 682)" class="i">Inv</span>(<span onmouseout="hideTip(event, 'fs258', 683)" onmouseover="showTip(event, 'fs258', 683)" class="i">inv</span>, <span onmouseout="hideTip(event, 'fs195', 684)" onmouseover="showTip(event, 'fs195', 684)" class="i">self</span>)) <span class="c">// send to mempool</span>
            <span class="k">elif</span> <span onmouseout="hideTip(event, 'fs258', 685)" onmouseover="showTip(event, 'fs258', 685)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span><span class="i">Length</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&amp;&amp;</span> <span onmouseout="hideTip(event, 'fs258', 686)" onmouseover="showTip(event, 'fs258', 686)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span>[<span class="n">0</span>]<span class="o">.</span><span onmouseout="hideTip(event, 'fs254', 687)" onmouseover="showTip(event, 'fs254', 687)" class="i">Type</span> <span class="o">=</span> <span class="i">blockInvType</span> <span class="k">then</span> <span class="c">// a block inv, send to blockchain</span>
                <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Catchup</span><span class="s"> </span><span class="s">requested</span><span class="s"> </span><span class="s">by</span><span class="s"> </span><span class="s">%</span><span class="s">d</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs194', 688)" onmouseover="showTip(event, 'fs194', 688)" class="i">id</span> <span onmouseout="hideTip(event, 'fs195', 689)" onmouseover="showTip(event, 'fs195', 689)" class="i">self</span> (<span class="i">hashToHex</span> <span onmouseout="hideTip(event, 'fs258', 690)" onmouseover="showTip(event, 'fs258', 690)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span>[<span class="n">0</span>]<span class="o">.</span><span class="i">Hash</span>)
                <span onmouseout="hideTip(event, 'fs105', 691)" onmouseover="showTip(event, 'fs105', 691)" class="i">blockchainIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs96', 692)" onmouseover="showTip(event, 'fs96', 692)" class="i">Catchup</span>(<span onmouseout="hideTip(event, 'fs195', 693)" onmouseover="showTip(event, 'fs195', 693)" class="i">self</span>, <span onmouseout="hideTip(event, 'fs258', 694)" onmouseover="showTip(event, 'fs258', 694)" class="i">inv</span><span class="o">.</span><span class="i">Invs</span><span class="o">.</span>[<span class="n">0</span>]<span class="o">.</span><span class="i">Hash</span>))
        | <span class="s">&quot;</span><span class="s">tx</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs243', 695)" onmouseover="showTip(event, 'fs243', 695)" class="i">tx</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 696)" onmouseover="showTip(event, 'fs57', 696)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs101', 697)" onmouseover="showTip(event, 'fs101', 697)" class="i">Tx</span>
            <span onmouseout="hideTip(event, 'fs107', 698)" onmouseover="showTip(event, 'fs107', 698)" class="i">mempoolIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs101', 699)" onmouseover="showTip(event, 'fs101', 699)" class="i">Tx</span> <span onmouseout="hideTip(event, 'fs243', 700)" onmouseover="showTip(event, 'fs243', 700)" class="i">tx</span>)
        | <span class="s">&quot;</span><span class="s">ping</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs259', 701)" onmouseover="showTip(event, 'fs259', 701)" class="i">ping</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 702)" onmouseover="showTip(event, 'fs57', 702)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs97', 703)" onmouseover="showTip(event, 'fs97', 703)" class="i">Ping</span> <span class="c">// send to blockchain because tests use pings to sync with catchup</span>
            <span onmouseout="hideTip(event, 'fs105', 704)" onmouseover="showTip(event, 'fs105', 704)" class="i">blockchainIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs91', 705)" onmouseover="showTip(event, 'fs91', 705)" class="i">BlockchainCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs97', 706)" onmouseover="showTip(event, 'fs97', 706)" class="i">Ping</span>(<span onmouseout="hideTip(event, 'fs259', 707)" onmouseover="showTip(event, 'fs259', 707)" class="i">ping</span>, <span onmouseout="hideTip(event, 'fs230', 708)" onmouseover="showTip(event, 'fs230', 708)" class="i">peerQueues</span>))
        | <span class="s">&quot;</span><span class="s">mempool</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs260', 709)" onmouseover="showTip(event, 'fs260', 709)" class="i">mempool</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 710)" onmouseover="showTip(event, 'fs57', 710)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs104', 711)" onmouseover="showTip(event, 'fs104', 711)" class="i">Mempool</span>
            <span onmouseout="hideTip(event, 'fs107', 712)" onmouseover="showTip(event, 'fs107', 712)" class="i">mempoolIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs98', 713)" onmouseover="showTip(event, 'fs98', 713)" class="i">MempoolCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs104', 714)" onmouseover="showTip(event, 'fs104', 714)" class="i">Mempool</span> <span onmouseout="hideTip(event, 'fs230', 715)" onmouseover="showTip(event, 'fs230', 715)" class="i">peerQueues</span>)
        | <span class="s">&quot;</span><span class="s">filteradd</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs261', 716)" onmouseover="showTip(event, 'fs261', 716)" class="i">filterAdd</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 717)" onmouseover="showTip(event, 'fs57', 717)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">FilterAdd</span>
            <span onmouseout="hideTip(event, 'fs201', 718)" onmouseover="showTip(event, 'fs201', 718)" class="i">bloomFilter</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs151', 719)" onmouseover="showTip(event, 'fs151', 719)" class="i">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs178', 720)" onmouseover="showTip(event, 'fs178', 720)" class="i">iter</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs262', 721)" onmouseover="showTip(event, 'fs262', 721)" class="i">bloomFilter</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs262', 722)" onmouseover="showTip(event, 'fs262', 722)" class="i">bloomFilter</span><span class="o">.</span><span class="i">Add</span> <span onmouseout="hideTip(event, 'fs261', 723)" onmouseover="showTip(event, 'fs261', 723)" class="i">filterAdd</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs263', 724)" onmouseover="showTip(event, 'fs263', 724)" class="i">Data</span>)
            <span onmouseout="hideTip(event, 'fs202', 725)" onmouseover="showTip(event, 'fs202', 725)" class="i">relay</span> <span class="o">&lt;-</span> <span class="n">1uy</span>
        | <span class="s">&quot;</span><span class="s">filterload</span><span class="s">&quot;</span> <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs264', 726)" onmouseover="showTip(event, 'fs264', 726)" class="i">filterLoad</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs57', 727)" onmouseover="showTip(event, 'fs57', 727)" class="i">message</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span class="i">FilterLoad</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs237', 728)" onmouseover="showTip(event, 'fs237', 728)" class="i">bf</span> <span class="o">=</span> <span class="k">new</span> <span class="i">BloomFilter</span>(<span onmouseout="hideTip(event, 'fs264', 729)" onmouseover="showTip(event, 'fs264', 729)" class="i">filterLoad</span><span class="o">.</span><span class="i">Filter</span>, <span onmouseout="hideTip(event, 'fs264', 730)" onmouseover="showTip(event, 'fs264', 730)" class="i">filterLoad</span><span class="o">.</span><span class="i">NHash</span>, <span onmouseout="hideTip(event, 'fs264', 731)" onmouseover="showTip(event, 'fs264', 731)" class="i">filterLoad</span><span class="o">.</span><span class="i">NTweak</span>)
            <span onmouseout="hideTip(event, 'fs201', 732)" onmouseover="showTip(event, 'fs201', 732)" class="i">bloomFilter</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs170', 733)" onmouseover="showTip(event, 'fs170', 733)" class="i">Some</span>(<span onmouseout="hideTip(event, 'fs237', 734)" onmouseover="showTip(event, 'fs237', 734)" class="i">bf</span>)
            <span onmouseout="hideTip(event, 'fs202', 735)" onmouseover="showTip(event, 'fs202', 735)" class="i">relay</span> <span class="o">&lt;-</span> <span class="n">1uy</span>
        | <span class="s">&quot;</span><span class="s">filterclear</span><span class="s">&quot;</span> <span class="k">-&gt;</span> 
            <span onmouseout="hideTip(event, 'fs201', 736)" onmouseover="showTip(event, 'fs201', 736)" class="i">bloomFilter</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs152', 737)" onmouseover="showTip(event, 'fs152', 737)" class="i">None</span>
            <span onmouseout="hideTip(event, 'fs202', 738)" onmouseover="showTip(event, 'fs202', 738)" class="i">relay</span> <span class="o">&lt;-</span> <span class="n">1uy</span>
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs144', 739)" onmouseover="showTip(event, 'fs144', 739)" class="i">ignore</span>()</pre>
</td>
</tr>
</table>

<p><code>processConnection</code> is the handler active during connection. It replies to <code>Open</code>, <code>OpenStream</code>, <code>Handshake</code> and <code>Closing</code>.
Every handler needs to support <code>Closing</code> because it may happen at any time. The other messages are specific to the state of the peer.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
<span class="l">50: </span>
<span class="l">51: </span>
<span class="l">52: </span>
<span class="l">53: </span>
<span class="l">54: </span>
<span class="l">55: </span>
<span class="l">56: </span>
<span class="l">57: </span>
<span class="l">58: </span>
<span class="l">59: </span>
<span class="l">60: </span>
<span class="l">61: </span>
<span class="l">62: </span>
<span class="l">63: </span>
<span class="l">64: </span>
<span class="l">65: </span>
<span class="l">66: </span>
<span class="l">67: </span>
<span class="l">68: </span>
<span class="l">69: </span>
<span class="l">70: </span>
<span class="l">71: </span>
<span class="l">72: </span>
<span class="l">73: </span>
<span class="l">74: </span>
<span class="l">75: </span>
<span class="l">76: </span>
<span class="l">77: </span>
<span class="l">78: </span>
<span class="l">79: </span>
<span class="l">80: </span>
<span class="l">81: </span>
<span class="l">82: </span>
<span class="l">83: </span>
<span class="l">84: </span>
<span class="l">85: </span>
<span class="l">86: </span>
<span class="l">87: </span>
<span class="l">88: </span>
<span class="l">89: </span>
<span class="l">90: </span>
<span class="l">91: </span>
<span class="l">92: </span>
<span class="l">93: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs265', 740)" onmouseover="showTip(event, 'fs265', 740)" class="i">processConnection</span> (<span onmouseout="hideTip(event, 'fs266', 741)" onmouseover="showTip(event, 'fs266', 741)" class="i">data</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 742)" onmouseover="showTip(event, 'fs188', 742)" class="i">PeerData</span>) (<span onmouseout="hideTip(event, 'fs267', 743)" onmouseover="showTip(event, 'fs267', 743)" class="i">command</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs65', 744)" onmouseover="showTip(event, 'fs65', 744)" class="i">PeerCommand</span>)<span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 745)" onmouseover="showTip(event, 'fs188', 745)" class="i">PeerData</span> <span class="o">=</span> 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs267', 746)" onmouseover="showTip(event, 'fs267', 746)" class="i">command</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs66', 747)" onmouseover="showTip(event, 'fs66', 747)" class="i">Open</span> (<span onmouseout="hideTip(event, 'fs268', 748)" onmouseover="showTip(event, 'fs268', 748)" class="i">t</span>, <span onmouseout="hideTip(event, 'fs269', 749)" onmouseover="showTip(event, 'fs269', 749)" class="i">tip</span>) <span class="k">-&gt;</span> <span class="c">// Got a outgoing connection request</span>
            <span onmouseout="hideTip(event, 'fs197', 750)" onmouseover="showTip(event, 'fs197', 750)" class="i">target</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs268', 751)" onmouseover="showTip(event, 'fs268', 751)" class="i">t</span>
            <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Connect</span><span class="s"> </span><span class="s">to</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> (<span onmouseout="hideTip(event, 'fs197', 752)" onmouseover="showTip(event, 'fs197', 752)" class="i">target</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs270', 753)" onmouseover="showTip(event, 'fs270', 753)" class="i">ToString</span>())
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs271', 754)" onmouseover="showTip(event, 'fs271', 754)" class="i">connect</span> <span class="o">=</span> 
                <span onmouseout="hideTip(event, 'fs272', 755)" onmouseover="showTip(event, 'fs272', 755)" class="i">async</span> {
                    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs273', 756)" onmouseover="showTip(event, 'fs273', 756)" class="i">client</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs8', 757)" onmouseover="showTip(event, 'fs8', 757)" class="i">Sockets</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs274', 758)" onmouseover="showTip(event, 'fs274', 758)" class="i">TcpClient</span>()
                    <span class="k">do!</span> <span onmouseout="hideTip(event, 'fs275', 759)" onmouseover="showTip(event, 'fs275', 759)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs276', 760)" onmouseover="showTip(event, 'fs276', 760)" class="i">FromBeginEnd</span>(
                            <span onmouseout="hideTip(event, 'fs197', 761)" onmouseover="showTip(event, 'fs197', 761)" class="i">target</span>, 
                            (<span class="k">fun</span> (<span onmouseout="hideTip(event, 'fs40', 762)" onmouseover="showTip(event, 'fs40', 762)" class="i">target</span>, <span onmouseout="hideTip(event, 'fs215', 763)" onmouseover="showTip(event, 'fs215', 763)" class="i">cb</span>, <span onmouseout="hideTip(event, 'fs216', 764)" onmouseover="showTip(event, 'fs216', 764)" class="i">state</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs273', 765)" onmouseover="showTip(event, 'fs273', 765)" class="i">client</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs277', 766)" onmouseover="showTip(event, 'fs277', 766)" class="i">BeginConnect</span>(<span onmouseout="hideTip(event, 'fs40', 767)" onmouseover="showTip(event, 'fs40', 767)" class="i">target</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs278', 768)" onmouseover="showTip(event, 'fs278', 768)" class="i">Address</span>, <span onmouseout="hideTip(event, 'fs40', 769)" onmouseover="showTip(event, 'fs40', 769)" class="i">target</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs279', 770)" onmouseover="showTip(event, 'fs279', 770)" class="i">Port</span>, <span onmouseout="hideTip(event, 'fs215', 771)" onmouseover="showTip(event, 'fs215', 771)" class="i">cb</span>, <span onmouseout="hideTip(event, 'fs216', 772)" onmouseover="showTip(event, 'fs216', 772)" class="i">state</span>)),
                            <span onmouseout="hideTip(event, 'fs273', 773)" onmouseover="showTip(event, 'fs273', 773)" class="i">client</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs280', 774)" onmouseover="showTip(event, 'fs280', 774)" class="i">EndConnect</span>)
                    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs38', 775)" onmouseover="showTip(event, 'fs38', 775)" class="i">stream</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs273', 776)" onmouseover="showTip(event, 'fs273', 776)" class="i">client</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs281', 777)" onmouseover="showTip(event, 'fs281', 777)" class="i">GetStream</span>()
                    <span class="k">return</span> <span onmouseout="hideTip(event, 'fs67', 778)" onmouseover="showTip(event, 'fs67', 778)" class="i">OpenStream</span> (<span onmouseout="hideTip(event, 'fs38', 779)" onmouseover="showTip(event, 'fs38', 779)" class="i">stream</span>, <span onmouseout="hideTip(event, 'fs197', 780)" onmouseover="showTip(event, 'fs197', 780)" class="i">target</span>, <span onmouseout="hideTip(event, 'fs269', 781)" onmouseover="showTip(event, 'fs269', 781)" class="i">tip</span>)
                    }

            <span class="c">// Connect to the node and bail out if it fails or the timeout expires</span>
            <span onmouseout="hideTip(event, 'fs13', 782)" onmouseover="showTip(event, 'fs13', 782)" class="i">Observable</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs282', 783)" onmouseover="showTip(event, 'fs282', 783)" class="i">Timeout</span>(<span onmouseout="hideTip(event, 'fs275', 784)" onmouseover="showTip(event, 'fs275', 784)" class="i">Async</span><span class="o">.</span><span class="i">AsObservable</span> <span onmouseout="hideTip(event, 'fs271', 785)" onmouseover="showTip(event, 'fs271', 785)" class="i">connect</span>, <span class="i">connectTimeout</span>)<span class="o">.</span><span class="i">Subscribe</span>(
                <span class="i">onNext</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">c</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs203', 786)" onmouseover="showTip(event, 'fs203', 786)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 787)" onmouseover="showTip(event, 'fs226', 787)" class="i">Trigger</span> <span class="i">c</span>), <span class="c">// If connected, grab the stream</span>
                <span class="i">onError</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">ex</span> <span class="k">-&gt;</span> 
                    <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Connect</span><span class="s"> </span><span class="s">failed</span><span class="s">&gt;</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs268', 788)" onmouseover="showTip(event, 'fs268', 788)" class="i">t</span> (<span class="i">ex</span><span class="o">.</span><span class="i">ToString</span>())
                    <span onmouseout="hideTip(event, 'fs227', 789)" onmouseover="showTip(event, 'fs227', 789)" class="i">closePeer</span>())
            ) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs144', 790)" onmouseover="showTip(event, 'fs144', 790)" class="i">ignore</span>
            <span onmouseout="hideTip(event, 'fs266', 791)" onmouseover="showTip(event, 'fs266', 791)" class="i">data</span>
        | <span onmouseout="hideTip(event, 'fs67', 792)" onmouseover="showTip(event, 'fs67', 792)" class="i">OpenStream</span> (<span onmouseout="hideTip(event, 'fs38', 793)" onmouseover="showTip(event, 'fs38', 793)" class="i">stream</span>, <span onmouseout="hideTip(event, 'fs268', 794)" onmouseover="showTip(event, 'fs268', 794)" class="i">t</span>, <span onmouseout="hideTip(event, 'fs269', 795)" onmouseover="showTip(event, 'fs269', 795)" class="i">tip</span>) <span class="k">-&gt;</span> <span class="c">// Got a stream from a successful connection (in or out)</span>
            <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">OpenStream</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs268', 796)" onmouseover="showTip(event, 'fs268', 796)" class="i">t</span>
            <span onmouseout="hideTip(event, 'fs197', 797)" onmouseover="showTip(event, 'fs197', 797)" class="i">target</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs268', 798)" onmouseover="showTip(event, 'fs268', 798)" class="i">t</span>
            <span onmouseout="hideTip(event, 'fs38', 799)" onmouseover="showTip(event, 'fs38', 799)" class="i">stream</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs283', 800)" onmouseover="showTip(event, 'fs283', 800)" class="i">WriteTimeout</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs60', 801)" onmouseover="showTip(event, 'fs60', 801)" class="i">int</span>(<span class="i">commandTimeout</span><span class="o">.</span><span class="i">Ticks</span> <span class="o">/</span> <span onmouseout="hideTip(event, 'fs284', 802)" onmouseover="showTip(event, 'fs284', 802)" class="i">TimeSpan</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs285', 803)" onmouseover="showTip(event, 'fs285', 803)" class="i">TicksPerMillisecond</span>)
            <span class="c">// Setup the queues and the network to bitcoin message parser</span>
            <span class="c">// Observables are created but not subscribed to, so in fact nothing is consumed from the stream yet</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs230', 804)" onmouseover="showTip(event, 'fs230', 804)" class="i">peerQueues</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs37', 805)" onmouseover="showTip(event, 'fs37', 805)" class="i">PeerQueues</span>(<span onmouseout="hideTip(event, 'fs38', 806)" onmouseover="showTip(event, 'fs38', 806)" class="i">stream</span>, <span onmouseout="hideTip(event, 'fs197', 807)" onmouseover="showTip(event, 'fs197', 807)" class="i">target</span>)
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs286', 808)" onmouseover="showTip(event, 'fs286', 808)" class="i">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="i">BitcoinMessageParser</span>(<span onmouseout="hideTip(event, 'fs208', 809)" onmouseover="showTip(event, 'fs208', 809)" class="i">workLoop</span>(<span onmouseout="hideTip(event, 'fs38', 810)" onmouseover="showTip(event, 'fs38', 810)" class="i">stream</span>))
            <span class="c">// Subscribe the outgoing queue, it&#39;s ready to send out messages</span>
            <span class="c">// Subscriptions are not added to the disposable object unless they should be removed when the event loop finishes</span>
            <span onmouseout="hideTip(event, 'fs230', 811)" onmouseover="showTip(event, 'fs230', 811)" class="i">peerQueues</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs287', 812)" onmouseover="showTip(event, 'fs287', 812)" class="i">To</span><span class="o">.</span><span class="i">SelectMany</span>(<span class="k">fun</span> <span class="i">m</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs235', 813)" onmouseover="showTip(event, 'fs235', 813)" class="i">filterMessage</span> <span class="i">m</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs154', 814)" onmouseover="showTip(event, 'fs154', 814)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs288', 815)" onmouseover="showTip(event, 'fs288', 815)" class="i">toSeq</span>)<span class="o">.</span><span class="i">Subscribe</span>(<span class="i">onNext</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">m</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs231', 816)" onmouseover="showTip(event, 'fs231', 816)" class="i">sendMessage</span> <span onmouseout="hideTip(event, 'fs38', 817)" onmouseover="showTip(event, 'fs38', 817)" class="i">stream</span> <span class="i">m</span>), <span class="i">onError</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">e</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs227', 818)" onmouseover="showTip(event, 'fs227', 818)" class="i">closePeer</span>())) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs144', 819)" onmouseover="showTip(event, 'fs144', 819)" class="i">ignore</span>
            <span onmouseout="hideTip(event, 'fs196', 820)" onmouseover="showTip(event, 'fs196', 820)" class="i">disposable</span><span class="o">.</span><span class="i">Add</span>(<span onmouseout="hideTip(event, 'fs230', 821)" onmouseover="showTip(event, 'fs230', 821)" class="i">peerQueues</span>)

            <span class="c">// Prepare and send out my version message</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs289', 822)" onmouseover="showTip(event, 'fs289', 822)" class="i">version</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs199', 823)" onmouseover="showTip(event, 'fs199', 823)" class="i">Version</span><span class="o">.</span><span class="i">Create</span>(<span class="i">SystemClock</span><span class="o">.</span><span class="i">Instance</span><span class="o">.</span><span class="i">Now</span>, <span onmouseout="hideTip(event, 'fs197', 824)" onmouseover="showTip(event, 'fs197', 824)" class="i">target</span>, <span class="i">NetworkAddr</span><span class="o">.</span><span class="i">MyAddress</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs290', 825)" onmouseover="showTip(event, 'fs290', 825)" class="i">EndPoint</span>, <span onmouseout="hideTip(event, 'fs291', 826)" onmouseover="showTip(event, 'fs291', 826)" class="i">int64</span>(<span class="i">random</span><span class="o">.</span><span class="i">Next</span>()), <span class="s">&quot;</span><span class="s">Satoshi</span><span class="s"> </span><span class="s">YOLO</span><span class="s"> </span><span class="s">1</span><span class="s">.</span><span class="s">0</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs269', 827)" onmouseover="showTip(event, 'fs269', 827)" class="i">tip</span><span class="o">.</span><span class="i">Height</span>, <span class="n">1uy</span>)
            (<span onmouseout="hideTip(event, 'fs230', 828)" onmouseover="showTip(event, 'fs230', 828)" class="i">peerQueues</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs33', 829)" onmouseover="showTip(event, 'fs33', 829)" class="i">IPeerSend</span>)<span class="o">.</span><span class="i">Send</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 830)" onmouseover="showTip(event, 'fs88', 830)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">version</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs289', 831)" onmouseover="showTip(event, 'fs289', 831)" class="i">version</span><span class="o">.</span><span class="i">ToByteArray</span>()))

            <span class="c">// The handshake observable waits for the verack and the version response from the other side. When both parties have</span>
            <span class="c">// exchanged their version/verack, it will deliver a single event &quot;Handshaked&quot;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs292', 832)" onmouseover="showTip(event, 'fs292', 832)" class="i">handshakeObs</span> <span class="o">=</span> 
                <span onmouseout="hideTip(event, 'fs230', 833)" onmouseover="showTip(event, 'fs230', 833)" class="i">peerQueues</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs287', 834)" onmouseover="showTip(event, 'fs287', 834)" class="i">From</span>
                    <span class="o">.</span><span class="i">Scan</span>((<span class="k">false</span>, <span class="k">false</span>), <span class="k">fun</span> (<span class="i">versionReceived</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs111', 835)" onmouseover="showTip(event, 'fs111', 835)" class="i">bool</span>, <span class="i">verackReceived</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs111', 836)" onmouseover="showTip(event, 'fs111', 836)" class="i">bool</span>) (<span class="i">m</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs88', 837)" onmouseover="showTip(event, 'fs88', 837)" class="i">BitcoinMessage</span>) <span class="k">-&gt;</span>
                    <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">HS</span><span class="s">&gt;</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span class="i">m</span>
                    <span class="k">match</span> <span class="i">m</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs89', 838)" onmouseover="showTip(event, 'fs89', 838)" class="i">Command</span> <span class="k">with</span>
                    | <span class="s">&quot;</span><span class="s">version</span><span class="s">&quot;</span> <span class="k">-&gt;</span> 
                        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs289', 839)" onmouseover="showTip(event, 'fs289', 839)" class="i">version</span> <span class="o">=</span> <span class="i">m</span><span class="o">.</span><span class="i">ParsePayload</span>() <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs199', 840)" onmouseover="showTip(event, 'fs199', 840)" class="i">Version</span>
                        <span onmouseout="hideTip(event, 'fs198', 841)" onmouseover="showTip(event, 'fs198', 841)" class="i">versionMessage</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs170', 842)" onmouseover="showTip(event, 'fs170', 842)" class="i">Some</span>(<span onmouseout="hideTip(event, 'fs289', 843)" onmouseover="showTip(event, 'fs289', 843)" class="i">version</span>)
                        <span onmouseout="hideTip(event, 'fs202', 844)" onmouseover="showTip(event, 'fs202', 844)" class="i">relay</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs289', 845)" onmouseover="showTip(event, 'fs289', 845)" class="i">version</span><span class="o">.</span><span class="i">Relay</span>
                        (<span onmouseout="hideTip(event, 'fs230', 846)" onmouseover="showTip(event, 'fs230', 846)" class="i">peerQueues</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs33', 847)" onmouseover="showTip(event, 'fs33', 847)" class="i">IPeerSend</span>)<span class="o">.</span><span class="i">Send</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 848)" onmouseover="showTip(event, 'fs88', 848)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">verack</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs126', 849)" onmouseover="showTip(event, 'fs126', 849)" class="i">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs293', 850)" onmouseover="showTip(event, 'fs293', 850)" class="i">empty</span>))
                        (<span class="k">true</span>, <span class="i">verackReceived</span>)
                    | <span class="s">&quot;</span><span class="s">verack</span><span class="s">&quot;</span> <span class="k">-&gt;</span> (<span class="i">versionReceived</span>, <span class="k">true</span>)
                    | _ <span class="k">-&gt;</span> (<span class="i">versionReceived</span>, <span class="i">verackReceived</span>))
                    <span class="o">.</span><span class="i">SkipWhile</span>(<span class="k">fun</span> (<span class="i">versionReceived</span>, <span class="i">verackReceived</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs55', 851)" onmouseover="showTip(event, 'fs55', 851)" class="i">not</span> <span class="i">versionReceived</span> <span class="o">||</span> <span onmouseout="hideTip(event, 'fs55', 852)" onmouseover="showTip(event, 'fs55', 852)" class="i">not</span> <span class="i">verackReceived</span>)
                    <span class="o">.</span><span class="i">Take</span>(<span class="n">1</span>)
                    <span class="o">.</span><span class="i">Select</span>(<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs68', 853)" onmouseover="showTip(event, 'fs68', 853)" class="i">Handshaked</span>)

            <span class="c">// Give that observable a certain time to finish</span>
            <span onmouseout="hideTip(event, 'fs13', 854)" onmouseover="showTip(event, 'fs13', 854)" class="i">Observable</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs282', 855)" onmouseover="showTip(event, 'fs282', 855)" class="i">Timeout</span>(<span onmouseout="hideTip(event, 'fs292', 856)" onmouseover="showTip(event, 'fs292', 856)" class="i">handshakeObs</span>, <span class="i">handshakeTimeout</span>)<span class="o">.</span><span class="i">Subscribe</span>(
                <span class="i">onNext</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">c</span> <span class="k">-&gt;</span> 
                    <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">%</span><span class="s">A</span><span class="s"> </span><span class="s">Handshaked</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs268', 857)" onmouseover="showTip(event, 'fs268', 857)" class="i">t</span>
                    <span onmouseout="hideTip(event, 'fs203', 858)" onmouseover="showTip(event, 'fs203', 858)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 859)" onmouseover="showTip(event, 'fs226', 859)" class="i">Trigger</span> <span class="i">c</span>),
                <span class="i">onError</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">ex</span> <span class="k">-&gt;</span> 
                    <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Handshake</span><span class="s"> </span><span class="s">failed</span><span class="s">&gt;</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs197', 860)" onmouseover="showTip(event, 'fs197', 860)" class="i">target</span> (<span class="i">ex</span><span class="o">.</span><span class="i">ToString</span>())
                    <span onmouseout="hideTip(event, 'fs227', 861)" onmouseover="showTip(event, 'fs227', 861)" class="i">closePeer</span>())
            ) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs144', 862)" onmouseover="showTip(event, 'fs144', 862)" class="i">ignore</span>

            <span class="c">// Finally subscribe and start consuming the responses from the remote side</span>
            <span class="c">// Any exception closes the peer</span>
            <span onmouseout="hideTip(event, 'fs196', 863)" onmouseover="showTip(event, 'fs196', 863)" class="i">disposable</span><span class="o">.</span><span class="i">Add</span>(
                <span onmouseout="hideTip(event, 'fs286', 864)" onmouseover="showTip(event, 'fs286', 864)" class="i">parser</span><span class="o">.</span><span class="i">BitcoinMessages</span><span class="o">.</span><span class="i">Subscribe</span>(
                    <span class="i">onNext</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">m</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs245', 865)" onmouseover="showTip(event, 'fs245', 865)" class="i">processMessage</span> <span onmouseout="hideTip(event, 'fs230', 866)" onmouseover="showTip(event, 'fs230', 866)" class="i">peerQueues</span> <span class="i">m</span>), 
                    <span class="i">onError</span> <span class="o">=</span> (<span class="k">fun</span> <span class="i">e</span> <span class="k">-&gt;</span> 
                        <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Exception</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span class="i">e</span>
                        <span onmouseout="hideTip(event, 'fs227', 867)" onmouseover="showTip(event, 'fs227', 867)" class="i">closePeer</span>())))
            <span class="c">// But if it goes well, </span>
            { <span onmouseout="hideTip(event, 'fs266', 868)" onmouseover="showTip(event, 'fs266', 868)" class="i">data</span> <span class="k">with</span> <span class="i">Queues</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs170', 869)" onmouseover="showTip(event, 'fs170', 869)" class="i">Some</span>(<span onmouseout="hideTip(event, 'fs230', 870)" onmouseover="showTip(event, 'fs230', 870)" class="i">peerQueues</span>) }
        | <span onmouseout="hideTip(event, 'fs68', 871)" onmouseover="showTip(event, 'fs68', 871)" class="i">Handshaked</span> <span class="k">-&gt;</span>
            <span class="c">// Got the handshake, the peer is ready</span>
            <span onmouseout="hideTip(event, 'fs106', 872)" onmouseover="showTip(event, 'fs106', 872)" class="i">trackerIncoming</span><span class="o">.</span><span class="i">OnNext</span> (<span onmouseout="hideTip(event, 'fs81', 873)" onmouseover="showTip(event, 'fs81', 873)" class="i">TrackerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs85', 874)" onmouseover="showTip(event, 'fs85', 874)" class="i">SetReady</span> <span onmouseout="hideTip(event, 'fs194', 875)" onmouseover="showTip(event, 'fs194', 875)" class="i">id</span>)
            { <span onmouseout="hideTip(event, 'fs266', 876)" onmouseover="showTip(event, 'fs266', 876)" class="i">data</span> <span class="k">with</span> <span class="i">State</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs17', 877)" onmouseover="showTip(event, 'fs17', 877)" class="i">Connected</span>; <span class="i">CommandHandler</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs294', 878)" onmouseover="showTip(event, 'fs294', 878)" class="i">processCommand</span> }
        | <span onmouseout="hideTip(event, 'fs65', 879)" onmouseover="showTip(event, 'fs65', 879)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs78', 880)" onmouseover="showTip(event, 'fs78', 880)" class="i">Close</span> <span class="k">-&gt;</span> 
            <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Closing</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs197', 881)" onmouseover="showTip(event, 'fs197', 881)" class="i">target</span>
            <span class="c">// Tell the Tracker that the peer is finished but don&#39;t leave yet. Tom will do the paperwork and </span>
            <span class="c">// give the severance package</span>
            <span onmouseout="hideTip(event, 'fs106', 882)" onmouseover="showTip(event, 'fs106', 882)" class="i">trackerIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs81', 883)" onmouseover="showTip(event, 'fs81', 883)" class="i">TrackerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs87', 884)" onmouseover="showTip(event, 'fs87', 884)" class="i">Close</span> <span onmouseout="hideTip(event, 'fs194', 885)" onmouseover="showTip(event, 'fs194', 885)" class="i">id</span>)
            { <span onmouseout="hideTip(event, 'fs266', 886)" onmouseover="showTip(event, 'fs266', 886)" class="i">data</span> <span class="k">with</span> <span class="i">CommandHandler</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs295', 887)" onmouseover="showTip(event, 'fs295', 887)" class="i">processClosing</span> }
        | _ <span class="k">-&gt;</span> 
            <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Ignoring</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s"> </span><span class="s">because</span><span class="s"> </span><span class="s">the</span><span class="s"> </span><span class="s">peer</span><span class="s"> </span><span class="s">is</span><span class="s"> </span><span class="s">not</span><span class="s"> </span><span class="s">connected</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs267', 888)" onmouseover="showTip(event, 'fs267', 888)" class="i">command</span>
            <span onmouseout="hideTip(event, 'fs266', 889)" onmouseover="showTip(event, 'fs266', 889)" class="i">data</span></pre>
</td>
</tr>
</table>

<p><code>processCommand</code> is the handler for normal state. The request can be either</p>

<ul>
<li>For the remote node. In which case, it's simply forwarded.</li>
<li>A getheader/getblock. These come from Bob and Bob wants the response directly. The message came with a <code>TaskCompletionSource</code> for
an observable. The peer creates the observable and notifies Bob of its availability.</li>
<li>A request for the remote node like getdata. They come from the memory pool.</li>
<li>or some state management message</li>
</ul>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">and</span> <span onmouseout="hideTip(event, 'fs294', 890)" onmouseover="showTip(event, 'fs294', 890)" class="i">processCommand</span> (<span onmouseout="hideTip(event, 'fs266', 891)" onmouseover="showTip(event, 'fs266', 891)" class="i">data</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 892)" onmouseover="showTip(event, 'fs188', 892)" class="i">PeerData</span>) (<span onmouseout="hideTip(event, 'fs267', 893)" onmouseover="showTip(event, 'fs267', 893)" class="i">command</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs65', 894)" onmouseover="showTip(event, 'fs65', 894)" class="i">PeerCommand</span>)<span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 895)" onmouseover="showTip(event, 'fs188', 895)" class="i">PeerData</span> <span class="o">=</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs230', 896)" onmouseover="showTip(event, 'fs230', 896)" class="i">peerQueues</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs266', 897)" onmouseover="showTip(event, 'fs266', 897)" class="i">data</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs189', 898)" onmouseover="showTip(event, 'fs189', 898)" class="i">Queues</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs296', 899)" onmouseover="showTip(event, 'fs296', 899)" class="i">Value</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs267', 900)" onmouseover="showTip(event, 'fs267', 900)" class="i">command</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs69', 901)" onmouseover="showTip(event, 'fs69', 901)" class="i">Execute</span> <span onmouseout="hideTip(event, 'fs297', 902)" onmouseover="showTip(event, 'fs297', 902)" class="i">message</span> <span class="k">-&gt;</span> 
            (<span onmouseout="hideTip(event, 'fs230', 903)" onmouseover="showTip(event, 'fs230', 903)" class="i">peerQueues</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs33', 904)" onmouseover="showTip(event, 'fs33', 904)" class="i">IPeerSend</span>)<span class="o">.</span><span class="i">Send</span>(<span onmouseout="hideTip(event, 'fs297', 905)" onmouseover="showTip(event, 'fs297', 905)" class="i">message</span>)
            <span onmouseout="hideTip(event, 'fs266', 906)" onmouseover="showTip(event, 'fs266', 906)" class="i">data</span>
        | <span onmouseout="hideTip(event, 'fs65', 907)" onmouseover="showTip(event, 'fs65', 907)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs70', 908)" onmouseover="showTip(event, 'fs70', 908)" class="i">GetHeaders</span> (<span onmouseout="hideTip(event, 'fs255', 909)" onmouseover="showTip(event, 'fs255', 909)" class="i">gh</span>, <span onmouseout="hideTip(event, 'fs298', 910)" onmouseover="showTip(event, 'fs298', 910)" class="i">ts</span>, _) <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs299', 911)" onmouseover="showTip(event, 'fs299', 911)" class="i">sendObs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs229', 912)" onmouseover="showTip(event, 'fs229', 912)" class="i">sendMessageObs</span> <span onmouseout="hideTip(event, 'fs230', 913)" onmouseover="showTip(event, 'fs230', 913)" class="i">peerQueues</span> (<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 914)" onmouseover="showTip(event, 'fs88', 914)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">getheaders</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs255', 915)" onmouseover="showTip(event, 'fs255', 915)" class="i">gh</span><span class="o">.</span><span class="i">ToByteArray</span>()))
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs300', 916)" onmouseover="showTip(event, 'fs300', 916)" class="i">obs</span> <span class="o">=</span> 
                <span onmouseout="hideTip(event, 'fs13', 917)" onmouseover="showTip(event, 'fs13', 917)" class="i">Observable</span>
                    <span class="o">.</span><span onmouseout="hideTip(event, 'fs282', 918)" onmouseover="showTip(event, 'fs282', 918)" class="i">Timeout</span>(<span onmouseout="hideTip(event, 'fs299', 919)" onmouseover="showTip(event, 'fs299', 919)" class="i">sendObs</span><span class="o">.</span><span class="i">Concat</span>(<span onmouseout="hideTip(event, 'fs204', 920)" onmouseover="showTip(event, 'fs204', 920)" class="i">headersIncoming</span>), <span class="i">commandTimeout</span>)
            <span onmouseout="hideTip(event, 'fs298', 921)" onmouseover="showTip(event, 'fs298', 921)" class="i">ts</span><span class="o">.</span><span class="i">SetResult</span>(<span onmouseout="hideTip(event, 'fs300', 922)" onmouseover="showTip(event, 'fs300', 922)" class="i">obs</span>)
            { <span onmouseout="hideTip(event, 'fs266', 923)" onmouseover="showTip(event, 'fs266', 923)" class="i">data</span> <span class="k">with</span> <span class="i">State</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs16', 924)" onmouseover="showTip(event, 'fs16', 924)" class="i">PeerState</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 925)" onmouseover="showTip(event, 'fs19', 925)" class="i">Busy</span> }
        | <span onmouseout="hideTip(event, 'fs65', 926)" onmouseover="showTip(event, 'fs65', 926)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs74', 927)" onmouseover="showTip(event, 'fs74', 927)" class="i">DownloadBlocks</span> (<span onmouseout="hideTip(event, 'fs252', 928)" onmouseover="showTip(event, 'fs252', 928)" class="i">gd</span>, <span onmouseout="hideTip(event, 'fs301', 929)" onmouseover="showTip(event, 'fs301', 929)" class="i">ts</span>) <span class="k">-&gt;</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs302', 930)" onmouseover="showTip(event, 'fs302', 930)" class="i">blocksPending</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs303', 931)" onmouseover="showTip(event, 'fs303', 931)" class="i">HashSet</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs75', 932)" onmouseover="showTip(event, 'fs75', 932)" class="i">byte</span>[]<span class="o">&gt;</span>(<span onmouseout="hideTip(event, 'fs252', 933)" onmouseover="showTip(event, 'fs252', 933)" class="i">gd</span><span class="o">.</span><span class="i">Invs</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs138', 934)" onmouseover="showTip(event, 'fs138', 934)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs149', 935)" onmouseover="showTip(event, 'fs149', 935)" class="i">map</span>(<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs304', 936)" onmouseover="showTip(event, 'fs304', 936)" class="i">inv</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs304', 937)" onmouseover="showTip(event, 'fs304', 937)" class="i">inv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs109', 938)" onmouseover="showTip(event, 'fs109', 938)" class="i">Hash</span>), <span class="k">new</span> <span class="i">HashCompare</span>())
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs299', 939)" onmouseover="showTip(event, 'fs299', 939)" class="i">sendObs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs229', 940)" onmouseover="showTip(event, 'fs229', 940)" class="i">sendMessageObs</span> <span onmouseout="hideTip(event, 'fs230', 941)" onmouseover="showTip(event, 'fs230', 941)" class="i">peerQueues</span> (<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 942)" onmouseover="showTip(event, 'fs88', 942)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">getdata</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs252', 943)" onmouseover="showTip(event, 'fs252', 943)" class="i">gd</span><span class="o">.</span><span class="i">ToByteArray</span>()))
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs305', 944)" onmouseover="showTip(event, 'fs305', 944)" class="i">count</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs302', 945)" onmouseover="showTip(event, 'fs302', 945)" class="i">blocksPending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs306', 946)" onmouseover="showTip(event, 'fs306', 946)" class="i">Count</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs307', 947)" onmouseover="showTip(event, 'fs307', 947)" class="i">obs</span> <span class="o">=</span> 
                <span onmouseout="hideTip(event, 'fs13', 948)" onmouseover="showTip(event, 'fs13', 948)" class="i">Observable</span>
                    <span class="o">.</span><span onmouseout="hideTip(event, 'fs282', 949)" onmouseover="showTip(event, 'fs282', 949)" class="i">Timeout</span>(<span onmouseout="hideTip(event, 'fs299', 950)" onmouseover="showTip(event, 'fs299', 950)" class="i">sendObs</span><span class="o">.</span><span class="i">Concat</span>(<span onmouseout="hideTip(event, 'fs205', 951)" onmouseover="showTip(event, 'fs205', 951)" class="i">blockIncoming</span>), <span class="i">commandTimeout</span>)
                    <span class="o">.</span><span class="i">Where</span>(<span class="k">fun</span> (<span class="i">b</span>, _) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs302', 952)" onmouseover="showTip(event, 'fs302', 952)" class="i">blocksPending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs308', 953)" onmouseover="showTip(event, 'fs308', 953)" class="i">Contains</span> <span class="i">b</span><span class="o">.</span><span class="i">Header</span><span class="o">.</span><span class="i">Hash</span>)
                    <span class="o">.</span><span class="i">Take</span>(<span onmouseout="hideTip(event, 'fs305', 954)" onmouseover="showTip(event, 'fs305', 954)" class="i">count</span>)
            <span onmouseout="hideTip(event, 'fs301', 955)" onmouseover="showTip(event, 'fs301', 955)" class="i">ts</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs309', 956)" onmouseover="showTip(event, 'fs309', 956)" class="i">SetResult</span>(<span onmouseout="hideTip(event, 'fs195', 957)" onmouseover="showTip(event, 'fs195', 957)" class="i">self</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs58', 958)" onmouseover="showTip(event, 'fs58', 958)" class="i">IPeer</span>, <span onmouseout="hideTip(event, 'fs307', 959)" onmouseover="showTip(event, 'fs307', 959)" class="i">obs</span>)
            { <span onmouseout="hideTip(event, 'fs266', 960)" onmouseover="showTip(event, 'fs266', 960)" class="i">data</span> <span class="k">with</span> <span class="i">State</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs16', 961)" onmouseover="showTip(event, 'fs16', 961)" class="i">PeerState</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 962)" onmouseover="showTip(event, 'fs19', 962)" class="i">Busy</span> }
        | <span onmouseout="hideTip(event, 'fs65', 963)" onmouseover="showTip(event, 'fs65', 963)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs77', 964)" onmouseover="showTip(event, 'fs77', 964)" class="i">SetReady</span> <span class="k">-&gt;</span> 
            <span class="k">if</span> <span onmouseout="hideTip(event, 'fs266', 965)" onmouseover="showTip(event, 'fs266', 965)" class="i">data</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs190', 966)" onmouseover="showTip(event, 'fs190', 966)" class="i">State</span> <span class="o">&lt;&gt;</span> <span onmouseout="hideTip(event, 'fs16', 967)" onmouseover="showTip(event, 'fs16', 967)" class="i">PeerState</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 968)" onmouseover="showTip(event, 'fs18', 968)" class="i">Ready</span> <span class="k">then</span>
                <span onmouseout="hideTip(event, 'fs106', 969)" onmouseover="showTip(event, 'fs106', 969)" class="i">trackerIncoming</span><span class="o">.</span><span class="i">OnNext</span> (<span onmouseout="hideTip(event, 'fs81', 970)" onmouseover="showTip(event, 'fs81', 970)" class="i">TrackerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs85', 971)" onmouseover="showTip(event, 'fs85', 971)" class="i">SetReady</span> <span onmouseout="hideTip(event, 'fs194', 972)" onmouseover="showTip(event, 'fs194', 972)" class="i">id</span>)
            { <span onmouseout="hideTip(event, 'fs266', 973)" onmouseover="showTip(event, 'fs266', 973)" class="i">data</span> <span class="k">with</span> <span class="i">State</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs16', 974)" onmouseover="showTip(event, 'fs16', 974)" class="i">PeerState</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 975)" onmouseover="showTip(event, 'fs18', 975)" class="i">Ready</span> }
        | <span onmouseout="hideTip(event, 'fs76', 976)" onmouseover="showTip(event, 'fs76', 976)" class="i">GetData</span> (<span onmouseout="hideTip(event, 'fs252', 977)" onmouseover="showTip(event, 'fs252', 977)" class="i">gd</span>) <span class="k">-&gt;</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs299', 978)" onmouseover="showTip(event, 'fs299', 978)" class="i">sendObs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs229', 979)" onmouseover="showTip(event, 'fs229', 979)" class="i">sendMessageObs</span> <span onmouseout="hideTip(event, 'fs230', 980)" onmouseover="showTip(event, 'fs230', 980)" class="i">peerQueues</span> (<span class="k">new</span> <span onmouseout="hideTip(event, 'fs88', 981)" onmouseover="showTip(event, 'fs88', 981)" class="i">BitcoinMessage</span>(<span class="s">&quot;</span><span class="s">getdata</span><span class="s">&quot;</span>, <span onmouseout="hideTip(event, 'fs252', 982)" onmouseover="showTip(event, 'fs252', 982)" class="i">gd</span><span class="o">.</span><span class="i">ToByteArray</span>()))
            <span onmouseout="hideTip(event, 'fs13', 983)" onmouseover="showTip(event, 'fs13', 983)" class="i">Observable</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs282', 984)" onmouseover="showTip(event, 'fs282', 984)" class="i">Timeout</span>(<span onmouseout="hideTip(event, 'fs299', 985)" onmouseover="showTip(event, 'fs299', 985)" class="i">sendObs</span>, <span class="i">commandTimeout</span>)<span class="o">.</span><span class="i">Subscribe</span>(<span class="i">onNext</span> <span class="o">=</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs144', 986)" onmouseover="showTip(event, 'fs144', 986)" class="i">ignore</span>()), <span class="i">onError</span> <span class="o">=</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs228', 987)" onmouseover="showTip(event, 'fs228', 987)" class="i">badPeer</span>())) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs144', 988)" onmouseover="showTip(event, 'fs144', 988)" class="i">ignore</span>
            <span onmouseout="hideTip(event, 'fs266', 989)" onmouseover="showTip(event, 'fs266', 989)" class="i">data</span>
        | <span onmouseout="hideTip(event, 'fs80', 990)" onmouseover="showTip(event, 'fs80', 990)" class="i">UpdateScore</span> <span onmouseout="hideTip(event, 'fs310', 991)" onmouseover="showTip(event, 'fs310', 991)" class="i">score</span> <span class="k">-&gt;</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs311', 992)" onmouseover="showTip(event, 'fs311', 992)" class="i">newData</span> <span class="o">=</span> { <span onmouseout="hideTip(event, 'fs266', 993)" onmouseover="showTip(event, 'fs266', 993)" class="i">data</span> <span class="k">with</span> <span class="i">Score</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs266', 994)" onmouseover="showTip(event, 'fs266', 994)" class="i">data</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs191', 995)" onmouseover="showTip(event, 'fs191', 995)" class="i">Score</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs310', 996)" onmouseover="showTip(event, 'fs310', 996)" class="i">score</span> }
            <span class="k">if</span> <span onmouseout="hideTip(event, 'fs311', 997)" onmouseover="showTip(event, 'fs311', 997)" class="i">newData</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs191', 998)" onmouseover="showTip(event, 'fs191', 998)" class="i">Score</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs203', 999)" onmouseover="showTip(event, 'fs203', 999)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 1000)" onmouseover="showTip(event, 'fs226', 1000)" class="i">Trigger</span>(<span onmouseout="hideTip(event, 'fs65', 1001)" onmouseover="showTip(event, 'fs65', 1001)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs78', 1002)" onmouseover="showTip(event, 'fs78', 1002)" class="i">Close</span>)
            <span onmouseout="hideTip(event, 'fs311', 1003)" onmouseover="showTip(event, 'fs311', 1003)" class="i">newData</span>
        | <span onmouseout="hideTip(event, 'fs65', 1004)" onmouseover="showTip(event, 'fs65', 1004)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs78', 1005)" onmouseover="showTip(event, 'fs78', 1005)" class="i">Close</span> <span class="k">-&gt;</span> 
            <span class="i">logger</span><span class="o">.</span><span class="i">DebugF</span> <span class="s">&quot;</span><span class="s">Closing</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs197', 1006)" onmouseover="showTip(event, 'fs197', 1006)" class="i">target</span>
            <span onmouseout="hideTip(event, 'fs106', 1007)" onmouseover="showTip(event, 'fs106', 1007)" class="i">trackerIncoming</span><span class="o">.</span><span class="i">OnNext</span>(<span onmouseout="hideTip(event, 'fs81', 1008)" onmouseover="showTip(event, 'fs81', 1008)" class="i">TrackerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs87', 1009)" onmouseover="showTip(event, 'fs87', 1009)" class="i">Close</span> <span onmouseout="hideTip(event, 'fs194', 1010)" onmouseover="showTip(event, 'fs194', 1010)" class="i">id</span>)
            { <span onmouseout="hideTip(event, 'fs266', 1011)" onmouseover="showTip(event, 'fs266', 1011)" class="i">data</span> <span class="k">with</span> <span class="i">CommandHandler</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs295', 1012)" onmouseover="showTip(event, 'fs295', 1012)" class="i">processClosing</span> }</pre>
</td>
</tr>
</table>

<p>Finally, <code>processClosing</code> handles the cleanup. Tom will not send further requests to this peer but there still may be 
outstanding message in the pipeline. They must be cleared gracefully otherwise someone could end up waiting for their 
result forever.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">and</span> <span onmouseout="hideTip(event, 'fs295', 1013)" onmouseover="showTip(event, 'fs295', 1013)" class="i">processClosing</span> (<span onmouseout="hideTip(event, 'fs266', 1014)" onmouseover="showTip(event, 'fs266', 1014)" class="i">data</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 1015)" onmouseover="showTip(event, 'fs188', 1015)" class="i">PeerData</span>) (<span onmouseout="hideTip(event, 'fs267', 1016)" onmouseover="showTip(event, 'fs267', 1016)" class="i">command</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs65', 1017)" onmouseover="showTip(event, 'fs65', 1017)" class="i">PeerCommand</span>)<span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 1018)" onmouseover="showTip(event, 'fs188', 1018)" class="i">PeerData</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs267', 1019)" onmouseover="showTip(event, 'fs267', 1019)" class="i">command</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs79', 1020)" onmouseover="showTip(event, 'fs79', 1020)" class="i">Closed</span> <span class="k">-&gt;</span> 
            (<span onmouseout="hideTip(event, 'fs195', 1021)" onmouseover="showTip(event, 'fs195', 1021)" class="i">self</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs46', 1022)" onmouseover="showTip(event, 'fs46', 1022)" class="i">IDisposable</span>)<span class="o">.</span><span class="i">Dispose</span>() <span class="c">// Dispose completes the queues</span>
            { <span onmouseout="hideTip(event, 'fs266', 1023)" onmouseover="showTip(event, 'fs266', 1023)" class="i">data</span> <span class="k">with</span> <span class="i">State</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs16', 1024)" onmouseover="showTip(event, 'fs16', 1024)" class="i">PeerState</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 1025)" onmouseover="showTip(event, 'fs20', 1025)" class="i">Closed</span>; <span class="i">Queues</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 1026)" onmouseover="showTip(event, 'fs152', 1026)" class="i">None</span>; <span class="i">CommandHandler</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs265', 1027)" onmouseover="showTip(event, 'fs265', 1027)" class="i">processConnection</span> }
        | <span onmouseout="hideTip(event, 'fs65', 1028)" onmouseover="showTip(event, 'fs65', 1028)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs70', 1029)" onmouseover="showTip(event, 'fs70', 1029)" class="i">GetHeaders</span> (<span onmouseout="hideTip(event, 'fs255', 1030)" onmouseover="showTip(event, 'fs255', 1030)" class="i">gh</span>, <span onmouseout="hideTip(event, 'fs298', 1031)" onmouseover="showTip(event, 'fs298', 1031)" class="i">ts</span>, _) <span class="k">-&gt;</span>
            <span onmouseout="hideTip(event, 'fs298', 1032)" onmouseover="showTip(event, 'fs298', 1032)" class="i">ts</span><span class="o">.</span><span class="i">SetResult</span>(<span onmouseout="hideTip(event, 'fs13', 1033)" onmouseover="showTip(event, 'fs13', 1033)" class="i">Observable</span><span class="o">.</span><span class="i">Empty</span>())
            <span onmouseout="hideTip(event, 'fs266', 1034)" onmouseover="showTip(event, 'fs266', 1034)" class="i">data</span>
        | <span onmouseout="hideTip(event, 'fs65', 1035)" onmouseover="showTip(event, 'fs65', 1035)" class="i">PeerCommand</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs74', 1036)" onmouseover="showTip(event, 'fs74', 1036)" class="i">DownloadBlocks</span> (<span onmouseout="hideTip(event, 'fs252', 1037)" onmouseover="showTip(event, 'fs252', 1037)" class="i">gd</span>, <span onmouseout="hideTip(event, 'fs301', 1038)" onmouseover="showTip(event, 'fs301', 1038)" class="i">ts</span>) <span class="k">-&gt;</span>
            <span onmouseout="hideTip(event, 'fs301', 1039)" onmouseover="showTip(event, 'fs301', 1039)" class="i">ts</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs309', 1040)" onmouseover="showTip(event, 'fs309', 1040)" class="i">SetResult</span>(<span onmouseout="hideTip(event, 'fs195', 1041)" onmouseover="showTip(event, 'fs195', 1041)" class="i">self</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, 'fs58', 1042)" onmouseover="showTip(event, 'fs58', 1042)" class="i">IPeer</span>, <span onmouseout="hideTip(event, 'fs13', 1043)" onmouseover="showTip(event, 'fs13', 1043)" class="i">Observable</span><span class="o">.</span><span class="i">Empty</span>())
            <span onmouseout="hideTip(event, 'fs266', 1044)" onmouseover="showTip(event, 'fs266', 1044)" class="i">data</span>
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs266', 1045)" onmouseover="showTip(event, 'fs266', 1045)" class="i">data</span>

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs312', 1046)" onmouseover="showTip(event, 'fs312', 1046)" class="i">initialState</span> <span class="o">=</span> { <span class="i">State</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs16', 1047)" onmouseover="showTip(event, 'fs16', 1047)" class="i">PeerState</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 1048)" onmouseover="showTip(event, 'fs20', 1048)" class="i">Closed</span>; <span class="i">Score</span> <span class="o">=</span> <span class="n">100</span>; <span class="i">Queues</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs152', 1049)" onmouseover="showTip(event, 'fs152', 1049)" class="i">None</span>; <span class="i">CommandHandler</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs265', 1050)" onmouseover="showTip(event, 'fs265', 1050)" class="i">processConnection</span> }
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs313', 1051)" onmouseover="showTip(event, 'fs313', 1051)" class="i">runHandler</span> (<span onmouseout="hideTip(event, 'fs266', 1052)" onmouseover="showTip(event, 'fs266', 1052)" class="i">data</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs188', 1053)" onmouseover="showTip(event, 'fs188', 1053)" class="i">PeerData</span>) (<span onmouseout="hideTip(event, 'fs267', 1054)" onmouseover="showTip(event, 'fs267', 1054)" class="i">command</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs65', 1055)" onmouseover="showTip(event, 'fs65', 1055)" class="i">PeerCommand</span>) <span class="o">=</span> 
        <span class="c">// logger.DebugF &quot;PeerCommand&gt; %A&quot; command</span>
        <span onmouseout="hideTip(event, 'fs266', 1056)" onmouseover="showTip(event, 'fs266', 1056)" class="i">data</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs192', 1057)" onmouseover="showTip(event, 'fs192', 1057)" class="i">CommandHandler</span> <span onmouseout="hideTip(event, 'fs266', 1058)" onmouseover="showTip(event, 'fs266', 1058)" class="i">data</span> <span onmouseout="hideTip(event, 'fs267', 1059)" onmouseover="showTip(event, 'fs267', 1059)" class="i">command</span>

    <span class="k">do</span>
        <span onmouseout="hideTip(event, 'fs196', 1060)" onmouseover="showTip(event, 'fs196', 1060)" class="i">disposable</span><span class="o">.</span><span class="i">Add</span>(
            <span onmouseout="hideTip(event, 'fs206', 1061)" onmouseover="showTip(event, 'fs206', 1061)" class="i">incomingEvent</span>
                <span class="o">.</span><span class="i">ObserveOn</span>(<span class="i">ThreadPoolScheduler</span><span class="o">.</span><span class="i">Instance</span>)
                <span class="o">.</span><span class="i">Scan</span>(<span onmouseout="hideTip(event, 'fs312', 1062)" onmouseover="showTip(event, 'fs312', 1062)" class="i">initialState</span>, <span class="k">new</span> <span onmouseout="hideTip(event, 'fs314', 1063)" onmouseover="showTip(event, 'fs314', 1063)" class="i">Func</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs188', 1064)" onmouseover="showTip(event, 'fs188', 1064)" class="i">PeerData</span>, <span onmouseout="hideTip(event, 'fs65', 1065)" onmouseover="showTip(event, 'fs65', 1065)" class="i">PeerCommand</span>, <span onmouseout="hideTip(event, 'fs188', 1066)" onmouseover="showTip(event, 'fs188', 1066)" class="i">PeerData</span><span class="o">&gt;</span>(<span class="i">runHandler</span>))
                <span class="o">.</span><span class="i">Subscribe</span>())

    <span class="k">interface</span> <span onmouseout="hideTip(event, 'fs46', 1067)" onmouseover="showTip(event, 'fs46', 1067)" class="i">IDisposable</span> <span class="k">with</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs315', 1068)" onmouseover="showTip(event, 'fs315', 1068)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs316', 1069)" onmouseover="showTip(event, 'fs316', 1069)" class="i">Dispose</span>() <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs196', 1070)" onmouseover="showTip(event, 'fs196', 1070)" class="i">disposable</span><span class="o">.</span><span class="i">Dispose</span>()

    <span class="k">interface</span> <span onmouseout="hideTip(event, 'fs58', 1071)" onmouseover="showTip(event, 'fs58', 1071)" class="i">IPeer</span> <span class="k">with</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs315', 1072)" onmouseover="showTip(event, 'fs315', 1072)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs317', 1073)" onmouseover="showTip(event, 'fs317', 1073)" class="i">Ready</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs225', 1074)" onmouseover="showTip(event, 'fs225', 1074)" class="i">readyPeer</span>()
        <span class="k">member</span> <span class="k">val</span> <span class="i">Id</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs194', 1075)" onmouseover="showTip(event, 'fs194', 1075)" class="i">id</span> <span class="k">with</span> <span class="i">get</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs315', 1076)" onmouseover="showTip(event, 'fs315', 1076)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs318', 1077)" onmouseover="showTip(event, 'fs318', 1077)" class="i">Target</span> <span class="k">with</span> <span class="i">get</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs197', 1078)" onmouseover="showTip(event, 'fs197', 1078)" class="i">target</span> <span class="c">// For diagnostics only</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs315', 1079)" onmouseover="showTip(event, 'fs315', 1079)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs319', 1080)" onmouseover="showTip(event, 'fs319', 1080)" class="i">Bad</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs228', 1081)" onmouseover="showTip(event, 'fs228', 1081)" class="i">badPeer</span>()
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs315', 1082)" onmouseover="showTip(event, 'fs315', 1082)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs320', 1083)" onmouseover="showTip(event, 'fs320', 1083)" class="i">Receive</span> <span onmouseout="hideTip(event, 'fs321', 1084)" onmouseover="showTip(event, 'fs321', 1084)" class="i">m</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs203', 1085)" onmouseover="showTip(event, 'fs203', 1085)" class="i">incoming</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs226', 1086)" onmouseover="showTip(event, 'fs226', 1086)" class="i">Trigger</span> <span onmouseout="hideTip(event, 'fs321', 1087)" onmouseover="showTip(event, 'fs321', 1087)" class="i">m</span>

    <span class="k">override</span> <span onmouseout="hideTip(event, 'fs315', 1088)" onmouseover="showTip(event, 'fs315', 1088)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs322', 1089)" onmouseover="showTip(event, 'fs322', 1089)" class="i">ToString</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs117', 1090)" onmouseover="showTip(event, 'fs117', 1090)" class="i">sprintf</span> <span class="s">&quot;</span><span class="s">Peer</span><span class="s">(</span><span class="s">%</span><span class="s">d</span><span class="s">,</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">,</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">)</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs194', 1091)" onmouseover="showTip(event, 'fs194', 1091)" class="i">id</span> <span onmouseout="hideTip(event, 'fs197', 1092)" onmouseover="showTip(event, 'fs197', 1092)" class="i">target</span> <span onmouseout="hideTip(event, 'fs198', 1093)" onmouseover="showTip(event, 'fs198', 1093)" class="i">versionMessage</span></pre>
</td>
</tr>
</table>

<h3>Bootstrap from DNS</h3>

<p>Clear peers that are older than 3h and do a DNS request to the known seed nodes if the database has less than 1000 peers</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs323', 1094)" onmouseover="showTip(event, 'fs323', 1094)" class="i">dropOldPeers</span>() <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs324', 1095)" onmouseover="showTip(event, 'fs324', 1095)" class="i">dts</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs248', 1096)" onmouseover="showTip(event, 'fs248', 1096)" class="i">DateTime</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs249', 1097)" onmouseover="showTip(event, 'fs249', 1097)" class="i">UtcNow</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs325', 1098)" onmouseover="showTip(event, 'fs325', 1098)" class="i">AddHours</span>(<span class="o">-</span><span class="n">3.0</span>)
    <span class="i">Db</span><span class="o">.</span><span class="i">dropOldPeers</span> <span onmouseout="hideTip(event, 'fs324', 1099)" onmouseover="showTip(event, 'fs324', 1099)" class="i">dts</span>
    <span class="i">Db</span><span class="o">.</span><span class="i">resetState</span>()

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs326', 1100)" onmouseover="showTip(event, 'fs326', 1100)" class="i">bootstrapPeers</span>() <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs272', 1101)" onmouseover="showTip(event, 'fs272', 1101)" class="i">async</span> {
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs247', 1102)" onmouseover="showTip(event, 'fs247', 1102)" class="i">now</span> <span class="o">=</span> <span class="i">NodaTime</span><span class="o">.</span><span class="i">Instant</span><span class="o">.</span><span class="i">FromDateTimeUtc</span>(<span onmouseout="hideTip(event, 'fs248', 1103)" onmouseover="showTip(event, 'fs248', 1103)" class="i">DateTime</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs249', 1104)" onmouseover="showTip(event, 'fs249', 1104)" class="i">UtcNow</span>)
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs327', 1105)" onmouseover="showTip(event, 'fs327', 1105)" class="i">port</span> <span class="o">=</span> <span class="k">if</span> <span class="i">settings</span><span class="o">.</span><span class="i">TestNet</span> <span class="k">then</span> <span class="n">18444</span> <span class="k">else</span> <span class="n">8333</span>

        <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs328', 1106)" onmouseover="showTip(event, 'fs328', 1106)" class="i">entry</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs275', 1107)" onmouseover="showTip(event, 'fs275', 1107)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs329', 1108)" onmouseover="showTip(event, 'fs329', 1108)" class="i">AwaitTask</span>(<span onmouseout="hideTip(event, 'fs330', 1109)" onmouseover="showTip(event, 'fs330', 1109)" class="i">Dns</span><span class="o">.</span><span class="i">GetHostEntryAsync</span>(<span class="s">&quot;</span><span class="s">seed</span><span class="s">.</span><span class="s">bitnodes</span><span class="s">.</span><span class="s">io</span><span class="s">&quot;</span>))
        <span class="k">for</span> <span onmouseout="hideTip(event, 'fs331', 1110)" onmouseover="showTip(event, 'fs331', 1110)" class="i">peer</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs328', 1111)" onmouseover="showTip(event, 'fs328', 1111)" class="i">entry</span><span class="o">.</span><span class="i">AddressList</span> <span class="k">do</span>
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs250', 1112)" onmouseover="showTip(event, 'fs250', 1112)" class="i">addr</span> <span class="o">=</span> { <span class="i">Timestamp</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs60', 1113)" onmouseover="showTip(event, 'fs60', 1113)" class="i">int</span> (<span onmouseout="hideTip(event, 'fs247', 1114)" onmouseover="showTip(event, 'fs247', 1114)" class="i">now</span><span class="o">.</span><span class="i">Ticks</span> <span class="o">/</span> <span class="i">NodaConstants</span><span class="o">.</span><span class="i">TicksPerSecond</span>); <span class="i">Address</span> <span class="o">=</span> <span class="k">new</span> <span class="i">NetworkAddr</span>(<span class="k">new</span> <span onmouseout="hideTip(event, 'fs41', 1115)" onmouseover="showTip(event, 'fs41', 1115)" class="i">IPEndPoint</span>(<span onmouseout="hideTip(event, 'fs331', 1116)" onmouseover="showTip(event, 'fs331', 1116)" class="i">peer</span><span class="o">.</span><span class="i">MapToIPv4</span>(), <span onmouseout="hideTip(event, 'fs15', 1117)" onmouseover="showTip(event, 'fs15', 1117)" class="i">defaultPort</span>)) }
            <span class="i">Db</span><span class="o">.</span><span class="i">updateAddr</span> <span onmouseout="hideTip(event, 'fs250', 1118)" onmouseover="showTip(event, 'fs250', 1118)" class="i">addr</span>
        } <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs275', 1119)" onmouseover="showTip(event, 'fs275', 1119)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs332', 1120)" onmouseover="showTip(event, 'fs332', 1120)" class="i">StartImmediate</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs333', 1121)" onmouseover="showTip(event, 'fs333', 1121)" class="i">initPeers</span>() <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs323', 1122)" onmouseover="showTip(event, 'fs323', 1122)" class="i">dropOldPeers</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs334', 1123)" onmouseover="showTip(event, 'fs334', 1123)" class="i">peers</span> <span class="o">=</span> <span class="i">Db</span><span class="o">.</span><span class="i">getPeers</span>()
    <span class="k">if</span> <span onmouseout="hideTip(event, 'fs334', 1124)" onmouseover="showTip(event, 'fs334', 1124)" class="i">peers</span><span class="o">.</span><span class="i">Length</span> <span class="o">&lt;</span> <span class="n">1000</span> <span class="k">then</span>
        <span onmouseout="hideTip(event, 'fs326', 1125)" onmouseover="showTip(event, 'fs326', 1125)" class="i">bootstrapPeers</span>()</pre>
</td>
</tr>
</table>

          <div class="tip" id="fs1">module Peer</div>
<div class="tip" id="fs2">namespace System</div>
<div class="tip" id="fs3">namespace System.IO</div>
<div class="tip" id="fs4">namespace System.Collections</div>
<div class="tip" id="fs5">namespace System.Collections.Generic</div>
<div class="tip" id="fs6">namespace System.Linq</div>
<div class="tip" id="fs7">namespace System.Net</div>
<div class="tip" id="fs8">namespace System.Net.Sockets</div>
<div class="tip" id="fs9">Multiple items<br />namespace System.Linq<br /><br />--------------------<br />namespace Microsoft.FSharp.Linq</div>
<div class="tip" id="fs10">namespace System.Threading</div>
<div class="tip" id="fs11">namespace System.Threading.Tasks</div>
<div class="tip" id="fs12">namespace Microsoft.FSharp.Control</div>
<div class="tip" id="fs13">module Observable<br /><br />from Microsoft.FSharp.Control</div>
<div class="tip" id="fs14">Multiple items<br />type Choice&lt;&#39;T1,&#39;T2&gt; =<br />&#160;&#160;| Choice1Of2 of &#39;T1<br />&#160;&#160;| Choice2Of2 of &#39;T2<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3&gt; =<br />&#160;&#160;| Choice1Of3 of &#39;T1<br />&#160;&#160;| Choice2Of3 of &#39;T2<br />&#160;&#160;| Choice3Of3 of &#39;T3<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4&gt; =<br />&#160;&#160;| Choice1Of4 of &#39;T1<br />&#160;&#160;| Choice2Of4 of &#39;T2<br />&#160;&#160;| Choice3Of4 of &#39;T3<br />&#160;&#160;| Choice4Of4 of &#39;T4<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5&gt; =<br />&#160;&#160;| Choice1Of5 of &#39;T1<br />&#160;&#160;| Choice2Of5 of &#39;T2<br />&#160;&#160;| Choice3Of5 of &#39;T3<br />&#160;&#160;| Choice4Of5 of &#39;T4<br />&#160;&#160;| Choice5Of5 of &#39;T5<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6&gt; =<br />&#160;&#160;| Choice1Of6 of &#39;T1<br />&#160;&#160;| Choice2Of6 of &#39;T2<br />&#160;&#160;| Choice3Of6 of &#39;T3<br />&#160;&#160;| Choice4Of6 of &#39;T4<br />&#160;&#160;| Choice5Of6 of &#39;T5<br />&#160;&#160;| Choice6Of6 of &#39;T6<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Choice&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7&gt; =<br />&#160;&#160;| Choice1Of7 of &#39;T1<br />&#160;&#160;| Choice2Of7 of &#39;T2<br />&#160;&#160;| Choice3Of7 of &#39;T3<br />&#160;&#160;| Choice4Of7 of &#39;T4<br />&#160;&#160;| Choice5Of7 of &#39;T5<br />&#160;&#160;| Choice6Of7 of &#39;T6<br />&#160;&#160;| Choice7Of7 of &#39;T7<br /><br />Full name: Microsoft.FSharp.Core.Choice&lt;_,_,_,_,_,_,_&gt;</div>
<div class="tip" id="fs15">val defaultPort : obj<br /><br />Full name: Peer.defaultPort</div>
<div class="tip" id="fs16">type PeerState =<br />&#160;&#160;| Connected<br />&#160;&#160;| Ready<br />&#160;&#160;| Busy<br />&#160;&#160;| Closed<br /><br />Full name: Peer.PeerState</div>
<div class="tip" id="fs17">union case PeerState.Connected: PeerState</div>
<div class="tip" id="fs18">union case PeerState.Ready: PeerState</div>
<div class="tip" id="fs19">union case PeerState.Busy: PeerState</div>
<div class="tip" id="fs20">union case PeerState.Closed: PeerState</div>
<div class="tip" id="fs21">type TrackerPeerState =<br />&#160;&#160;| Allocated<br />&#160;&#160;| Ready<br />&#160;&#160;| Busy<br />&#160;&#160;| Free<br /><br />Full name: Peer.TrackerPeerState</div>
<div class="tip" id="fs22">union case TrackerPeerState.Allocated: TrackerPeerState</div>
<div class="tip" id="fs23">union case TrackerPeerState.Ready: TrackerPeerState</div>
<div class="tip" id="fs24">union case TrackerPeerState.Busy: TrackerPeerState</div>
<div class="tip" id="fs25">union case TrackerPeerState.Free: TrackerPeerState</div>
<div class="tip" id="fs26">type GetResult&lt;&#39;a&gt; = Choice&lt;&#39;a,exn&gt;<br /><br />Full name: Peer.GetResult&lt;_&gt;</div>
<div class="tip" id="fs27">type exn = Exception<br /><br />Full name: Microsoft.FSharp.Core.exn</div>
<div class="tip" id="fs28">val addrTopic : obj<br /><br />Full name: Peer.addrTopic</div>
<div class="tip" id="fs29">type BloomFilterUpdate =<br />&#160;&#160;| UpdateNone<br />&#160;&#160;| UpdateAll<br />&#160;&#160;| UpdateP2PubKeyOnly<br /><br />Full name: Peer.BloomFilterUpdate</div>
<div class="tip" id="fs30">union case BloomFilterUpdate.UpdateNone: BloomFilterUpdate</div>
<div class="tip" id="fs31">union case BloomFilterUpdate.UpdateAll: BloomFilterUpdate</div>
<div class="tip" id="fs32">union case BloomFilterUpdate.UpdateP2PubKeyOnly: BloomFilterUpdate</div>
<div class="tip" id="fs33">type IPeerSend =<br />&#160;&#160;interface<br />&#160;&#160;&#160;&#160;abstract member Receive : &#39;a0 -&gt; unit<br />&#160;&#160;&#160;&#160;abstract member Send : &#39;a0 -&gt; unit<br />&#160;&#160;end<br /><br />Full name: Peer.IPeerSend</div>
<div class="tip" id="fs34">abstract member IPeerSend.Receive : &#39;a0 -&gt; unit<br /><br />Full name: Peer.IPeerSend.Receive</div>
<div class="tip" id="fs35">type unit = Unit<br /><br />Full name: Microsoft.FSharp.Core.unit</div>
<div class="tip" id="fs36">abstract member IPeerSend.Send : &#39;a0 -&gt; unit<br /><br />Full name: Peer.IPeerSend.Send</div>
<div class="tip" id="fs37">Multiple items<br />type PeerQueues =<br />&#160;&#160;interface IPeerSend<br />&#160;&#160;interface IDisposable<br />&#160;&#160;new : stream:NetworkStream * target:IPEndPoint -&gt; PeerQueues<br />&#160;&#160;member add_From : obj -&gt; obj<br />&#160;&#160;member add_To : obj -&gt; obj<br />&#160;&#160;member From : obj<br />&#160;&#160;member To : obj<br />&#160;&#160;member remove_From : obj -&gt; obj<br />&#160;&#160;member remove_To : obj -&gt; obj<br /><br />Full name: Peer.PeerQueues<br /><br />--------------------<br />new : stream:NetworkStream * target:IPEndPoint -&gt; PeerQueues</div>
<div class="tip" id="fs38">val stream : NetworkStream</div>
<div class="tip" id="fs39">Multiple items<br />type NetworkStream =<br />&#160;&#160;inherit Stream<br />&#160;&#160;new : socket:Socket -&gt; NetworkStream + 3 overloads<br />&#160;&#160;member BeginRead : buffer:byte[] * offset:int * size:int * callback:AsyncCallback * state:obj -&gt; IAsyncResult<br />&#160;&#160;member BeginWrite : buffer:byte[] * offset:int * size:int * callback:AsyncCallback * state:obj -&gt; IAsyncResult<br />&#160;&#160;member CanRead : bool<br />&#160;&#160;member CanSeek : bool<br />&#160;&#160;member CanTimeout : bool<br />&#160;&#160;member CanWrite : bool<br />&#160;&#160;member Close : timeout:int -&gt; unit<br />&#160;&#160;member DataAvailable : bool<br />&#160;&#160;member EndRead : asyncResult:IAsyncResult -&gt; int<br />&#160;&#160;...<br /><br />Full name: System.Net.Sockets.NetworkStream<br /><br />--------------------<br />NetworkStream(socket: Socket) : unit<br />NetworkStream(socket: Socket, ownsSocket: bool) : unit<br />NetworkStream(socket: Socket, access: FileAccess) : unit<br />NetworkStream(socket: Socket, access: FileAccess, ownsSocket: bool) : unit</div>
<div class="tip" id="fs40">val target : IPEndPoint</div>
<div class="tip" id="fs41">Multiple items<br />type IPEndPoint =<br />&#160;&#160;inherit EndPoint<br />&#160;&#160;new : address:int64 * port:int -&gt; IPEndPoint + 1 overload<br />&#160;&#160;member Address : IPAddress with get, set<br />&#160;&#160;member AddressFamily : AddressFamily<br />&#160;&#160;member Create : socketAddress:SocketAddress -&gt; EndPoint<br />&#160;&#160;member Equals : comparand:obj -&gt; bool<br />&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;member Port : int with get, set<br />&#160;&#160;member Serialize : unit -&gt; SocketAddress<br />&#160;&#160;member ToString : unit -&gt; string<br />&#160;&#160;static val MinPort : int<br />&#160;&#160;...<br /><br />Full name: System.Net.IPEndPoint<br /><br />--------------------<br />IPEndPoint(address: int64, port: int) : unit<br />IPEndPoint(address: IPAddress, port: int) : unit</div>
<div class="tip" id="fs42">val fromPeer : obj</div>
<div class="tip" id="fs43">Multiple items<br />module Event<br /><br />from Microsoft.FSharp.Control<br /><br />--------------------<br />type Event&lt;&#39;T&gt; =<br />&#160;&#160;new : unit -&gt; Event&lt;&#39;T&gt;<br />&#160;&#160;member Trigger : arg:&#39;T -&gt; unit<br />&#160;&#160;member Publish : IEvent&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Event&lt;_&gt;<br /><br />--------------------<br />type Event&lt;&#39;Delegate,&#39;Args (requires delegate and &#39;Delegate :&gt; Delegate)&gt; =<br />&#160;&#160;new : unit -&gt; Event&lt;&#39;Delegate,&#39;Args&gt;<br />&#160;&#160;member Trigger : sender:obj * args:&#39;Args -&gt; unit<br />&#160;&#160;member Publish : IEvent&lt;&#39;Delegate,&#39;Args&gt;<br /><br />Full name: Microsoft.FSharp.Control.Event&lt;_,_&gt;<br /><br />--------------------<br />new : unit -&gt; Event&lt;&#39;T&gt;<br /><br />--------------------<br />new : unit -&gt; Event&lt;&#39;Delegate,&#39;Args&gt;</div>
<div class="tip" id="fs44">val toPeer : obj</div>
<div class="tip" id="fs45">val mutable disposed : bool</div>
<div class="tip" id="fs46">type IDisposable =<br />&#160;&#160;member Dispose : unit -&gt; unit<br /><br />Full name: System.IDisposable</div>
<div class="tip" id="fs47">val x : PeerQueues</div>
<div class="tip" id="fs48">override PeerQueues.Dispose : unit -&gt; unit<br /><br />Full name: Peer.PeerQueues.Dispose</div>
<div class="tip" id="fs49">Stream.Dispose() : unit</div>
<div class="tip" id="fs50">Multiple items<br />type CLIEventAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; CLIEventAttribute<br /><br />Full name: Microsoft.FSharp.Core.CLIEventAttribute<br /><br />--------------------<br />new : unit -&gt; CLIEventAttribute</div>
<div class="tip" id="fs51">member PeerQueues.From : obj<br /><br />Full name: Peer.PeerQueues.From</div>
<div class="tip" id="fs52">member PeerQueues.To : obj<br /><br />Full name: Peer.PeerQueues.To</div>
<div class="tip" id="fs53">override PeerQueues.Receive : message:&#39;b -&gt; unit<br /><br />Full name: Peer.PeerQueues.Receive</div>
<div class="tip" id="fs54">val message : &#39;b</div>
<div class="tip" id="fs55">val not : value:bool -&gt; bool<br /><br />Full name: Microsoft.FSharp.Core.Operators.not</div>
<div class="tip" id="fs56">override PeerQueues.Send : message:&#39;a -&gt; unit<br /><br />Full name: Peer.PeerQueues.Send</div>
<div class="tip" id="fs57">val message : &#39;a</div>
<div class="tip" id="fs58">type IPeer =<br />&#160;&#160;interface<br />&#160;&#160;&#160;&#160;abstract member Bad : unit -&gt; unit<br />&#160;&#160;&#160;&#160;abstract member Ready : unit -&gt; unit<br />&#160;&#160;&#160;&#160;abstract member Receive : PeerCommand -&gt; unit<br />&#160;&#160;&#160;&#160;abstract member Id : int<br />&#160;&#160;&#160;&#160;abstract member Target : IPEndPoint<br />&#160;&#160;end<br /><br />Full name: Peer.IPeer</div>
<div class="tip" id="fs59">abstract member IPeer.Id : int<br /><br />Full name: Peer.IPeer.Id</div>
<div class="tip" id="fs60">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs61">abstract member IPeer.Ready : unit -&gt; unit<br /><br />Full name: Peer.IPeer.Ready</div>
<div class="tip" id="fs62">abstract member IPeer.Bad : unit -&gt; unit<br /><br />Full name: Peer.IPeer.Bad</div>
<div class="tip" id="fs63">abstract member IPeer.Target : IPEndPoint<br /><br />Full name: Peer.IPeer.Target</div>
<div class="tip" id="fs64">abstract member IPeer.Receive : PeerCommand -&gt; unit<br /><br />Full name: Peer.IPeer.Receive</div>
<div class="tip" id="fs65">type PeerCommand =<br />&#160;&#160;| Open of target: IPEndPoint * tip: obj<br />&#160;&#160;| OpenStream of stream: NetworkStream * remote: IPEndPoint * tip: obj<br />&#160;&#160;| Handshaked<br />&#160;&#160;| Execute of message: obj<br />&#160;&#160;| GetHeaders of gh: obj * task: obj * IPeer<br />&#160;&#160;| GetBlocks of gb: obj * task: TaskCompletionSource&lt;IPeer * obj&gt; * IPeer<br />&#160;&#160;| DownloadBlocks of gd: obj * task: TaskCompletionSource&lt;IPeer * IObservable&lt;obj * byte []&gt;&gt;<br />&#160;&#160;| GetData of gd: obj<br />&#160;&#160;| SetReady<br />&#160;&#160;| Close<br />&#160;&#160;...<br /><br />Full name: Peer.PeerCommand</div>
<div class="tip" id="fs66">union case PeerCommand.Open: target: IPEndPoint * tip: obj -&gt; PeerCommand</div>
<div class="tip" id="fs67">union case PeerCommand.OpenStream: stream: NetworkStream * remote: IPEndPoint * tip: obj -&gt; PeerCommand</div>
<div class="tip" id="fs68">union case PeerCommand.Handshaked: PeerCommand</div>
<div class="tip" id="fs69">union case PeerCommand.Execute: message: obj -&gt; PeerCommand</div>
<div class="tip" id="fs70">union case PeerCommand.GetHeaders: gh: obj * task: obj * IPeer -&gt; PeerCommand</div>
<div class="tip" id="fs71">Multiple items<br />type TaskCompletionSource&lt;&#39;TResult&gt; =<br />&#160;&#160;new : unit -&gt; TaskCompletionSource&lt;&#39;TResult&gt; + 3 overloads<br />&#160;&#160;member SetCanceled : unit -&gt; unit<br />&#160;&#160;member SetException : exception:Exception -&gt; unit + 1 overload<br />&#160;&#160;member SetResult : result:&#39;TResult -&gt; unit<br />&#160;&#160;member Task : Task&lt;&#39;TResult&gt;<br />&#160;&#160;member TrySetCanceled : unit -&gt; bool<br />&#160;&#160;member TrySetException : exception:Exception -&gt; bool + 1 overload<br />&#160;&#160;member TrySetResult : result:&#39;TResult -&gt; bool<br /><br />Full name: System.Threading.Tasks.TaskCompletionSource&lt;_&gt;<br /><br />--------------------<br />TaskCompletionSource() : unit<br />TaskCompletionSource(creationOptions: TaskCreationOptions) : unit<br />TaskCompletionSource(state: obj) : unit<br />TaskCompletionSource(state: obj, creationOptions: TaskCreationOptions) : unit</div>
<div class="tip" id="fs72">type IObservable&lt;&#39;T&gt; =<br />&#160;&#160;member Subscribe : observer:IObserver&lt;&#39;T&gt; -&gt; IDisposable<br /><br />Full name: System.IObservable&lt;_&gt;</div>
<div class="tip" id="fs73">union case PeerCommand.GetBlocks: gb: obj * task: TaskCompletionSource&lt;IPeer * obj&gt; * IPeer -&gt; PeerCommand</div>
<div class="tip" id="fs74">union case PeerCommand.DownloadBlocks: gd: obj * task: TaskCompletionSource&lt;IPeer * IObservable&lt;obj * byte []&gt;&gt; -&gt; PeerCommand</div>
<div class="tip" id="fs75">Multiple items<br />val byte : value:&#39;T -&gt; byte (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.byte<br /><br />--------------------<br />type byte = Byte<br /><br />Full name: Microsoft.FSharp.Core.byte</div>
<div class="tip" id="fs76">union case PeerCommand.GetData: gd: obj -&gt; PeerCommand</div>
<div class="tip" id="fs77">union case PeerCommand.SetReady: PeerCommand</div>
<div class="tip" id="fs78">union case PeerCommand.Close: PeerCommand</div>
<div class="tip" id="fs79">union case PeerCommand.Closed: PeerCommand</div>
<div class="tip" id="fs80">union case PeerCommand.UpdateScore: score: int -&gt; PeerCommand</div>
<div class="tip" id="fs81">type TrackerCommand =<br />&#160;&#160;| GetPeers<br />&#160;&#160;| Connect of target: IPEndPoint<br />&#160;&#160;| IncomingConnection of stream: NetworkStream * target: IPEndPoint<br />&#160;&#160;| SetReady of id: int<br />&#160;&#160;| Close of int<br />&#160;&#160;| BitcoinMessage of message: obj<br />&#160;&#160;| Command of command: PeerCommand<br />&#160;&#160;| SetTip of tip: obj<br /><br />Full name: Peer.TrackerCommand</div>
<div class="tip" id="fs82">union case TrackerCommand.GetPeers: TrackerCommand</div>
<div class="tip" id="fs83">union case TrackerCommand.Connect: target: IPEndPoint -&gt; TrackerCommand</div>
<div class="tip" id="fs84">union case TrackerCommand.IncomingConnection: stream: NetworkStream * target: IPEndPoint -&gt; TrackerCommand</div>
<div class="tip" id="fs85">union case TrackerCommand.SetReady: id: int -&gt; TrackerCommand</div>
<div class="tip" id="fs86">val id : x:&#39;T -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.id</div>
<div class="tip" id="fs87">union case TrackerCommand.Close: int -&gt; TrackerCommand</div>
<div class="tip" id="fs88">union case TrackerCommand.BitcoinMessage: message: obj -&gt; TrackerCommand</div>
<div class="tip" id="fs89">union case TrackerCommand.Command: command: PeerCommand -&gt; TrackerCommand</div>
<div class="tip" id="fs90">union case TrackerCommand.SetTip: tip: obj -&gt; TrackerCommand</div>
<div class="tip" id="fs91">type BlockchainCommand =<br />&#160;&#160;| DownloadBlocks of obj * IPeerSend<br />&#160;&#160;| GetHeaders of obj * IPeerSend<br />&#160;&#160;| GetBlocks of obj * IPeerSend<br />&#160;&#160;| Catchup of IPeer * byte []<br />&#160;&#160;| Ping of obj * IPeerSend<br /><br />Full name: Peer.BlockchainCommand</div>
<div class="tip" id="fs92">union case BlockchainCommand.DownloadBlocks: obj * IPeerSend -&gt; BlockchainCommand</div>
<div class="tip" id="fs93">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs94">union case BlockchainCommand.GetHeaders: obj * IPeerSend -&gt; BlockchainCommand</div>
<div class="tip" id="fs95">union case BlockchainCommand.GetBlocks: obj * IPeerSend -&gt; BlockchainCommand</div>
<div class="tip" id="fs96">union case BlockchainCommand.Catchup: IPeer * byte [] -&gt; BlockchainCommand</div>
<div class="tip" id="fs97">union case BlockchainCommand.Ping: obj * IPeerSend -&gt; BlockchainCommand</div>
<div class="tip" id="fs98">type MempoolCommand =<br />&#160;&#160;| Revalidate of int * seq&lt;obj []&gt;<br />&#160;&#160;| Tx of obj<br />&#160;&#160;| Inv of obj * IPeer<br />&#160;&#160;| GetTx of obj * IPeerSend<br />&#160;&#160;| Mempool of IPeerSend<br /><br />Full name: Peer.MempoolCommand</div>
<div class="tip" id="fs99">union case MempoolCommand.Revalidate: int * seq&lt;obj []&gt; -&gt; MempoolCommand</div>
<div class="tip" id="fs100">Multiple items<br />val seq : sequence:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.Operators.seq<br /><br />--------------------<br />type seq&lt;&#39;T&gt; = IEnumerable&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.seq&lt;_&gt;</div>
<div class="tip" id="fs101">union case MempoolCommand.Tx: obj -&gt; MempoolCommand</div>
<div class="tip" id="fs102">union case MempoolCommand.Inv: obj * IPeer -&gt; MempoolCommand</div>
<div class="tip" id="fs103">union case MempoolCommand.GetTx: obj * IPeerSend -&gt; MempoolCommand</div>
<div class="tip" id="fs104">union case MempoolCommand.Mempool: IPeerSend -&gt; MempoolCommand</div>
<div class="tip" id="fs105">val blockchainIncoming : obj<br /><br />Full name: Peer.blockchainIncoming</div>
<div class="tip" id="fs106">val trackerIncoming : obj<br /><br />Full name: Peer.trackerIncoming</div>
<div class="tip" id="fs107">val mempoolIncoming : obj<br /><br />Full name: Peer.mempoolIncoming</div>
<div class="tip" id="fs108">type PartialMerkleTreeNode =<br />&#160;&#160;{Hash: byte [];<br />&#160;&#160;&#160;Include: bool;<br />&#160;&#160;&#160;Left: PartialMerkleTreeNode option;<br />&#160;&#160;&#160;Right: PartialMerkleTreeNode option;}<br />&#160;&#160;override ToString : unit -&gt; string<br /><br />Full name: Peer.PartialMerkleTreeNode</div>
<div class="tip" id="fs109">PartialMerkleTreeNode.Hash: byte []</div>
<div class="tip" id="fs110">PartialMerkleTreeNode.Include: bool</div>
<div class="tip" id="fs111">type bool = Boolean<br /><br />Full name: Microsoft.FSharp.Core.bool</div>
<div class="tip" id="fs112">PartialMerkleTreeNode.Left: PartialMerkleTreeNode option</div>
<div class="tip" id="fs113">type &#39;T option = Option&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.option&lt;_&gt;</div>
<div class="tip" id="fs114">PartialMerkleTreeNode.Right: PartialMerkleTreeNode option</div>
<div class="tip" id="fs115">val x : PartialMerkleTreeNode</div>
<div class="tip" id="fs116">override PartialMerkleTreeNode.ToString : unit -&gt; string<br /><br />Full name: Peer.PartialMerkleTreeNode.ToString</div>
<div class="tip" id="fs117">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs118">val scriptRuntime : obj<br /><br />Full name: Peer.scriptRuntime</div>
<div class="tip" id="fs119">val checkTxAgainstBloomFilter : bloomFilter:&#39;a -&gt; updateMode:BloomFilterUpdate -&gt; tx:PartialMerkleTreeNode -&gt; bool<br /><br />Full name: Peer.checkTxAgainstBloomFilter</div>
<div class="tip" id="fs120">val bloomFilter : &#39;a</div>
<div class="tip" id="fs121">val updateMode : BloomFilterUpdate</div>
<div class="tip" id="fs122">val tx : PartialMerkleTreeNode</div>
<div class="tip" id="fs123">val matchScript : (byte [] -&gt; bool)</div>
<div class="tip" id="fs124">val script : byte []</div>
<div class="tip" id="fs125">val data : obj []</div>
<div class="tip" id="fs126">type Array =<br />&#160;&#160;member Clone : unit -&gt; obj<br />&#160;&#160;member CopyTo : array:Array * index:int -&gt; unit + 1 overload<br />&#160;&#160;member GetEnumerator : unit -&gt; IEnumerator<br />&#160;&#160;member GetLength : dimension:int -&gt; int<br />&#160;&#160;member GetLongLength : dimension:int -&gt; int64<br />&#160;&#160;member GetLowerBound : dimension:int -&gt; int<br />&#160;&#160;member GetUpperBound : dimension:int -&gt; int<br />&#160;&#160;member GetValue : params indices:int[] -&gt; obj + 7 overloads<br />&#160;&#160;member Initialize : unit -&gt; unit<br />&#160;&#160;member IsFixedSize : bool<br />&#160;&#160;...<br /><br />Full name: System.Array</div>
<div class="tip" id="fs127">val exists : predicate:(&#39;T -&gt; bool) -&gt; array:&#39;T [] -&gt; bool<br /><br />Full name: Microsoft.FSharp.Collections.Array.exists</div>
<div class="tip" id="fs128">val d : obj</div>
<div class="tip" id="fs129">val addOutpoint : (byte [] -&gt; int -&gt; &#39;b)</div>
<div class="tip" id="fs130">val txHash : byte []</div>
<div class="tip" id="fs131">val iTxOut : int</div>
<div class="tip" id="fs132">val outpoint : obj</div>
<div class="tip" id="fs133">val matchTxHash : bool</div>
<div class="tip" id="fs134">val matchInput : bool</div>
<div class="tip" id="fs135">val txIn : obj</div>
<div class="tip" id="fs136">val matchTxInOutpoint : bool</div>
<div class="tip" id="fs137">val matchTxInScript : bool</div>
<div class="tip" id="fs138">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs139">val exists : predicate:(&#39;T -&gt; bool) -&gt; source:seq&lt;&#39;T&gt; -&gt; bool<br /><br />Full name: Microsoft.FSharp.Collections.Seq.exists</div>
<div class="tip" id="fs140">val matchOutput : bool</div>
<div class="tip" id="fs141">val mapi : mapping:(int -&gt; &#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.mapi</div>
<div class="tip" id="fs142">val txOut : obj</div>
<div class="tip" id="fs143">val matchTxOut : bool</div>
<div class="tip" id="fs144">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>
<div class="tip" id="fs145">val buildMerkleBlock : bloomFilter:&#39;a -&gt; updateMode:BloomFilterUpdate -&gt; block:&#39;b -&gt; &#39;c list * &#39;d<br /><br />Full name: Peer.buildMerkleBlock</div>
<div class="tip" id="fs146">val block : &#39;b</div>
<div class="tip" id="fs147">val txs : &#39;c option list</div>
<div class="tip" id="fs148">val merkletreeLeaves : PartialMerkleTreeNode list</div>
<div class="tip" id="fs149">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.map</div>
<div class="tip" id="fs150">val txMatch : bool</div>
<div class="tip" id="fs151">module Option<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs152">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs153">val toList : source:seq&lt;&#39;T&gt; -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.Seq.toList</div>
<div class="tip" id="fs154">Multiple items<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;new : unit -&gt; List&lt;&#39;T&gt; + 2 overloads<br />&#160;&#160;member Add : item:&#39;T -&gt; unit<br />&#160;&#160;member AddRange : collection:IEnumerable&lt;&#39;T&gt; -&gt; unit<br />&#160;&#160;member AsReadOnly : unit -&gt; ReadOnlyCollection&lt;&#39;T&gt;<br />&#160;&#160;member BinarySearch : item:&#39;T -&gt; int + 2 overloads<br />&#160;&#160;member Capacity : int with get, set<br />&#160;&#160;member Clear : unit -&gt; unit<br />&#160;&#160;member Contains : item:&#39;T -&gt; bool<br />&#160;&#160;member ConvertAll&lt;&#39;TOutput&gt; : converter:Converter&lt;&#39;T, &#39;TOutput&gt; -&gt; List&lt;&#39;TOutput&gt;<br />&#160;&#160;member CopyTo : array:&#39;T[] -&gt; unit + 2 overloads<br />&#160;&#160;...<br />&#160;&#160;nested type Enumerator<br /><br />Full name: System.Collections.Generic.List&lt;_&gt;<br /><br />--------------------<br />List() : unit<br />List(capacity: int) : unit<br />List(collection: IEnumerable&lt;&#39;T&gt;) : unit</div>
<div class="tip" id="fs155">val unzip : list:(&#39;T1 * &#39;T2) list -&gt; &#39;T1 list * &#39;T2 list<br /><br />Full name: Microsoft.FSharp.Collections.List.unzip</div>
<div class="tip" id="fs156">val makeTree : (PartialMerkleTreeNode list -&gt; PartialMerkleTreeNode)</div>
<div class="tip" id="fs157">val merkletreeNodes : PartialMerkleTreeNode list</div>
<div class="tip" id="fs158">val root : PartialMerkleTreeNode</div>
<div class="tip" id="fs159">val len : int</div>
<div class="tip" id="fs160">property List.Length: int</div>
<div class="tip" id="fs161">val nodes : PartialMerkleTreeNode list</div>
<div class="tip" id="fs162">(extension) IEnumerable.Last&lt;&#39;TSource&gt;() : &#39;TSource<br />(extension) IEnumerable.Last&lt;&#39;TSource&gt;(predicate: Func&lt;&#39;TSource,bool&gt;) : &#39;TSource</div>
<div class="tip" id="fs163">val parentNodes : PartialMerkleTreeNode list</div>
<div class="tip" id="fs164">val ofList : source:&#39;T list -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.ofList</div>
<div class="tip" id="fs165">val x : seq&lt;PartialMerkleTreeNode&gt;</div>
<div class="tip" id="fs166">val left : PartialMerkleTreeNode</div>
<div class="tip" id="fs167">val right : PartialMerkleTreeNode</div>
<div class="tip" id="fs168">val includeChildren : bool</div>
<div class="tip" id="fs169">val concat : arrays:seq&lt;&#39;T []&gt; -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.concat</div>
<div class="tip" id="fs170">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs171">val merkleTree : PartialMerkleTreeNode</div>
<div class="tip" id="fs172">val hashes : List&lt;byte []&gt;</div>
<div class="tip" id="fs173">val flags : List&lt;bool&gt;</div>
<div class="tip" id="fs174">val depthFirstTraversal : (PartialMerkleTreeNode -&gt; unit)</div>
<div class="tip" id="fs175">val node : PartialMerkleTreeNode</div>
<div class="tip" id="fs176">List.Add(item: bool) : unit</div>
<div class="tip" id="fs177">List.Add(item: byte []) : unit</div>
<div class="tip" id="fs178">val iter : action:(&#39;T -&gt; unit) -&gt; option:&#39;T option -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Option.iter</div>
<div class="tip" id="fs179">val txHashes : byte [] list</div>
<div class="tip" id="fs180">val ofSeq : source:seq&lt;&#39;T&gt; -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.ofSeq</div>
<div class="tip" id="fs181">val flags : BitArray</div>
<div class="tip" id="fs182">Multiple items<br />type BitArray =<br />&#160;&#160;new : length:int -&gt; BitArray + 5 overloads<br />&#160;&#160;member And : value:BitArray -&gt; BitArray<br />&#160;&#160;member Clone : unit -&gt; obj<br />&#160;&#160;member CopyTo : array:Array * index:int -&gt; unit<br />&#160;&#160;member Count : int<br />&#160;&#160;member Get : index:int -&gt; bool<br />&#160;&#160;member GetEnumerator : unit -&gt; IEnumerator<br />&#160;&#160;member IsReadOnly : bool<br />&#160;&#160;member IsSynchronized : bool<br />&#160;&#160;member Item : int -&gt; bool with get, set<br />&#160;&#160;...<br /><br />Full name: System.Collections.BitArray<br /><br />--------------------<br />BitArray(length: int) : unit<br />BitArray(bytes: byte []) : unit<br />BitArray(values: bool []) : unit<br />BitArray(values: int []) : unit<br />BitArray(bits: BitArray) : unit<br />BitArray(length: int, defaultValue: bool) : unit</div>
<div class="tip" id="fs183">val flagsBytes : byte []</div>
<div class="tip" id="fs184">val zeroCreate : count:int -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.zeroCreate</div>
<div class="tip" id="fs185">property BitArray.Length: int</div>
<div class="tip" id="fs186">BitArray.CopyTo(array: Array, index: int) : unit</div>
<div class="tip" id="fs187">val choose : chooser:(&#39;T -&gt; &#39;U option) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.choose</div>
<div class="tip" id="fs188">type PeerData =<br />&#160;&#160;{Queues: PeerQueues option;<br />&#160;&#160;&#160;State: PeerState;<br />&#160;&#160;&#160;Score: int;<br />&#160;&#160;&#160;CommandHandler: PeerData -&gt; PeerCommand -&gt; PeerData;}<br /><br />Full name: Peer.PeerData</div>
<div class="tip" id="fs189">PeerData.Queues: PeerQueues option</div>
<div class="tip" id="fs190">PeerData.State: PeerState</div>
<div class="tip" id="fs191">PeerData.Score: int</div>
<div class="tip" id="fs192">PeerData.CommandHandler: PeerData -&gt; PeerCommand -&gt; PeerData</div>
<div class="tip" id="fs193">Multiple items<br />type Peer =<br />&#160;&#160;interface IPeer<br />&#160;&#160;interface IDisposable<br />&#160;&#160;new : id:int -&gt; Peer<br />&#160;&#160;override ToString : unit -&gt; string<br /><br />Full name: Peer.Peer<br /><br />--------------------<br />new : id:int -&gt; Peer</div>
<div class="tip" id="fs194">val id : int</div>
<div class="tip" id="fs195">val self : Peer</div>
<div class="tip" id="fs196">val disposable : obj</div>
<div class="tip" id="fs197">val mutable target : IPEndPoint</div>
<div class="tip" id="fs198">val mutable versionMessage : Version option</div>
<div class="tip" id="fs199">Multiple items<br />type Version =<br />&#160;&#160;new : unit -&gt; Version + 4 overloads<br />&#160;&#160;member Build : int<br />&#160;&#160;member Clone : unit -&gt; obj<br />&#160;&#160;member CompareTo : version:obj -&gt; int + 1 overload<br />&#160;&#160;member Equals : obj:obj -&gt; bool + 1 overload<br />&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;member Major : int<br />&#160;&#160;member MajorRevision : int16<br />&#160;&#160;member Minor : int<br />&#160;&#160;member MinorRevision : int16<br />&#160;&#160;...<br /><br />Full name: System.Version<br /><br />--------------------<br />Version() : unit<br />Version(version: string) : unit<br />Version(major: int, minor: int) : unit<br />Version(major: int, minor: int, build: int) : unit<br />Version(major: int, minor: int, build: int, revision: int) : unit</div>
<div class="tip" id="fs200">val mutable bloomFilterUpdateMode : BloomFilterUpdate</div>
<div class="tip" id="fs201">val mutable bloomFilter : obj option</div>
<div class="tip" id="fs202">val mutable relay : byte</div>
<div class="tip" id="fs203">val incoming : Event&lt;PeerCommand&gt;</div>
<div class="tip" id="fs204">val headersIncoming : obj</div>
<div class="tip" id="fs205">val blockIncoming : obj</div>
<div class="tip" id="fs206">val incomingEvent : IEvent&lt;PeerCommand&gt;</div>
<div class="tip" id="fs207">property Event.Publish: IEvent&lt;PeerCommand&gt;</div>
<div class="tip" id="fs208">val workLoop : (NetworkStream -&gt; &#39;a)</div>
<div class="tip" id="fs209">val buffer : byte []</div>
<div class="tip" id="fs210">val tf : TaskFactory</div>
<div class="tip" id="fs211">Multiple items<br />type TaskFactory =<br />&#160;&#160;new : unit -&gt; TaskFactory + 4 overloads<br />&#160;&#160;member CancellationToken : CancellationToken<br />&#160;&#160;member ContinuationOptions : TaskContinuationOptions<br />&#160;&#160;member ContinueWhenAll : tasks:Task[] * continuationAction:Action&lt;Task[]&gt; -&gt; Task + 15 overloads<br />&#160;&#160;member ContinueWhenAny : tasks:Task[] * continuationAction:Action&lt;Task&gt; -&gt; Task + 15 overloads<br />&#160;&#160;member CreationOptions : TaskCreationOptions<br />&#160;&#160;member FromAsync : asyncResult:IAsyncResult * endMethod:Action&lt;IAsyncResult&gt; -&gt; Task + 21 overloads<br />&#160;&#160;member Scheduler : TaskScheduler<br />&#160;&#160;member StartNew : action:Action -&gt; Task + 15 overloads<br /><br />Full name: System.Threading.Tasks.TaskFactory<br /><br />--------------------<br />type TaskFactory&lt;&#39;TResult&gt; =<br />&#160;&#160;new : unit -&gt; TaskFactory&lt;&#39;TResult&gt; + 4 overloads<br />&#160;&#160;member CancellationToken : CancellationToken<br />&#160;&#160;member ContinuationOptions : TaskContinuationOptions<br />&#160;&#160;member ContinueWhenAll : tasks:Task[] * continuationFunction:Func&lt;Task[], &#39;TResult&gt; -&gt; Task&lt;&#39;TResult&gt; + 7 overloads<br />&#160;&#160;member ContinueWhenAny : tasks:Task[] * continuationFunction:Func&lt;Task, &#39;TResult&gt; -&gt; Task&lt;&#39;TResult&gt; + 7 overloads<br />&#160;&#160;member CreationOptions : TaskCreationOptions<br />&#160;&#160;member FromAsync : asyncResult:IAsyncResult * endMethod:Func&lt;IAsyncResult, &#39;TResult&gt; -&gt; Task&lt;&#39;TResult&gt; + 10 overloads<br />&#160;&#160;member Scheduler : TaskScheduler<br />&#160;&#160;member StartNew : function:Func&lt;&#39;TResult&gt; -&gt; Task&lt;&#39;TResult&gt; + 7 overloads<br /><br />Full name: System.Threading.Tasks.TaskFactory&lt;_&gt;<br /><br />--------------------<br />TaskFactory() : unit<br />TaskFactory(cancellationToken: CancellationToken) : unit<br />TaskFactory(scheduler: TaskScheduler) : unit<br />TaskFactory(creationOptions: TaskCreationOptions, continuationOptions: TaskContinuationOptions) : unit<br />TaskFactory(cancellationToken: CancellationToken, creationOptions: TaskCreationOptions, continuationOptions: TaskContinuationOptions, scheduler: TaskScheduler) : unit<br /><br />--------------------<br />TaskFactory() : unit<br />TaskFactory(cancellationToken: CancellationToken) : unit<br />TaskFactory(scheduler: TaskScheduler) : unit<br />TaskFactory(creationOptions: TaskCreationOptions, continuationOptions: TaskContinuationOptions) : unit<br />TaskFactory(cancellationToken: CancellationToken, creationOptions: TaskCreationOptions, continuationOptions: TaskContinuationOptions, scheduler: TaskScheduler) : unit</div>
<div class="tip" id="fs212">val task : (unit -&gt; &#39;b)</div>
<div class="tip" id="fs213">val t : Task&lt;byte []&gt;</div>
<div class="tip" id="fs214">TaskFactory.FromAsync&lt;&#39;TResult&gt;(asyncResult: IAsyncResult, endMethod: Func&lt;IAsyncResult,&#39;TResult&gt;) : Task&lt;&#39;TResult&gt;<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync(asyncResult: IAsyncResult, endMethod: Action&lt;IAsyncResult&gt;) : Task<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync&lt;&#39;TResult&gt;(beginMethod: Func&lt;AsyncCallback,obj,IAsyncResult&gt;, endMethod: Func&lt;IAsyncResult,&#39;TResult&gt;, state: obj) : Task&lt;&#39;TResult&gt;<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync&lt;&#39;TResult&gt;(asyncResult: IAsyncResult, endMethod: Func&lt;IAsyncResult,&#39;TResult&gt;, creationOptions: TaskCreationOptions) : Task&lt;&#39;TResult&gt;<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync(beginMethod: Func&lt;AsyncCallback,obj,IAsyncResult&gt;, endMethod: Action&lt;IAsyncResult&gt;, state: obj) : Task<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync(asyncResult: IAsyncResult, endMethod: Action&lt;IAsyncResult&gt;, creationOptions: TaskCreationOptions) : Task<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync&lt;&#39;TArg1,&#39;TResult&gt;(beginMethod: Func&lt;&#39;TArg1,AsyncCallback,obj,IAsyncResult&gt;, endMethod: Func&lt;IAsyncResult,&#39;TResult&gt;, arg1: &#39;TArg1, state: obj) : Task&lt;&#39;TResult&gt;<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync&lt;&#39;TResult&gt;(beginMethod: Func&lt;AsyncCallback,obj,IAsyncResult&gt;, endMethod: Func&lt;IAsyncResult,&#39;TResult&gt;, state: obj, creationOptions: TaskCreationOptions) : Task&lt;&#39;TResult&gt;<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync&lt;&#39;TResult&gt;(asyncResult: IAsyncResult, endMethod: Func&lt;IAsyncResult,&#39;TResult&gt;, creationOptions: TaskCreationOptions, scheduler: TaskScheduler) : Task&lt;&#39;TResult&gt;<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />TaskFactory.FromAsync&lt;&#39;TArg1&gt;(beginMethod: Func&lt;&#39;TArg1,AsyncCallback,obj,IAsyncResult&gt;, endMethod: Action&lt;IAsyncResult&gt;, arg1: &#39;TArg1, state: obj) : Task<br />&#160;&#160;&#160;<em>(+0 other overloads)</em></div>
<div class="tip" id="fs215">val cb : AsyncCallback</div>
<div class="tip" id="fs216">val state : obj</div>
<div class="tip" id="fs217">type obj = Object<br /><br />Full name: Microsoft.FSharp.Core.obj</div>
<div class="tip" id="fs218">NetworkStream.BeginRead(buffer: byte [], offset: int, size: int, callback: AsyncCallback, state: obj) : IAsyncResult</div>
<div class="tip" id="fs219">property Array.Length: int</div>
<div class="tip" id="fs220">val res : IAsyncResult</div>
<div class="tip" id="fs221">val c : int</div>
<div class="tip" id="fs222">NetworkStream.EndRead(asyncResult: IAsyncResult) : int</div>
<div class="tip" id="fs223">val raise : exn:Exception -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.raise</div>
<div class="tip" id="fs224">Multiple items<br />type SocketException =<br />&#160;&#160;inherit Win32Exception<br />&#160;&#160;new : unit -&gt; SocketException + 1 overload<br />&#160;&#160;member ErrorCode : int<br />&#160;&#160;member Message : string<br />&#160;&#160;member SocketErrorCode : SocketError<br /><br />Full name: System.Net.Sockets.SocketException<br /><br />--------------------<br />SocketException() : unit<br />SocketException(errorCode: int) : unit</div>
<div class="tip" id="fs225">val readyPeer : (unit -&gt; unit)</div>
<div class="tip" id="fs226">member Event.Trigger : arg:&#39;T -&gt; unit</div>
<div class="tip" id="fs227">val closePeer : (unit -&gt; unit)</div>
<div class="tip" id="fs228">val badPeer : (unit -&gt; unit)</div>
<div class="tip" id="fs229">val sendMessageObs : (PeerQueues -&gt; &#39;a -&gt; &#39;b)</div>
<div class="tip" id="fs230">val peerQueues : PeerQueues</div>
<div class="tip" id="fs231">val sendMessage : (NetworkStream -&gt; &#39;a -&gt; unit)</div>
<div class="tip" id="fs232">val messageBytes : byte []</div>
<div class="tip" id="fs233">NetworkStream.Write(buffer: byte [], offset: int, size: int) : unit</div>
<div class="tip" id="fs234">val e : exn</div>
<div class="tip" id="fs235">val filterMessage : (&#39;a -&gt; &#39;a list)</div>
<div class="tip" id="fs236">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; option:&#39;T option -&gt; &#39;U option<br /><br />Full name: Microsoft.FSharp.Core.Option.map</div>
<div class="tip" id="fs237">val bf : obj</div>
<div class="tip" id="fs238">val block : obj</div>
<div class="tip" id="fs239">val txs : obj list</div>
<div class="tip" id="fs240">val merkleBlock : obj</div>
<div class="tip" id="fs241">val txMessages : obj list</div>
<div class="tip" id="fs242">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="fs243">val tx : obj</div>
<div class="tip" id="fs244">val iter : action:(&#39;T -&gt; unit) -&gt; source:seq&lt;&#39;T&gt; -&gt; unit<br /><br />Full name: Microsoft.FSharp.Collections.Seq.iter</div>
<div class="tip" id="fs245">val processMessage : (PeerQueues -&gt; &#39;a -&gt; unit)</div>
<div class="tip" id="fs246">val command : string</div>
<div class="tip" id="fs247">val now : obj</div>
<div class="tip" id="fs248">Multiple items<br />type DateTime =<br />&#160;&#160;struct<br />&#160;&#160;&#160;&#160;new : ticks:int64 -&gt; DateTime + 10 overloads<br />&#160;&#160;&#160;&#160;member Add : value:TimeSpan -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddDays : value:float -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddHours : value:float -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddMilliseconds : value:float -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddMinutes : value:float -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddMonths : months:int -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddSeconds : value:float -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddTicks : value:int64 -&gt; DateTime<br />&#160;&#160;&#160;&#160;member AddYears : value:int -&gt; DateTime<br />&#160;&#160;&#160;&#160;...<br />&#160;&#160;end<br /><br />Full name: System.DateTime<br /><br />--------------------<br />DateTime()<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(ticks: int64) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(ticks: int64, kind: DateTimeKind) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int, calendar: Globalization.Calendar) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int, hour: int, minute: int, second: int) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int, hour: int, minute: int, second: int, kind: DateTimeKind) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int, hour: int, minute: int, second: int, calendar: Globalization.Calendar) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int, hour: int, minute: int, second: int, millisecond: int) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em><br />DateTime(year: int, month: int, day: int, hour: int, minute: int, second: int, millisecond: int, kind: DateTimeKind) : unit<br />&#160;&#160;&#160;<em>(+0 other overloads)</em></div>
<div class="tip" id="fs249">property DateTime.UtcNow: DateTime</div>
<div class="tip" id="fs250">val addr : obj</div>
<div class="tip" id="fs251">Multiple items<br />val int32 : value:&#39;T -&gt; int32 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int32<br /><br />--------------------<br />type int32 = Int32<br /><br />Full name: Microsoft.FSharp.Core.int32</div>
<div class="tip" id="fs252">val gd : obj</div>
<div class="tip" id="fs253">val filter : predicate:(&#39;T -&gt; bool) -&gt; list:&#39;T list -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.filter</div>
<div class="tip" id="fs254">type Type =<br />&#160;&#160;inherit MemberInfo<br />&#160;&#160;member Assembly : Assembly<br />&#160;&#160;member AssemblyQualifiedName : string<br />&#160;&#160;member Attributes : TypeAttributes<br />&#160;&#160;member BaseType : Type<br />&#160;&#160;member ContainsGenericParameters : bool<br />&#160;&#160;member DeclaringMethod : MethodBase<br />&#160;&#160;member DeclaringType : Type<br />&#160;&#160;member Equals : o:obj -&gt; bool + 1 overload<br />&#160;&#160;member FindInterfaces : filter:TypeFilter * filterCriteria:obj -&gt; Type[]<br />&#160;&#160;member FindMembers : memberType:MemberTypes * bindingAttr:BindingFlags * filter:MemberFilter * filterCriteria:obj -&gt; MemberInfo[]<br />&#160;&#160;...<br /><br />Full name: System.Type</div>
<div class="tip" id="fs255">val gh : obj</div>
<div class="tip" id="fs256">val gb : obj</div>
<div class="tip" id="fs257">val headers : obj</div>
<div class="tip" id="fs258">val inv : obj</div>
<div class="tip" id="fs259">val ping : obj</div>
<div class="tip" id="fs260">val mempool : obj</div>
<div class="tip" id="fs261">val filterAdd : obj</div>
<div class="tip" id="fs262">val bloomFilter : obj</div>
<div class="tip" id="fs263">Multiple items<br />namespace System.Data<br /><br />--------------------<br />namespace Microsoft.FSharp.Data</div>
<div class="tip" id="fs264">val filterLoad : obj</div>
<div class="tip" id="fs265">val processConnection : (PeerData -&gt; PeerCommand -&gt; PeerData)</div>
<div class="tip" id="fs266">val data : PeerData</div>
<div class="tip" id="fs267">val command : PeerCommand</div>
<div class="tip" id="fs268">val t : IPEndPoint</div>
<div class="tip" id="fs269">val tip : obj</div>
<div class="tip" id="fs270">IPEndPoint.ToString() : string</div>
<div class="tip" id="fs271">val connect : Async&lt;PeerCommand&gt;</div>
<div class="tip" id="fs272">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs273">val client : TcpClient</div>
<div class="tip" id="fs274">Multiple items<br />type TcpClient =<br />&#160;&#160;new : unit -&gt; TcpClient + 3 overloads<br />&#160;&#160;member Available : int<br />&#160;&#160;member BeginConnect : host:string * port:int * requestCallback:AsyncCallback * state:obj -&gt; IAsyncResult + 2 overloads<br />&#160;&#160;member Client : Socket with get, set<br />&#160;&#160;member Close : unit -&gt; unit<br />&#160;&#160;member Connect : remoteEP:IPEndPoint -&gt; unit + 3 overloads<br />&#160;&#160;member Connected : bool<br />&#160;&#160;member EndConnect : asyncResult:IAsyncResult -&gt; unit<br />&#160;&#160;member ExclusiveAddressUse : bool with get, set<br />&#160;&#160;member GetStream : unit -&gt; NetworkStream<br />&#160;&#160;...<br /><br />Full name: System.Net.Sockets.TcpClient<br /><br />--------------------<br />TcpClient() : unit<br />TcpClient(localEP: IPEndPoint) : unit<br />TcpClient(family: AddressFamily) : unit<br />TcpClient(hostname: string, port: int) : unit</div>
<div class="tip" id="fs275">Multiple items<br />type Async<br />static member AsBeginEnd : computation:(&#39;Arg -&gt; Async&lt;&#39;T&gt;) -&gt; (&#39;Arg * AsyncCallback * obj -&gt; IAsyncResult) * (IAsyncResult -&gt; &#39;T) * (IAsyncResult -&gt; unit)<br />static member AwaitEvent : event:IEvent&lt;&#39;Del,&#39;T&gt; * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt; (requires delegate and &#39;Del :&gt; Delegate)<br />static member AwaitIAsyncResult : iar:IAsyncResult * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member AwaitTask : task:Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;<br />static member AwaitWaitHandle : waitHandle:WaitHandle * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member CancelDefaultToken : unit -&gt; unit<br />static member Catch : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;Choice&lt;&#39;T,exn&gt;&gt;<br />static member FromBeginEnd : beginAction:(AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg:&#39;Arg1 * beginAction:(&#39;Arg1 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * beginAction:(&#39;Arg1 * &#39;Arg2 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * arg3:&#39;Arg3 * beginAction:(&#39;Arg1 * &#39;Arg2 * &#39;Arg3 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromContinuations : callback:((&#39;T -&gt; unit) * (exn -&gt; unit) * (OperationCanceledException -&gt; unit) -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Ignore : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;unit&gt;<br />static member OnCancel : interruption:(unit -&gt; unit) -&gt; Async&lt;IDisposable&gt;<br />static member Parallel : computations:seq&lt;Async&lt;&#39;T&gt;&gt; -&gt; Async&lt;&#39;T []&gt;<br />static member RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:CancellationToken -&gt; &#39;T<br />static member Sleep : millisecondsDueTime:int -&gt; Async&lt;unit&gt;<br />static member Start : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions * ?cancellationToken:CancellationToken -&gt; Task&lt;&#39;T&gt;<br />static member StartChild : computation:Async&lt;&#39;T&gt; * ?millisecondsTimeout:int -&gt; Async&lt;Async&lt;&#39;T&gt;&gt;<br />static member StartChildAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions -&gt; Async&lt;Task&lt;&#39;T&gt;&gt;<br />static member StartImmediate : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartWithContinuations : computation:Async&lt;&#39;T&gt; * continuation:(&#39;T -&gt; unit) * exceptionContinuation:(exn -&gt; unit) * cancellationContinuation:(OperationCanceledException -&gt; unit) * ?cancellationToken:CancellationToken -&gt; unit<br />static member SwitchToContext : syncContext:SynchronizationContext -&gt; Async&lt;unit&gt;<br />static member SwitchToNewThread : unit -&gt; Async&lt;unit&gt;<br />static member SwitchToThreadPool : unit -&gt; Async&lt;unit&gt;<br />static member TryCancelled : computation:Async&lt;&#39;T&gt; * compensation:(OperationCanceledException -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member CancellationToken : Async&lt;CancellationToken&gt;<br />static member DefaultCancellationToken : CancellationToken<br /><br />Full name: Microsoft.FSharp.Control.Async<br /><br />--------------------<br />type Async&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Async&lt;_&gt;</div>
<div class="tip" id="fs276">static member Async.FromBeginEnd : beginAction:(AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Async.FromBeginEnd : arg:&#39;Arg1 * beginAction:(&#39;Arg1 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Async.FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * beginAction:(&#39;Arg1 * &#39;Arg2 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Async.FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * arg3:&#39;Arg3 * beginAction:(&#39;Arg1 * &#39;Arg2 * &#39;Arg3 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;</div>
<div class="tip" id="fs277">TcpClient.BeginConnect(addresses: IPAddress [], port: int, requestCallback: AsyncCallback, state: obj) : IAsyncResult<br />TcpClient.BeginConnect(address: IPAddress, port: int, requestCallback: AsyncCallback, state: obj) : IAsyncResult<br />TcpClient.BeginConnect(host: string, port: int, requestCallback: AsyncCallback, state: obj) : IAsyncResult</div>
<div class="tip" id="fs278">property IPEndPoint.Address: IPAddress</div>
<div class="tip" id="fs279">property IPEndPoint.Port: int</div>
<div class="tip" id="fs280">TcpClient.EndConnect(asyncResult: IAsyncResult) : unit</div>
<div class="tip" id="fs281">TcpClient.GetStream() : NetworkStream</div>
<div class="tip" id="fs282">type Timeout =<br />&#160;&#160;static val Infinite : int<br /><br />Full name: System.Threading.Timeout</div>
<div class="tip" id="fs283">property NetworkStream.WriteTimeout: int</div>
<div class="tip" id="fs284">Multiple items<br />type TimeSpan =<br />&#160;&#160;struct<br />&#160;&#160;&#160;&#160;new : ticks:int64 -&gt; TimeSpan + 3 overloads<br />&#160;&#160;&#160;&#160;member Add : ts:TimeSpan -&gt; TimeSpan<br />&#160;&#160;&#160;&#160;member CompareTo : value:obj -&gt; int + 1 overload<br />&#160;&#160;&#160;&#160;member Days : int<br />&#160;&#160;&#160;&#160;member Duration : unit -&gt; TimeSpan<br />&#160;&#160;&#160;&#160;member Equals : value:obj -&gt; bool + 1 overload<br />&#160;&#160;&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;&#160;&#160;member Hours : int<br />&#160;&#160;&#160;&#160;member Milliseconds : int<br />&#160;&#160;&#160;&#160;member Minutes : int<br />&#160;&#160;&#160;&#160;...<br />&#160;&#160;end<br /><br />Full name: System.TimeSpan<br /><br />--------------------<br />TimeSpan()<br />TimeSpan(ticks: int64) : unit<br />TimeSpan(hours: int, minutes: int, seconds: int) : unit<br />TimeSpan(days: int, hours: int, minutes: int, seconds: int) : unit<br />TimeSpan(days: int, hours: int, minutes: int, seconds: int, milliseconds: int) : unit</div>
<div class="tip" id="fs285">field TimeSpan.TicksPerMillisecond = 10000L</div>
<div class="tip" id="fs286">val parser : obj</div>
<div class="tip" id="fs287"></div>
<div class="tip" id="fs288">val toSeq : list:&#39;T list -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.List.toSeq</div>
<div class="tip" id="fs289">val version : obj</div>
<div class="tip" id="fs290">type EndPoint =<br />&#160;&#160;member AddressFamily : AddressFamily<br />&#160;&#160;member Create : socketAddress:SocketAddress -&gt; EndPoint<br />&#160;&#160;member Serialize : unit -&gt; SocketAddress<br /><br />Full name: System.Net.EndPoint</div>
<div class="tip" id="fs291">Multiple items<br />val int64 : value:&#39;T -&gt; int64 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int64<br /><br />--------------------<br />type int64 = Int64<br /><br />Full name: Microsoft.FSharp.Core.int64<br /><br />--------------------<br />type int64&lt;&#39;Measure&gt; = int64<br /><br />Full name: Microsoft.FSharp.Core.int64&lt;_&gt;</div>
<div class="tip" id="fs292">val handshakeObs : obj</div>
<div class="tip" id="fs293">val empty&lt;&#39;T&gt; : &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.empty</div>
<div class="tip" id="fs294">val processCommand : (PeerData -&gt; PeerCommand -&gt; PeerData)</div>
<div class="tip" id="fs295">val processClosing : (PeerData -&gt; PeerCommand -&gt; PeerData)</div>
<div class="tip" id="fs296">property Option.Value: PeerQueues</div>
<div class="tip" id="fs297">val message : obj</div>
<div class="tip" id="fs298">val ts : obj</div>
<div class="tip" id="fs299">val sendObs : obj</div>
<div class="tip" id="fs300">val obs : obj</div>
<div class="tip" id="fs301">val ts : TaskCompletionSource&lt;IPeer * IObservable&lt;obj * byte []&gt;&gt;</div>
<div class="tip" id="fs302">val blocksPending : HashSet&lt;byte []&gt;</div>
<div class="tip" id="fs303">Multiple items<br />type HashSet&lt;&#39;T&gt; =<br />&#160;&#160;new : unit -&gt; HashSet&lt;&#39;T&gt; + 3 overloads<br />&#160;&#160;member Add : item:&#39;T -&gt; bool<br />&#160;&#160;member Clear : unit -&gt; unit<br />&#160;&#160;member Comparer : IEqualityComparer&lt;&#39;T&gt;<br />&#160;&#160;member Contains : item:&#39;T -&gt; bool<br />&#160;&#160;member CopyTo : array:&#39;T[] -&gt; unit + 2 overloads<br />&#160;&#160;member Count : int<br />&#160;&#160;member ExceptWith : other:IEnumerable&lt;&#39;T&gt; -&gt; unit<br />&#160;&#160;member GetEnumerator : unit -&gt; Enumerator&lt;&#39;T&gt;<br />&#160;&#160;member GetObjectData : info:SerializationInfo * context:StreamingContext -&gt; unit<br />&#160;&#160;...<br />&#160;&#160;nested type Enumerator<br /><br />Full name: System.Collections.Generic.HashSet&lt;_&gt;<br /><br />--------------------<br />HashSet() : unit<br />HashSet(comparer: IEqualityComparer&lt;&#39;T&gt;) : unit<br />HashSet(collection: IEnumerable&lt;&#39;T&gt;) : unit<br />HashSet(collection: IEnumerable&lt;&#39;T&gt;, comparer: IEqualityComparer&lt;&#39;T&gt;) : unit</div>
<div class="tip" id="fs304">val inv : PartialMerkleTreeNode</div>
<div class="tip" id="fs305">val count : int</div>
<div class="tip" id="fs306">Multiple items<br />property HashSet.Count: int<br /><br />--------------------<br />(extension) IEnumerable.Count&lt;&#39;TSource&gt;() : int<br />(extension) IEnumerable.Count&lt;&#39;TSource&gt;(predicate: Func&lt;&#39;TSource,bool&gt;) : int</div>
<div class="tip" id="fs307">val obs : IObservable&lt;obj * byte []&gt;</div>
<div class="tip" id="fs308">(extension) IEnumerable.Contains&lt;&#39;TSource&gt;(value: &#39;TSource) : bool<br />HashSet.Contains(item: byte []) : bool<br />(extension) IEnumerable.Contains&lt;&#39;TSource&gt;(value: &#39;TSource, comparer: IEqualityComparer&lt;&#39;TSource&gt;) : bool</div>
<div class="tip" id="fs309">TaskCompletionSource.SetResult(result: IPeer * IObservable&lt;obj * byte []&gt;) : unit</div>
<div class="tip" id="fs310">val score : int</div>
<div class="tip" id="fs311">val newData : PeerData</div>
<div class="tip" id="fs312">val initialState : PeerData</div>
<div class="tip" id="fs313">val runHandler : (PeerData -&gt; PeerCommand -&gt; PeerData)</div>
<div class="tip" id="fs314">Multiple items<br />type Func&lt;&#39;TResult&gt; =<br />&#160;&#160;delegate of unit -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;T11,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 * &#39;T11 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;T11,&#39;T12,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 * &#39;T11 * &#39;T12 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;T11,&#39;T12,&#39;T13,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 * &#39;T11 * &#39;T12 * &#39;T13 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;T11,&#39;T12,&#39;T13,&#39;T14,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 * &#39;T11 * &#39;T12 * &#39;T13 * &#39;T14 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;T11,&#39;T12,&#39;T13,&#39;T14,&#39;T15,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 * &#39;T11 * &#39;T12 * &#39;T13 * &#39;T14 * &#39;T15 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_&gt;<br /><br />--------------------<br />type Func&lt;&#39;T1,&#39;T2,&#39;T3,&#39;T4,&#39;T5,&#39;T6,&#39;T7,&#39;T8,&#39;T9,&#39;T10,&#39;T11,&#39;T12,&#39;T13,&#39;T14,&#39;T15,&#39;T16,&#39;TResult&gt; =<br />&#160;&#160;delegate of &#39;T1 * &#39;T2 * &#39;T3 * &#39;T4 * &#39;T5 * &#39;T6 * &#39;T7 * &#39;T8 * &#39;T9 * &#39;T10 * &#39;T11 * &#39;T12 * &#39;T13 * &#39;T14 * &#39;T15 * &#39;T16 -&gt; &#39;TResult<br /><br />Full name: System.Func&lt;_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_&gt;</div>
<div class="tip" id="fs315">val x : Peer</div>
<div class="tip" id="fs316">override Peer.Dispose : unit -&gt; unit<br /><br />Full name: Peer.Peer.Dispose</div>
<div class="tip" id="fs317">override Peer.Ready : unit -&gt; unit<br /><br />Full name: Peer.Peer.Ready</div>
<div class="tip" id="fs318">override Peer.Target : IPEndPoint<br /><br />Full name: Peer.Peer.Target</div>
<div class="tip" id="fs319">override Peer.Bad : unit -&gt; unit<br /><br />Full name: Peer.Peer.Bad</div>
<div class="tip" id="fs320">override Peer.Receive : m:PeerCommand -&gt; unit<br /><br />Full name: Peer.Peer.Receive</div>
<div class="tip" id="fs321">val m : PeerCommand</div>
<div class="tip" id="fs322">override Peer.ToString : unit -&gt; string<br /><br />Full name: Peer.Peer.ToString</div>
<div class="tip" id="fs323">val dropOldPeers : unit -&gt; &#39;a<br /><br />Full name: Peer.dropOldPeers</div>
<div class="tip" id="fs324">val dts : DateTime</div>
<div class="tip" id="fs325">DateTime.AddHours(value: float) : DateTime</div>
<div class="tip" id="fs326">val bootstrapPeers : unit -&gt; unit<br /><br />Full name: Peer.bootstrapPeers</div>
<div class="tip" id="fs327">val port : int</div>
<div class="tip" id="fs328">val entry : obj</div>
<div class="tip" id="fs329">static member Async.AwaitTask : task:Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;</div>
<div class="tip" id="fs330">type Dns =<br />&#160;&#160;static member BeginGetHostAddresses : hostNameOrAddress:string * requestCallback:AsyncCallback * state:obj -&gt; IAsyncResult<br />&#160;&#160;static member BeginGetHostByName : hostName:string * requestCallback:AsyncCallback * stateObject:obj -&gt; IAsyncResult<br />&#160;&#160;static member BeginGetHostEntry : hostNameOrAddress:string * requestCallback:AsyncCallback * stateObject:obj -&gt; IAsyncResult + 1 overload<br />&#160;&#160;static member BeginResolve : hostName:string * requestCallback:AsyncCallback * stateObject:obj -&gt; IAsyncResult<br />&#160;&#160;static member EndGetHostAddresses : asyncResult:IAsyncResult -&gt; IPAddress[]<br />&#160;&#160;static member EndGetHostByName : asyncResult:IAsyncResult -&gt; IPHostEntry<br />&#160;&#160;static member EndGetHostEntry : asyncResult:IAsyncResult -&gt; IPHostEntry<br />&#160;&#160;static member EndResolve : asyncResult:IAsyncResult -&gt; IPHostEntry<br />&#160;&#160;static member GetHostAddresses : hostNameOrAddress:string -&gt; IPAddress[]<br />&#160;&#160;static member GetHostByAddress : address:string -&gt; IPHostEntry + 1 overload<br />&#160;&#160;...<br /><br />Full name: System.Net.Dns</div>
<div class="tip" id="fs331">val peer : obj</div>
<div class="tip" id="fs332">static member Async.StartImmediate : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit</div>
<div class="tip" id="fs333">val initPeers : unit -&gt; unit<br /><br />Full name: Peer.initPeers</div>
<div class="tip" id="fs334">val peers : obj</div>
          
        </div>
        <div class="span1"></div>
      </div>
    </div>
  </body>
</html>
